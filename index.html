<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager Pro - User Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <!-- Frappe Gantt CSS -->
    <link href='https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css' rel='stylesheet' />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styles for the dashboard */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            background-color: #f8f9fa;
        }
        .sidebar {
            width: 250px;
            background-color: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #374151;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            height: 100vh;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: .5rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: .5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            padding: .75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-pills {
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .nav-btn {
            background: none;
            border: none;
            color: #d1d5db;
            text-align: left;
            padding: 1rem;
            width: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active, .nav-btn:hover {
            background-color: #374151;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto; /* Allow scrolling for modal content */
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Fix for button and tag text visibility */
        .btn-success {
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px; /* Add some space between buttons */
            transition: background-color 0.2s ease-in-out;
        }
        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545; /* Red */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        .priority-tag {
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-low {
            background-color: #17a2b8; /* Teal */
        }

        .priority-medium {
            background-color: #ffc107; /* Yellow */
            color: #212529; /* Dark text for yellow bg */
        }

        .priority-high {
            background-color: #dc3545; /* Red */
        }

        /* Custom Alert Modal styles */
        .custom-alert-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .custom-alert-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }

        .custom-alert-content h3 {
            margin-top: 0;
            color: #333;
        }

        .custom-alert-content p {
            margin-bottom: 20px;
            color: #555;
        }

        .custom-alert-content button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .custom-alert-content button:hover {
            background-color: #45a049;
        }

        /* My Tasks Overview Section specific styles */
        
    .tasks-list-grid {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 1rem 0;
}


.task-card {
    min-width: 300px;
    flex: 0 0 auto;
    scroll-snap-align: start;
}


        .task-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Stronger shadow */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative; /* For lock icon positioning */
            overflow: hidden; /* Ensure rounded corners clip children */
            border: 1px solid #e2e8f0; /* Subtle border */
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12); /* Even stronger shadow on hover */
        }

        .task-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.25rem; /* Larger title */
        }

        .task-card p {
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .task-actions button {
            padding: 0.6rem 1rem; /* Adjust button padding */
            font-size: 0.9rem;
        }

        .priority-tag {
            /* Keep existing priority styles */
            padding: 6px 10px; /* Slightly larger padding */
            font-size: 0.9em;
        }
        
        .task-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .task-filter-btn {
            background-color: #e2e8f0;
            color: #475569;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .task-filter-btn.active, .task-filter-btn:hover {
            background-color: #4f46e5;
            color: white;
        }

        /* Dashboard specific styles */
        .dashboard-header-welcome {
            background: linear-gradient(to right, #4f46e5, #6366f1);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .dashboard-header-welcome h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .dashboard-header-welcome p {
            font-size: 1.125rem;
            opacity: 0.9;
        }
        .stat-card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            transition: transform 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4f46e5;
            margin-top: 0.5rem;
        }
        .stat-card .label {
            font-size: 1rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .stat-card i {
            font-size: 1.8rem;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 99;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                padding-top: 70px; /* Space for fixed sidebar/header */
            }
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                background-color: #4f46e5;
                color: white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
        }
        .mobile-menu-btn {
            display: none; /* Hidden by default for desktop */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* New CSS for Flags */
        .flag {
            font-size: 1.2em; /* Slightly larger for visibility */
            margin-left: 8px; /* Space from other elements */
        }
        .flag-red {
            color: #ef4444; /* Tailwind red-500 */
        }
        .flag-green {
            color: #10b981; /* Tailwind emerald-500 */
        }

        /* NEW DASHBOARD STYLES */
        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            padding: 1.5rem;
            transition: all 0.2s ease;
        }
        
        .dashboard-widget:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.12);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .widget-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .widget-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .widget-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .widget-action-btn:hover {
            color: #4f46e5;
        }
        
        .task-progress {
            margin-top: 1rem;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4f46e5;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .recent-tasks-list {
            margin-top: 1rem;
        }
        
        .recent-task-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .recent-task-item:last-child {
            border-bottom: none;
        }
        
        .recent-task-checkbox {
            margin-right: 0.75rem;
            cursor: pointer;
        }
        
        .recent-task-content {
            flex-grow: 1;
        }
        
        .recent-task-title {
            font-weight: 500;
            color: #374151;
        }
        
        .recent-task-due {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .recent-task-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .empty-dashboard-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .empty-dashboard-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background-color: #f3f4f6;
            transform: translateY(-2px);
        }
        
        .quick-action-icon {
            font-size: 1.5rem;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }
        
        .quick-action-label {
            font-size: 0.875rem;
            color: #374151;
        }
        
        /* Drag and drop styles */
        .draggable-task {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .draggable-task.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }
        
        .dropzone.active {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .dropzone-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* Achievement badges */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: #374151;
        }
        
        .achievement-badge i {
            margin-right: 0.25rem;
            color: #f59e0b;
        }
        
        /* Sparkline chart container */
        .sparkline-container {
            height: 60px;
            margin-top: 1rem;
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 0.5rem;
        }
        
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        input:checked + .theme-slider {
            background-color: #4f46e5;
        }
        
        input:checked + .theme-slider:before {
            transform: translateX(26px);
        }
        
        /* Gantt Chart Styles */
        .gantt-chart-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-top: 1.5rem;
            height: 600px; /* Fixed height for Gantt chart, with overflow */
            overflow: auto;
        }
        
        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Space between elements */
        }
        
        .gantt-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .gantt-control-btn {
            background-color: #e2e8f0;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gantt-control-btn:hover {
            background-color: #4f46e5;
            color: white;
        }
        
        .gantt-view-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .gantt-view-btn {
            background-color: #f3f4f6;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .gantt-view-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        
        .gantt-view-btn:hover:not(.active) {
            background-color: #e2e8f0;
        }
        
        .gantt-filter-container {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .gantt-filter {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .gantt-filter label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .gantt-filter select, .gantt-filter input[type="text"] { /* Added input for search */
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background-color: white;
        }

        /* Styles for Gantt Popup notes */
        .gantt-popup-notes {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .gantt-popup-notes h6 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .gantt-popup-notes ul {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
        }

        /* MODIFICATION: Added flex styles to note items */
        .gantt-popup-notes li {
            background-color: #fffbe6; /* Light yellow for sticky notes */
            border: 1px solid #fde68a;
            padding: 0.5rem;
            margin-bottom: 0.4rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #78350f;
            word-wrap: break-word;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gantt-popup-add-note {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .gantt-popup-add-note input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        .gantt-popup-add-note button {
            padding: 0.5rem 1rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        /* New CSS for Gantt Chart Task Bar Colors */
        .gantt-completed .bar {
            fill: #10b981 !important; /* Green for completed */
        }
        .gantt-pending .bar {
            fill: #f59e0b !important; /* Yellow for pending */
        }
        .gantt-active .bar {
            fill: #6b7280 !important; /* Gray for active/in-progress */
        }
        .gantt-overdue .bar {
            fill: #ef4444 !important; /* Red for overdue */
        }
        /* Style for critical path tasks */
        .gantt-critical .bar-progress {
            fill: #dc2626 !important; /* Darker red for critical path progress */
        }
        .gantt-critical .bar {
            fill: #ef4444 !important; /* Red for critical path bar */
            stroke: #b91c1c !important; /* Darker red border */
            stroke-width: 2px;
        }


        /* MODIFICATION: Style for delete button inside notes */
        .delete-note-btn {
            background: none;
            border: none;
            color: #ef4444; /* red-500 */
            cursor: pointer;
            padding: 0 0.5rem;
            font-size: 0.8rem;
        }
        .delete-note-btn:hover {
            color: #dc2626; /* red-600 */
        }

        /* NEW: Styles for status tags */
        .status-tag {
            padding: 4px 12px;
            border-radius: 9999px; /* pill shape */
            font-size: 0.8em;
            font-weight: 600;
            text-transform: capitalize;
            display: inline-block;
        }
        .status-completed {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
        }
        .status-pending {
            background-color: #fef3c7; /* Tailwind yellow-100 */
            color: #92400e; /* Tailwind yellow-800 */
        }
        .status-active {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            color: #4b5563; /* Tailwind gray-600 */
        }
        .status-overdue {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
        }
        
        /* MODIFIED: Chat-to-Task System Styles for Sparkle Background */
        .chat-container {
            position: relative; /* Needed for positioning the canvas */
            display: flex;
            flex-direction: column;
            height: calc(100vh - 8rem);
            background-color: #000; /* Dark background for sparkles */
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        #sparkleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Behind other content */
        }
        .chat-header, .chat-messages, .chat-input-area {
            position: relative;
            z-index: 1; /* In front of the canvas */
            background-color: transparent; /* Make sections see-through */
        }
        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #374151; /* Darker border for contrast */
            font-weight: 600;
            color: #f1f5f9; /* Lighter text color */
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-message {
            display: flex;
            gap: 0.75rem;
            max-width: 75%;
            align-items: flex-start; /* Align items to the top for checkbox */
        }
        .chat-message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #374151;
        }
        .message-content {
            display: flex;
            flex-direction: column;
        }
        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #94a3b8; /* Lighter sender color */
        }
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background-color: rgba(30, 41, 59, 0.8); /* Semi-transparent dark bubble */
            color: #e2e8f0;
            cursor: pointer;
            position: relative;
            backdrop-filter: blur(2px); /* Frosted glass effect */
        }
        .message-bubble:hover {
            background-color: rgba(51, 65, 85, 0.8);
        }
        .message-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        .chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .chat-message.sent .message-bubble {
            background-color: rgba(79, 70, 229, 0.8); /* Semi-transparent accent color bubble */
            color: white;
        }
        .chat-message.sent .message-sender, .chat-message.sent .message-time {
            text-align: right;
        }
        /* NEW: Chat message checkbox - Initially hidden */
        .chat-message-checkbox {
            margin-top: 10px; /* Align with the top of the bubble */
            margin-right: 5px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #4f46e5; /* Tailwind indigo-600 */
            display: none; /* Hidden by default */
        }
        .chat-message.sent .chat-message-checkbox {
            margin-left: 5px; /* Adjust for sent messages */
            margin-right: 0;
        }
        /* Class to make checkboxes visible */
        .chat-message-checkbox.visible {
            display: block;
        }

        .chat-input-area {
            padding: 1.5rem;
            border-top: 1px solid #374151; /* Darker border */
        }
        .chat-input-form {
            display: flex;
            gap: 0.75rem;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #4b5563;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .chat-input::placeholder {
            color: #64748b;
        }
        .chat-send-btn {
            padding: 0.75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .chat-send-btn:hover {
            background-color: #4338ca;
        }

        /* Message Context Menu */
        #messageContextMenu {
            display: none;
            position: absolute;
            z-index: 1001;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 0.5rem 0;
            min-width: 180px;
        }
        .context-menu-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            color: #374151;
            font-size: 0.9rem;
        }
        .context-menu-btn:hover {
            background-color: #f1f5f9;
        }

        /* NEW: Styles for the dedicated Assign Task Page */
        .assign-task-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default to single column on small screens */
            gap: 2rem;
        }

        @media (min-width: 768px) { /* Medium screens and up */
            .assign-task-grid {
                grid-template-columns: 1fr 2fr 1fr; /* Left, Center (wider), Right */
            }
        }

        @media (min-width: 1024px) { /* Large screens and up */
            .assign-task-grid {
                grid-template-columns: 1fr 2fr 1fr; /* Maintain 3 columns */
            }
        }

        .assign-task-column {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .assign-task-column.center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to the top */
            text-align: center;
        }

        /* Adjustments for the form elements within the new page */
        #assignTaskPage .form-group label {
            font-weight: 600; /* Make labels a bit bolder */
            color: #374151; /* Darker text for labels */
        }
        
        /* NEW: Style for the Task Title label */
        #assignTaskPage .assign-task-column.center-content label[for="assignTaskTitleDisplay"] {
            font-size: 1.8rem; /* Increased font size for the label */
            font-weight: 700; /* Make it bolder */
            margin-bottom: 1rem; /* Add some space below the label */
        }

        /* MODIFIED: Smaller padding and font size for most inputs/selects/textareas, and half width */
        #assignTaskPage .form-group input:not(#assignTaskTitleDisplay):not(#assignTaskChecklistInput),
        #assignTaskPage .form-group select:not(#assignTaskCollaborators),
        #assignTaskPage .form-group textarea:not(#assignTaskComments) {
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            color: #111827;
            padding: 0.3rem 0.5rem; /* Even smaller padding */
            font-size: 0.85rem; /* Even smaller font */
            width: 50%; /* Set width to half */
        }

        /* Maintain original compact size for Collaborators and Comments */
        #assignTaskPage #assignTaskCollaborators,
        #assignTaskPage #assignTaskComments {
            padding: 0.4rem 0.6rem; /* Original compact padding */
            font-size: 0.9rem; /* Original compact font size */
            width: 100%; /* Keep full width */
        }

        #assignTaskPage .form-group input[type="file"] {
            padding: 0.2rem 0.4rem; /* Even smaller padding for file input */
            width: 50%; /* Set width to half */
        }

        #assignTaskPage .form-group input:focus,
        #assignTaskPage .form-group select:focus,
        #assignTaskPage .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #assignTaskPage .form-group textarea {
            min-height: 80px; /* Give textareas a minimum height */
        }
        #assignTaskPage .form-group select[multiple] {
            min-height: 120px; /* Ensure multi-select is tall enough */
        }
        /* Further reduction for multi-select height when in a compact column */
        #assignTaskPage .assign-task-column select[multiple] {
            min-height: 80px; /* Reduced height for multi-select in compact columns */
            height: auto; /* Allow it to adapt */
        }

        #assignTaskPage .quick-action-btn {
            background-color: #e0e7ff; /* Lighter indigo for quick actions */
            color: #4f46e5;
        }
        #assignTaskPage .quick-action-btn:hover {
            background-color: #c7d2fe;
        }
        #assignTaskPage .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #assignTaskPage .btn-primary:hover {
            background-color: #4338ca;
        }
        #assignTaskPage .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #assignTaskPage .btn-secondary:hover {
            background-color: #4b5563;
        }

        /* MODIFIED: Specific styling for the Task Title field in the center column */
        #assignTaskPage .assign-task-column.center-content #assignTaskTitleDisplay {
            font-size: 2.5rem; /* Even Larger font size */
            font-weight: 800; /* Even bolder */
            text-align: center;
            min-height: 250px; /* Make it even taller to accommodate large text */
            display: flex;
            align-items: center;
            justify-content: center;
            resize: vertical; /* Allow vertical resizing */
            padding: 1.5rem; /* Add some padding inside the textarea */
            margin-bottom: 1.5rem; /* Add space below the title */
            width: 100%; /* Changed to 100% to cover the entire middle column */
            line-height: 1.2; /* Added line height for better spacing */
        }

        /* NEW: Floating "Mark as Task" button for chat */
        /* This style is now for the button inside the header */
        #markSelectedAsTaskBtn {
            /* display: none;  Visibility controlled by JS */
            background-color: #10b981; /* Green color for positive action */
            color: white;
            padding: 0.5rem 1rem; /* Smaller padding for inline button */
            border-radius: 0.5rem; /* Rounded corners */
            font-weight: 600;
            box-shadow: none; /* No shadow needed for inline */
            z-index: 1; /* Ensure it's above canvas */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            margin-left: 0.5rem; /* Space from "Cancel Selection" */
        }
        #markSelectedAsTaskBtn:hover {
            background-color: #059669; /* Darker green on hover */
            transform: translateY(-1px); /* Subtle lift */
        }

        /* Custom Dropdown Styles */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }

        .custom-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: #f9fafb;
            cursor: pointer;
            font-size: 0.85rem;
            color: #111827;
        }

        .custom-dropdown-header.active {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        .custom-dropdown-header .selected-items {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 0.5rem; /* Space for arrow */
        }

        .custom-dropdown-header .arrow-icon {
            transition: transform 0.2s ease-in-out;
        }

        .custom-dropdown-header.active .arrow-icon {
            transform: rotate(180deg);
        }

        .custom-dropdown-options {
            display: none;
            position: absolute;
            top: 100%; /* Position below the header */
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10; /* Ensure it's above other elements */
            max-height: 150px; /* Limit height for scrollability */
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .custom-dropdown-options.show {
            display: block;
        }

        .custom-dropdown-option {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .custom-dropdown-option:hover {
            background-color: #f3f4f6;
        }

        .custom-dropdown-option input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #4f46e5;
        }
        /* Adjustments for the filter dropdown in Gantt Chart */
        #assigneeFilterContainer .custom-dropdown-options {
            max-height: 200px; /* Slightly taller for filter */
        }

        /* --- START: Requested Font Size Modifications --- */
        /* Decrease font size of the textarea field by 40% */
        .assign-task-column #assignTaskTitleDisplay {
            font-size: 25px !important; /* This makes the font size 60% of its original size */
        }

        /* Increase font size of "Task Title:" label by 2 times */
        .assign-task-column label[for="assignTaskTitleDisplay"] {
            font-size: 3em !important; /* This makes the font size 2 times larger. You can change '2em' to '3em' or '4em' for a larger increase. */
        }
        /* --- END: Requested Font Size Modifications --- */
        #assignTaskPage {
            background-image: url('image.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="text-2xl font-bold mb-4"><i class="fas fa-rocket text-indigo-300 mr-2"></i> Task Manager</h1>
            <div class="user-info text-gray-300">
                <p class="text-sm">Logged in as:</p>
                <div class="user-details flex items-center mt-2">
                    <img id="userAvatar" src="https://placehold.co/40x40/6366f1/ffffff?text=U" alt="User Avatar" class="rounded-full mr-3 border-2 border-indigo-300">
                    <div>
                        <div id="usernameDisplay" class="font-semibold text-lg text-white">User</div>
                        <div class="user-role text-sm text-indigo-200" id="userRoleDisplay">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-pills flex-grow" id="mainNav">
            <button class="nav-btn" id="adminBtn"><i class="fas fa-user-shield"></i><span>Admin</span></button>
            <button class="nav-btn" data-section="dashboardSection"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></button>
            <button class="nav-btn" data-section="chatSection"><i class="fas fa-comments"></i><span>Chat</span></button> <!-- NEW -->
            <button class="nav-btn" data-section="calendarSection"><i class="fas fa-calendar-week"></i><span>Calendar View</span></button>
            <button class="nav-btn" data-section="ganttSection"><i class="fas fa-chart-bar"></i><span>Gantt Chart</span></button>
            <button class="nav-btn" data-section="myTasksOverviewSection"><i class="fas fa-list-check"></i><span>My Tasks</span></button>
            <button class="nav-btn" data-section="taskNameSection"><i class="fas fa-plus-circle"></i><span>Add Task</span></button>
            <button class="nav-btn" data-section="confirmTaskSection"><i class="fas fa-tasks"></i><span>Confirm Tasks <span class="notification-badge bg-red-500 text-white rounded-full px-2 py-1 text-xs ml-2" id="pendingBadge">0</span></span></button>
            <button class="nav-btn" data-section="markCompleteSection"><i class="fas fa-check-double"></i><span>Active Tasks <span class="notification-badge bg-blue-500 text-white rounded-full px-2 py-1 text-xs ml-2" id="activeBadge">0</span></span></button>
            <button class="nav-btn" data-section="taskPointSection"><i class="fas fa-award"></i><span>Assign Points</span></button>
            <button class="nav-btn" data-section="addCommentSection"><i class="fas fa-comments"></i><span>Add Comment</span></button>
            <button class="nav-btn" data-section="leaveSection"><i class="fas fa-calendar-alt"></i><span>Record Leave</span></button>
            <button class="nav-btn" data-section="showAllSection"><i class="fas fa-archive"></i><span>All Data</span></button>
            <button class="nav-btn" id="inboxBtnTrigger"><i class="fas fa-inbox"></i><span>Inbox <span class="notification-badge bg-yellow-500 text-white rounded-full px-2 py-1 text-xs ml-2" id="inboxBadgeDisplay">0</span></span></button>
            <button class="nav-btn" data-section="saveCSVSection"><i class="fas fa-file-csv"></i><span>Export Data</span></button>
            <button class="nav-btn" onclick="window.location.href='Toggle.html'">
              <i class="fas fa-toggle-on"></i>
              <span>Work Status</span>
            </button>

            <!-- Logout Button -->
            <button class="nav-btn" id="logoutButton">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Enhanced Dashboard Section -->
        <section id="dashboardSection" class="section active">
            <div class="dashboard-header-welcome">
               <h2 id="dashboardGreeting" class="font-bold text-3xl mb-1 flex items-center">
                  <i class="fas fa-hand-sparkles mr-3"></i> Welcome, <span id="usernameDisplay">User</span>!
                </h2>
                <p id="dashboardDate" class="current-date text-lg opacity: 0.9;"></p>
                <div class="flex items-center mt-2">
                    <span id="userPerformanceTag" class="inline-block px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">Loading performance...</span>
                    <label class="theme-toggle ml-auto">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="theme-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-clipboard-list text-indigo-600"></i>
                    <div class="value" id="totalTasks">0</div>
                    <div class="label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <div class="value" id="completedTasks">0</div>
                    <div class="label">Completed Tasks</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-hourglass-half text-yellow-500"></i>
                    <div class="value" id="pendingTasks">0</div>
                    <div class="label">Pending Tasks</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star text-purple-500"></i>
                    <div class="value" id="totalPoints">0</div>
                    <div class="label">Total Points Earned</div>
                </div>
            </div>
            
            <div class="dashboard-widgets">
                <!-- Task Progress Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-tasks text-indigo-500"></i> Task Progress</h3>
                        <div class="widget-actions">
                            <button class="widget-action-btn" id="refreshProgress"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div class="task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="taskProgressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="completedCount">0 completed</span>
                            <span id="totalCount">0 total</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Tasks Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-clock text-blue-500"></i> Recent Tasks</h3>
                        <div class="widget-actions">
                            <button class="widget-action-btn" id="viewAllTasks"><i class="fas fa-ellipsis-h"></i></button>
                        </div>
                    </div>
                    <div class="recent-tasks-list" id="recentTasksList">
                        <div class="empty-dashboard-message">
                            <i class="fas fa-tasks"></i>
                            <p>No recent tasks found</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-bolt text-yellow-500"></i> Quick Actions</h3>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action-btn" id="quickAddTask">
                            <i class="fas fa-plus quick-action-icon"></i>
                            <span class="quick-action-label">Add Task</span>
                        </button>
                        <button class="quick-action-btn" id="quickCompleteTask">
                            <i class="fas fa-check quick-action-icon"></i>
                            <span class="quick-action-label">Complete</span>
                        </button>
                        <button class="quick-action-btn" id="quickCalendar">
                            <i class="fas fa-calendar quick-action-icon"></i>
                            <span class="quick-action-label">Calendar</span>
                        </button>
                        <button class="quick-action-btn" id="quickExport">
                            <i class="fas fa-file-export quick-action-icon"></i>
                            <span class="quick-action-label">Export</span>
                        </button>
                    </div>
                </div>
                
                <!-- Performance Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-chart-line text-green-500"></i> Performance</h3>
                    </div>
                    <div id="performanceSparkline" class="sparkline-container">
                        <!-- Sparkline chart will be rendered here -->
                    </div>
                    <div id="achievementBadges" class="mt-2">
                        <!-- Achievement badges will appear here -->
                    </div>
                </div>
            </div>
            
            <section id="adminSection" class="section">
              <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-user-shield mr-3 text-red-600"></i> Admin Dashboard</h2>
              <p class="text-lg text-gray-700">Welcome, Admin. Use this dashboard to manage system-wide settings and users.</p>
            </section>
        </section>

        <!-- NEW: Chat-to-Task System Section -->
        <section id="chatSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-comments mr-3 text-indigo-500"></i> Chat-to-Task System
            </h2>
            <div class="chat-container">
                <canvas id="sparkleCanvas"></canvas> <!-- Sparkle background canvas -->
                <div class="chat-header flex justify-between items-center">
                    <span>Team Discussion</span>
                    <div class="flex items-center">
                        <button id="toggleChatSelectionBtn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition duration-200">
                            <i class="fas fa-check-square mr-1"></i> Select
                        </button>
                        <!-- NEW: Mark as Task button moved inline -->
                        <button id="markSelectedAsTaskBtn" style="display: none;">
                            <i class="fas fa-clipboard-check mr-2"></i> Mark as Task
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be dynamically inserted here -->
                </div>
                <div class="chat-input-area">
                    <form id="chatInputForm" class="chat-input-form">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." autocomplete="off">
                        <button type="submit" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </section>


        <!-- Gantt Chart Section -->
        <section id="ganttSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-bar mr-3 text-purple-500"></i> Task Gantt Chart
            </h2>
            
            <div class="gantt-header">
                <div class="gantt-controls">
                    <!-- ADDITION: "Add Task" button for Gantt Chart -->
                    <button class="gantt-control-btn" id="addNewGanttTaskBtn">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                    <button class="gantt-control-btn" id="refreshGanttBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="gantt-control-btn" id="fitGanttBtn">
                        <i class="fas fa-expand"></i> Fit to Screen
                    </button>
                    <button class="gantt-control-btn" id="toggleCriticalPathBtn">
                        <i class="fas fa-route"></i> Critical Path
                    </button>
                </div>
                
                <div class="gantt-view-options">
                    <button class="gantt-view-btn" data-view="Quarter Day">Quarter Day</button>
                    <button class="gantt-view-btn" data-view="Half Day">Half Day</button>
                    <button class="gantt-view-btn active" data-view="Day">Day</button>
                    <button class="gantt-view-btn" data-view="Week">Week</button>
                    <button class="gantt-view-btn" data-view="Month">Month</button>
                </div>
            </div>
            
            <div class="gantt-filter-container">
                <div class="gantt-filter">
                    <label for="priorityFilter">Filter by Priority:</label>
                    <select id="priorityFilter">
                        <option value="all">All Priorities</option>
                        <option value="High">High Priority</option>
                        <option value="Medium">Medium Priority</option>
                        <option value="Low">Low Priority</option>
                    </select>
                </div>
                
                <div class="gantt-filter">
                    <label for="statusFilter">Filter by Status:</label>
                    <select id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>

                 <div class="gantt-filter" id="assigneeFilterContainer">
                    <label for="assigneeFilter" class="block text-gray-700 font-medium mb-1">Filter by Assignee:</label>
                    <div class="custom-dropdown-header" id="ganttAssigneeDropdownHeader">
                        <span class="selected-items" id="ganttAssigneeSelectedText">All Assignees</span>
                        <i class="fas fa-chevron-down arrow-icon"></i>
                    </div>
                    <div class="custom-dropdown-options" id="ganttAssigneeDropdownOptions">
                        <!-- Options populated by JS -->
                    </div>
                </div>

                 <div class="gantt-filter">
                    <label for="ganttSearch">Search Tasks:</label>
                    <input type="text" id="ganttSearch" placeholder="Search task name...">
                </div>
            </div>
            
            <div class="gantt-chart-container">
                <div id="ganttChart" style="width:100%; height:600px;"></div>

            </div>
        </section>

        <!-- Other sections remain the same as before -->
        <section id="calendarSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-calendar-alt mr-3 text-orange-600"></i> Task Calendar</h2>
            <div id="calendar" class="bg-white p-6 rounded-lg shadow-lg"></div>
        </section>

        <section id="myTasksOverviewSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-list-check mr-3 text-teal-600"></i> My Tasks Overview</h2>
            <div class="task-filters flex flex-wrap gap-3 mb-6 p-2 bg-gray-100 rounded-lg shadow-sm">
                <button class="task-filter-btn active" data-filter="all">All</button>
                <button class="task-filter-btn" data-filter="pending">Pending</button>
                <button class="task-filter-btn" data-filter="inprogress">In Progress</button>
                <button class="task-filter-btn" data-filter="completed">Completed</button>
                <button class="task-filter-btn" data-filter="overdue">Overdue</button>
                <button class="task-filter-btn" data-filter="shared">Shared</button>
            </div>
            <div id="myTasksListContainer" class="tasks-list-grid">
                <div id="myTasksListContainer" class="space-y-3">
  <!-- Sample Task Item -->
  <div class="task-card bg-gray-800 text-white rounded-lg px-4 py-3 shadow-sm">
  <!-- Task Header -->
  <div class="flex items-center justify-between cursor-pointer" onclick="toggleTaskDetails(this)">
    <span class="text-base font-medium">Seo bhi karana hai</span>
    <input type="checkbox" class="h-5 w-5 accent-green-500 rounded-full">
  </div>

  <!-- Task Details (Initially Hidden) -->
  <div class="task-details mt-2 pl-2 text-sm text-gray-300 hidden">
    <p><strong>Description:</strong> Work on optimizing keywords and meta tags.</p>
    <p><strong>Priority:</strong> Medium</p>
    <p><strong>Due:</strong> 2025-07-03</p>
  </div>
</div>

</div>

                <!-- Tasks will be rendered here by JS -->
            </div>
            <p id="noMyTasksMessage" class="hidden text-center mt-8 text-gray-500 italic text-lg">No tasks match the current filter.</p>
        </section>

        <section id="taskNameSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-plus-circle mr-3 text-green-600"></i> Add New Task</h2>
            <form id="addTaskForm" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="taskName" class="block text-gray-700 font-medium mb-1">Task Name:</label><input type="text" id="taskName" required placeholder="e.g., Prepare monthly report" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="form-group"><label for="taskDescription" class="block text-gray-700 font-medium mb-1">Task Description:</label><textarea id="taskDescription" rows="3" placeholder="Provide details about the task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                <div class="form-group"><label for="taskPriority" class="block text-gray-700 font-medium mb-1">Priority:</label><select id="taskPriority" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div>
                <div class="form-group">
                    <label for="taskPoints" class="block text-gray-700 font-medium mb-1">Points:</label>
                    <select id="taskPoints" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="30">30</option>
                        <option value="50">50</option>
                        <option value="80">80</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="form-group"><label for="taskDate" class="block text-gray-700 font-medium mb-1">Due Date:</label><input type="date" id="taskDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="form-group"><label for="taskTime" class="block text-gray-700 font-medium mb-1">Due Time:</label><input type="time" id="taskTime" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></input></div>
                
                <div class="form-group">
                  <label for="taskType" class="block text-gray-700 font-medium mb-1">Task Type:</label>
                  <select id="taskType" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Select Task Type --</option>
                    <option value="Audit">Audit – Check systems</option>
                    <option value="Deploy">Deploy – Push updates</option>
                    <option value="Mentor">Mentor – Guide junior dev</option>
                    <option value="Fix">Fix – Bug fix</option>
                    <option value="Test">Test – Manual/Auto test</option>
                    <option value="Design">Design – UI/UX work</option>
                    <option value="Write">Write – Docs or content</option>
                    <option value="Optimize">Optimize – Performance/SEO</option>
                    <option value="Integrate">Integrate – API/Plugin</option>
                    <option value="Review">Review – Code/content check</option>
                  </select>
                </div>
                <button type="submit" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-save mr-2"></i>Add Task</button>
            </form>
        </section>

        <section id="confirmTaskSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-tasks mr-3 text-purple-600"></i> Confirm Pending Tasks</h2>
            <div id="pendingTasksContainer" class="bg-white p-6 rounded-lg shadow-lg"><h3>Tasks Awaiting Confirmation</h3><table id="pendingTasksTable" class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th></tr></thead><tbody id="pendingTasksList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </section>

        <section id="markCompleteSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-check-double mr-3 text-blue-600"></i> Manage Active Tasks</h2>
            <div id="activeTasksContainer" class="bg-white p-6 rounded-lg shadow-lg"><h3>Currently Active Tasks</h3><table id="activeTasksTable" class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mark Complete</th></tr></thead><tbody id="activeTasksList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </section>

        <section id="taskPointSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-award mr-3 text-yellow-600"></i> Assign Points to Completed Tasks</h2>
            <div id="completedTasksContainer" class="bg-white p-6 rounded-lg shadow-lg"><h3>Completed Tasks Log</h3><table id="completedTasksTable" class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Points</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assign Points</th></tr></thead><tbody id="completedTasksList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </section>

        <section id="addCommentSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-comments mr-3 text-pink-600"></i> Add Comment to Task</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="taskSelect" class="block text-gray-700 font-medium mb-1">Select Task:</label><select id="taskSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="">-- Select a Task --</option></select></div>
                <div class="form-group"><label for="commentText" class="block text-gray-700 font-medium mb-1">Comment:</label><textarea id="commentText" rows="3" required placeholder="Enter your comment" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                <button id="addCommentBtn" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-paper-plane mr-2"></i>Add Comment</button>
            </div>
        </section>

        <section id="leaveSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-calendar-alt mr-3 text-red-600"></i> Record Leave</h2>
            <form id="leaveForm" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="leaveDate" class="block text-gray-700 font-medium mb-1">Leave Date:</label><input type="date" id="leaveDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="form-group"><label for="leaveReason" class="block text-gray-700 font-medium mb-1">Reason for Leave:</label><textarea id="leaveReason" rows="3" required placeholder="Enter leave reason" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                <div class="form-group"><label for="leaveType" class="block text-gray-700 font-medium mb-1">Leave Type:</label><select id="leaveType" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="Informed">Informed</option><option value="Uninformed">Uninformed</option><option value="1st Half Leave">1st Half Leave</option><option value="2nd Half Leave">2d Half Leave</option><option value="Emergency Leave">Emergency Leave</option></select></div>
                <button type="submit" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-calendar-check mr-2"></i>Submit Leave Request</button>
            </form>
        </section>

        <section id="showAllSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-archive mr-3 text-gray-600"></i> View All Recorded Data</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="dataTypeSelect" class="block text-gray-700 font-medium mb-1">Select Data Type to View:</label><select id="dataTypeSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="tasks">Tasks</option><option value="leaves">Leaves</option></select></div>
                <div id="allDataContainer" class="mt-4"><table id="allDataTable" class="min-w-full divide-y divide-gray-200"><thead id="allDataHeader" class="bg-gray-50"></thead><tbody id="allDataBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </div>
        </section>

        <section id="saveCSVSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-file-csv mr-3 text-green-700"></i> Export Data to CSV</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="csvDataType" class="block text-gray-700 font-medium mb-1">Select Data to Export:</label><select id="csvDataType" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="tasks">Tasks</option><option value="leaves">Leaves</option><option value="all">All Data (Combined)</option></select></div>
                <button id="exportCSVBtn" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-download mr-2"></i>Export to CSV</button>
            </div>
        </section>
    </div>

    <!-- Inbox Modal (kept as a modal, not affected by this change) -->
    <div id="inboxModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeInboxModalBtn">×</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-envelope-open-text mr-3 text-indigo-500"></i> Inbox Notifications</h2>
            <div id="inboxMessages" class="text-gray-700">
                <p class="empty-inbox-msg">Your inbox is currently empty.</p>
            </div>
        </div>
    </div>
    
    <!-- ADDITION: Add New Gantt Task Modal (kept as a modal) -->
    <div id="addGanttTaskModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeGanttModalBtn">×</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Add New Gantt Task</h2>
            <form id="addGanttTaskForm">
                <div class="form-group">
                    <label for="ganttTaskName" class="block text-gray-700 font-medium mb-1">Task Name:</label>
                    <input type="text" id="ganttTaskName" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="form-group">
                    <label for="ganttStartDate" class="block text-gray-700 font-medium mb-1">Start Date:</label>
                    <input type="date" id="ganttStartDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="form-group">
                    <label for="ganttEndDate" class="block text-gray-700 font-medium mb-1">End Date:</label>
                    <input type="date" id="ganttEndDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="form-group">
                    <label for="ganttTaskPriority" class="block text-gray-700 font-medium mb-1">Priority:</label>
                    <select id="ganttTaskPriority" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="ganttAssignedTo" class="block text-gray-700 font-medium mb-1">Assign To:</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown-header" id="ganttAssignedToDropdownHeader">
                            <span class="selected-items" id="ganttAssignedToSelectedText">-- Select Assignee(s) --</span>
                            <i class="fas fa-chevron-down arrow-icon"></i>
                        </div>
                        <div class="custom-dropdown-options" id="ganttAssignedToDropdownOptions">
                            <!-- Options populated by JS -->
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ganttTaskProgress" class="block text-gray-700 font-medium mb-1">Progress (%):</label>
                    <input type="number" id="ganttTaskProgress" min="0" max="100" value="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="form-group">
                    <label for="ganttDependencies" class="block text-gray-700 font-medium mb-1">Dependencies (comma-separated Task IDs):</label>
                    <input type="text" id="ganttDependencies" placeholder="e.g., task123, task456" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">Add Task to Chart</button>
            </form>
        </div>
    </div>
    
    <!-- NEW: Dedicated Assign Task Page -->
    <section id="assignTaskPage" class="section">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-clipboard-check mr-3 text-indigo-500"></i> Assign Task from Chat
        </h2>
        <form id="assignTaskForm" class="bg-white p-6 rounded-lg shadow-lg">
            <div class="assign-task-grid">
                <!-- Left Column (smaller) -->
                <div class="assign-task-column">
                    <div class="form-group">
                        <label for="assignTaskPoints" class="block text-gray-700 font-medium mb-1">Points:</label>
                        <select id="assignTaskPoints" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="80">80</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="form-group flex items-center">
                        <input type="checkbox" id="assignTaskIsSubtask" class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label for="assignTaskIsSubtask" class="text-gray-700 font-medium">Is this a subtask?</label>
                    </div>
                    <div class="form-group">
                        <label for="assignTaskAssignTo" class="block text-gray-700 font-medium mb-1">Assign To:</label>
                        <div class="custom-dropdown-container">
                            <div class="custom-dropdown-header" id="assignTaskAssignToDropdownHeader">
                                <span class="selected-items" id="assignTaskAssignToSelectedText">-- Select Assignee(s) --</span>
                                <i class="fas fa-chevron-down arrow-icon"></i>
                            </div>
                            <div class="custom-dropdown-options" id="assignTaskAssignToDropdownOptions">
                                <!-- Options populated by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assignTaskEmail" class="block text-gray-700 font-medium mb-1">Task-Specific Email ID:</label>
                        <input type="email" id="assignTaskEmail" placeholder="Enter an email for this task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="form-group">
                        <label for="assignTaskLink" class="block text-gray-700 font-medium mb-1">Related Link:</label>
                        <input type="url" id="assignTaskLink" placeholder="e.g., https://example.com/related-doc" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="form-group">
                        <label for="assignTaskParentId" class="block text-gray-700 font-medium mb-1">Parent Task ID (if subtask):</label>
                        <input type="text" id="assignTaskParentId" placeholder="Enter ID of parent task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="form-group">
                        <label for="assignTaskAddTo" class="block text-gray-700 font-medium mb-1">Add to:</label>
                        <select id="assignTaskAddTo" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="personal">Personal Task List</option>
                            <option value="gantt">Gantt Chart</option>
                            <option value="note">Sticky Note</option>
                        </select>
                    </div>
                    <div class="form-group mt-4">
                        <label for="assignTaskChecklistInput" class="block text-gray-700 font-medium mb-1">Checklist:</label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="assignTaskChecklistInput" placeholder="Add checklist item" class="flex-grow p-2 border border-gray-300 rounded">
                            <button type="button" id="addAssignTaskChecklistBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Add</button>
                        </div>
                        <ul id="assignTaskChecklistItems" class="list-disc pl-5 text-gray-800 space-y-1">
                            <!-- checklist items go here -->
                        </ul>
                    </div>
                </div>

                <!-- Center Column (for Task Title, Collaborators, Comments) -->
                <div class="assign-task-column center-content">
                    <div class="form-group w-full flex flex-col items-center">
                        <label for="assignTaskTitleDisplay" class="block text-gray-700 font-medium mb-1 text-2xl">Task Title:</label>
                        <textarea id="assignTaskTitleDisplay" rows="3" class="p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed text-3xl font-bold" readonly></textarea>
                    </div>
                    <div class="form-group w-full">
                        <label for="assignTaskCollaborators" class="block text-gray-700 font-medium mb-1">Collaborators (select multiple):</label>
                        <div class="custom-dropdown-container">
                            <div class="custom-dropdown-header" id="assignTaskCollaboratorsDropdownHeader">
                                <span class="selected-items" id="assignTaskCollaboratorsSelectedText">Self</span>
                                <i class="fas fa-chevron-down arrow-icon"></i>
                            </div>
                            <div class="custom-dropdown-options" id="assignTaskCollaboratorsDropdownOptions">
                                <!-- Options populated by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group w-full">
                        <label for="assignTaskComments" class="block text-gray-700 font-medium mb-1">Comments:</label>
                        <textarea id="assignTaskComments" rows="3" placeholder="Add initial comments for this task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </div>

                <!-- Right Column (expanded for date/time/priority/timer) -->
                <div class="assign-task-column">
                    <div class="form-group">
                        <label for="assignTaskStartDate" class="block text-gray-700 font-medium mb-1">Start Date:</label>
                        <input type="date" id="assignTaskStartDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="form-group">
                        <label for="assignTaskDate" class="block text-gray-700 font-medium mb-1">Due Date:</label>
                        <input type="date" id="assignTaskDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="form-group">
                        <label for="assignTaskReminder" class="block text-gray-700 font-medium mb-1">Reminder (e.g., 1 day, 2 hours):</label>
                        <input type="text" id="assignTaskReminder" placeholder="e.g., 1 day, 2 hours" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="form-group">
                        <label for="assignTaskImageUpload" class="block text-gray-700 font-medium mb-1">Upload Image:</label>
                        <input type="file" id="assignTaskImageUpload" accept="image/*" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <hr class="my-4">
                    <div class="form-group">
                        <label class="block text-gray-700 font-medium mb-1">Start Timer:</label>
                        <button type="button" id="assignTaskStartTimerBtn" class="w-full py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            <i class="fas fa-play mr-2"></i>Start Timer
                        </button>
                        <div id="assignTaskLiveTimerDisplay" class="mt-2 text-lg font-bold text-indigo-700">00:00:00</div>
                    </div>
                    <div class="form-group">
                        <label for="assignTaskPriority" class="block text-gray-700 font-medium mb-1">Priority:</label>
                        <select id="assignTaskPriority" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" id="cancelAssignTaskBtn" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Create Task</button>
            </div>
        </form>
    </section>


    <!-- Custom Alert Modal (for "Task added successfully!") -->
    <div id="customAlertModal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <h3 id="customAlertTitle" class="text-xl font-semibold mb-2"></h3>
            <p id="customAlertMessage" class="text-gray-700 mb-4"></p>
            <button id="customAlertCloseBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-200">OK</button>
        </div>
    </div>

    <!-- NEW: Message Context Menu -->
    <div id="messageContextMenu">
        <button id="contextMenuMarkAsTaskBtn" class="context-menu-btn">
            <i class="fas fa-check-square"></i> Mark as Task
        </button>
        <button id="contextMenuReplyBtn" class="context-menu-btn">
            <i class="fas fa-reply"></i> Reply
        </button>
        <button id="contextMenuShareBtn" class="context-menu-btn">
            <i class="fas fa-share"></i> Share
        </button>
    </div>

    <!-- Audio element for bell sound -->
    <audio id="bellSound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-ringing-1237.mp3" preload="auto"></audio>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <!-- Frappe Gantt JS -->
    <script src='https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js'></script>
    <!-- Sparkline chart library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="firebase-login-toggle.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            serverTimestamp, 
            query, 
            where, 
            getDocs, 
            updateDoc, 
            doc, 
            getDoc,
            onSnapshot,
            arrayUnion // Import arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYF8V_BDf34UjEYAyDLLFs9cgb7IEjO7I",
            authDomain: "taskmanager-b93e4.firebaseapp.com",
            projectId: "taskmanager-b93e4",
            storageBucket: "taskmanager-b93e4.firebasestorage.app",
            messagingSenderId: "613129920368",
            appId: "1:613129920368:web:6077e6ae85031c29f4b9b5",
            measurementId: "G-W5C4YSJSDZ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: Sparkle Animation ---
        const sparkleCanvas = document.getElementById('sparkleCanvas');
        const sparkleCtx = sparkleCanvas.getContext('2d');
        let particles = [];
        let animationFrameId;

        function resizeCanvas() {
            sparkleCanvas.width = sparkleCanvas.offsetWidth;
            sparkleCanvas.height = sparkleCanvas.offsetHeight;
        }

        function createParticles() {
            particles = [];
            const particleCount = Math.floor((sparkleCanvas.width * sparkleCanvas.height) / 5000);
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * sparkleCanvas.width,
                    y: Math.random() * sparkleCanvas.height,
                    vx: Math.random() * 0.4 - 0.2,
                    vy: Math.random() * 0.4 - 0.2,
                    radius: Math.random() * 1.5 + 0.5,
                    opacity: Math.random() * 0.5 + 0.2
                });
            }
        }

        function drawParticles() {
            sparkleCtx.clearRect(0, 0, sparkleCanvas.width, sparkleCanvas.height);
            particles.forEach(p => {
                sparkleCtx.beginPath();
                sparkleCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                sparkleCtx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                sparkleCtx.fill();
            });
        }

        function updateParticles() {
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                if (p.x < 0 || p.x > sparkleCanvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > sparkleCanvas.height) p.vy *= -1;
            });
        }

        function animateSparkles() {
            updateParticles();
            drawParticles();
            animationFrameId = requestAnimationFrame(animateSparkles);
        }
        
        function startSparkleAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            resizeCanvas();
            createParticles();
            animateSparkles();
        }

        function stopSparkleAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }
        
        window.addEventListener('resize', () => {
             if (document.getElementById('chatSection').classList.contains('active')) {
                startSparkleAnimation();
             }
        });


        // Custom Alert Modal Functions
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        function showCustomAlert(title, message, callback = null, isConfirmation = false) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            
            // Clear previous event listeners
            customAlertCloseBtn.onclick = null;

            if (isConfirmation) {
                // For confirmation, add a "Confirm" button
                let confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirm';
                confirmBtn.className = 'bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200 mr-2';
                confirmBtn.onclick = () => {
                    customAlertModal.style.display = 'none';
                    if (callback) callback();
                    confirmBtn.remove(); // Remove confirm button after use
                    customAlertCloseBtn.textContent = 'OK'; // Reset text for next alert
                };

                let cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500 transition duration-200';
                cancelBtn.onclick = () => {
                    customAlertModal.style.display = 'none';
                    confirmBtn.remove(); // Remove confirm button after use
                    cancelBtn.remove(); // Remove cancel button
                    customAlertCloseBtn.textContent = 'OK'; // Reset text for next alert
                };
                
                // Add buttons to a container or directly to content
                const buttonContainer = customAlertCloseBtn.parentElement;
                buttonContainer.insertBefore(confirmBtn, customAlertCloseBtn);
                buttonContainer.insertBefore(cancelBtn, customAlertCloseBtn);
                customAlertCloseBtn.style.display = 'none'; // Hide the original OK button for confirmation
            } else {
                customAlertCloseBtn.textContent = 'OK'; // Ensure it's "OK" for regular alerts
                customAlertCloseBtn.style.display = 'inline-block'; // Show it
                customAlertCloseBtn.onclick = () => {
                    customAlertModal.style.display = 'none';
                    if (callback) callback();
                };
            }

            customAlertModal.style.display = 'block';
        }

        customAlertCloseBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == customAlertModal) {
                customAlertModal.style.display = 'none';
            }
        });

        // --- User Management ---
        async function logoutUser() {
          try {
            await signOut(auth);
            localStorage.clear(); 
            showCustomAlert("Logged Out", "Logged out successfully!");
            window.location.href = "LandingPage.html"; 
          } catch (error) {
            console.error("Logout failed:", error.message);
            showCustomAlert("Error", "Logout failed. Check console for details.");
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          const logoutBtn = document.getElementById("logoutButton");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
              logoutUser();
            });
          }
        });

        // --- Main Application Logic ---
        let userTasks = [];
        let allTasks = [];
        let currentUser = null;
        let currentUserData = {};
        let unsubscribeUserTasks = null;
        let unsubscribeAllTasks = null;
        let unsubscribeUser = null;
        let ganttChart = null; // Reference to the Gantt chart instance
        let showCriticalPath = false; // State for critical path toggle
        let isSelectionModeActive = false; // NEW: State for chat selection mode

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navButtons = document.querySelectorAll('.nav-btn');
        const addTaskForm = document.getElementById('addTaskForm');
        const pendingTasksList = document.getElementById('pendingTasksList');
        const activeTasksList = document.getElementById('activeTasksList');
        const completedTasksList = document.getElementById('completedTasksList');
        const taskSelect = document.getElementById('taskSelect');
        const addCommentBtn = document.getElementById('addCommentBtn');
        const leaveForm = document.getElementById('leaveForm');
        const dataTypeSelect = document.getElementById('dataTypeSelect');
        const allDataHeader = document.getElementById('allDataHeader');
        const allDataBody = document.getElementById('allDataBody');
        const csvDataType = document.getElementById('csvDataType');
        const exportCSVBtn = document.getElementById('exportCSVBtn');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const pendingBadge = document.getElementById('pendingBadge');
        const activeBadge = document.getElementById('activeBadge');
        const totalTasksEl = document.getElementById('totalTasks');
        const completedTasksEl = document.getElementById('completedTasks');
        const pendingTasksEl = document.getElementById('pendingTasks');
        const totalPointsEl = document.getElementById('totalPoints');
        const myTasksListContainerEl = document.getElementById('myTasksListContainer');
        const taskFilterBtns = document.querySelectorAll('.task-filter-btn');
        const noMyTasksMessageEl = document.getElementById('noMyTasksMessage');
        const inboxBtnTrigger = document.getElementById('inboxBtnTrigger');
        const inboxModal = document.getElementById('inboxModal');
        const closeInboxModalBtn = document.getElementById('closeInboxModalBtn');
        const inboxMessagesEl = document.getElementById('inboxMessages');
        const inboxBadgeDisplayEl = document.getElementById('inboxBadgeDisplay');
        const bellSound = document.getElementById('bellSound');
        let rangBellForTasks = new Set();
        let overdueCheckInterval;
        let calendar;

        // Dashboard specific elements
        const taskProgressBar = document.getElementById('taskProgressBar');
        const completedCountEl = document.getElementById('completedCount');
        const totalCountEl = document.getElementById('totalCount');
        const recentTasksListEl = document.getElementById('recentTasksList');
        const refreshProgressBtn = document.getElementById('refreshProgress');
        const viewAllTasksBtn = document.getElementById('viewAllTasks');
        const quickAddTaskBtn = document.getElementById('quickAddTask');
        const quickCompleteTaskBtn = document.getElementById('quickCompleteTask');
        const quickCalendarBtn = document.getElementById('quickCalendar');
        const quickExportBtn = document.getElementById('quickExport');
        const userPerformanceTag = document.getElementById('userPerformanceTag');
        const userAvatar = document.getElementById('userAvatar');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const performanceSparkline = document.getElementById('performanceSparkline');
        const achievementBadges = document.getElementById('achievementBadges');

        // Gantt Chart Elements
        const ganttChartEl = document.getElementById('ganttChart');
        const refreshGanttBtn = document.getElementById('refreshGanttBtn');
        const fitGanttBtn = document.getElementById('fitGanttBtn');
        const ganttViewBtns = document.querySelectorAll('.gantt-view-btn');
        const priorityFilter = document.getElementById('priorityFilter');
        const statusFilter = document.getElementById('statusFilter');
        const ganttSearch = document.getElementById('ganttSearch'); // New search input
        const toggleCriticalPathBtn = document.getElementById('toggleCriticalPathBtn'); // New critical path toggle

        // ADDITION: Gantt Chart Add Task Modal elements
        const addNewGanttTaskBtn = document.getElementById('addNewGanttTaskBtn');
        const addGanttTaskModal = document.getElementById('addGanttTaskModal');
        const closeGanttModalBtn = document.getElementById('closeGanttModalBtn');
        const addGanttTaskForm = document.getElementById('addGanttTaskForm');
        
        // NEW: Chat-to-Task Elements
        const chatMessagesEl = document.getElementById('chatMessages');
        const chatInputForm = document.getElementById('chatInputForm');
        const chatInput = document.getElementById('chatInput');
        const messageContextMenu = document.getElementById('messageContextMenu');
        const contextMenuMarkAsTaskBtn = document.getElementById('contextMenuMarkAsTaskBtn');
        const contextMenuReplyBtn = document.getElementById('contextMenuReplyBtn');
        const contextMenuShareBtn = document.getElementById('contextMenuShareBtn');
        const markSelectedAsTaskBtn = document.getElementById('markSelectedAsTaskBtn'); // NEW floating button
        const toggleChatSelectionBtn = document.getElementById('toggleChatSelectionBtn'); // NEW: Select/Cancel button

        // NEW: Dedicated Assign Task Page elements
        const assignTaskPage = document.getElementById('assignTaskPage');
        const assignTaskForm = document.getElementById('assignTaskForm');
        const assignTaskTitleDisplay = document.getElementById('assignTaskTitleDisplay');
        const assignTaskPoints = document.getElementById('assignTaskPoints');
        const assignTaskIsSubtask = document.getElementById('assignTaskIsSubtask');
        const assignTaskPriority = document.getElementById('assignTaskPriority');
        const assignTaskStartDate = document.getElementById('assignTaskStartDate');
        const assignTaskDate = document.getElementById('assignTaskDate');
        const assignTaskReminder = document.getElementById('assignTaskReminder');
        const assignTaskEmail = document.getElementById('assignTaskEmail');
        const assignTaskImageUpload = document.getElementById('assignTaskImageUpload');
        const assignTaskLink = document.getElementById('assignTaskLink');
        const assignTaskParentId = document.getElementById('assignTaskParentId');
        const assignTaskAddTo = document.getElementById('assignTaskAddTo');
        const assignTaskStartTimerBtn = document.getElementById('assignTaskStartTimerBtn');
        const assignTaskLiveTimerDisplay = document.getElementById('assignTaskLiveTimerDisplay');
        const assignTaskChecklistInput = document.getElementById('assignTaskChecklistInput');
        const addAssignTaskChecklistBtn = document.getElementById('addAssignTaskChecklistBtn');
        const assignTaskChecklistItems = document.getElementById('assignTaskChecklistItems');
        const cancelAssignTaskBtn = document.getElementById('cancelAssignTaskBtn');

        // References to custom dropdowns and their parts
        const assignTaskAssignToDropdownHeader = document.getElementById('assignTaskAssignToDropdownHeader');
        const assignTaskAssignToDropdownOptions = document.getElementById('assignTaskAssignToDropdownOptions');
        const assignTaskAssignToSelectedText = document.getElementById('assignTaskAssignToSelectedText');

        const assignTaskCollaboratorsDropdownHeader = document.getElementById('assignTaskCollaboratorsDropdownHeader');
        const assignTaskCollaboratorsDropdownOptions = document.getElementById('assignTaskCollaboratorsDropdownOptions');
        const assignTaskCollaboratorsSelectedText = document.getElementById('assignTaskCollaboratorsSelectedText');

        const ganttAssignedToDropdownHeader = document.getElementById('ganttAssignedToDropdownHeader');
        const ganttAssignedToDropdownOptions = document.getElementById('ganttAssignedToDropdownOptions');
        const ganttAssignedToSelectedText = document.getElementById('ganttAssignedToSelectedText');

        const ganttAssigneeDropdownHeader = document.getElementById('ganttAssigneeDropdownHeader');
        const ganttAssigneeDropdownOptions = document.getElementById('ganttAssigneeDropdownOptions');
        const ganttAssigneeSelectedText = document.getElementById('ganttAssigneeSelectedText');


        let selectedChatMessages = []; // To store selected messages for multi-chat-to-task


        // Initialize the application
        function initApp() {
            setupEventListeners();
            initializeCalendar();
            setupDarkModeToggle();
            renderInitialChatMessages(); // Render messages first, then selection mode can be toggled
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    await populateCustomDropdowns(); // Populate all custom dropdowns
                    setupListeners(user.uid);
                    updateUIForUser();
                } else {
                    // User is signed out
                    cleanupOnLogout();
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            navButtons.forEach(btn => {
                if (btn.dataset.section) { 
                    btn.addEventListener('click', () => showSection(btn.dataset.section));
                }
            });
            
            if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('active'));
            
            // Task management
            addTaskForm.addEventListener('submit', handleAddTask);
            refreshProgressBtn.addEventListener('click', refreshDashboard);
            viewAllTasksBtn.addEventListener('click', () => showSection('myTasksOverviewSection'));
            quickAddTaskBtn.addEventListener('click', () => showSection('taskNameSection'));
            quickCompleteTaskBtn.addEventListener('click', () => showSection('markCompleteSection'));
            quickCalendarBtn.addEventListener('click', () => showSection('calendarSection'));
            quickExportBtn.addEventListener('click', () => showSection('saveCSVSection'));
            
            // Task filters
            taskFilterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    taskFilterBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    renderMyTasks(filter);
                });
            });
            
            // Inbox
            inboxBtnTrigger.addEventListener('click', () => inboxModal.style.display = 'block');
            closeInboxModalBtn.addEventListener('click', () => inboxModal.style.display = 'none');
            
            // Gantt chart controls
            if (refreshGanttBtn) refreshGanttBtn.addEventListener('click', renderGanttChart);
            if (fitGanttBtn) fitGanttBtn.addEventListener('click', fitGanttToScreen);
            if (priorityFilter) priorityFilter.addEventListener('change', renderGanttChart);
            if (statusFilter) statusFilter.addEventListener('change', renderGanttChart);
            if (ganttSearch) ganttSearch.addEventListener('input', renderGanttChart); // Listen for search input changes
            if (toggleCriticalPathBtn) toggleCriticalPathBtn.addEventListener('click', toggleCriticalPath);


            // ADDITION: Gantt Chart "Add Task" Modal Listeners
            if (addNewGanttTaskBtn) {
                addNewGanttTaskBtn.addEventListener('click', () => addGanttTaskModal.style.display = 'block');
            }
            if(closeGanttModalBtn) {
                closeGanttModalBtn.addEventListener('click', () => addGanttTaskModal.style.display = 'none');
            }
            if (addGanttTaskForm) {
                addGanttTaskForm.addEventListener('submit', handleAddGanttTask);
            }

            window.addEventListener('click', (event) => {
                if (event.target == addGanttTaskModal) {
                    addGanttTaskModal.style.display = 'none';
                }
                // Hide context menu if clicking outside
                if (!messageContextMenu.contains(event.target)) {
                    messageContextMenu.style.display = 'none';
                }
            });
            
            // Gantt view options
            ganttViewBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    ganttViewBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const viewMode = e.target.dataset.view;
                    if (ganttChart) {
                        ganttChart.change_view_mode(viewMode);
                    }
                });
            });

            // NEW: Chat-to-Task Event Listeners
            chatInputForm.addEventListener('submit', handleSendMessage);
            chatMessagesEl.addEventListener('change', handleChatMessageCheckboxChange); // Listen for checkbox changes
            markSelectedAsTaskBtn.addEventListener('click', handleMarkSelectedAsTask); // New button listener
            toggleChatSelectionBtn.addEventListener('click', toggleChatSelectionMode); // NEW: Toggle selection mode

            // Context Menu Listener (still available for single message right-click)
            chatMessagesEl.addEventListener('contextmenu', showMessageContextMenu);
            contextMenuMarkAsTaskBtn.addEventListener('click', handleMarkAsTaskClick);
            contextMenuReplyBtn.addEventListener('click', () => showCustomAlert('Reply', 'Reply functionality coming soon!'));
            contextMenuShareBtn.addEventListener('click', () => showCustomAlert('Share', 'Share functionality coming soon!'));


            // NEW: Assign Task Page Listeners
            assignTaskForm.addEventListener('submit', handleCreateTaskFromChat);
            cancelAssignTaskBtn.addEventListener('click', () => showSection('chatSection')); // Go back to chat
            assignTaskStartTimerBtn.addEventListener('click', startAssignTaskTimer);
            addAssignTaskChecklistBtn.addEventListener('click', addAssignTaskChecklistItem);
            assignTaskChecklistItems.addEventListener('click', handleAssignTaskChecklistClick);

            // Custom Dropdown Event Listeners
            if (assignTaskAssignToDropdownHeader) assignTaskAssignToDropdownHeader.addEventListener('click', (e) => toggleCustomDropdown(e, 'assignTaskAssignToDropdownOptions', 'assignTaskAssignToDropdownHeader'));
            if (assignTaskCollaboratorsDropdownHeader) assignTaskCollaboratorsDropdownHeader.addEventListener('click', (e) => toggleCustomDropdown(e, 'assignTaskCollaboratorsDropdownOptions', 'assignTaskCollaboratorsDropdownHeader'));
            if (ganttAssignedToDropdownHeader) ganttAssignedToDropdownHeader.addEventListener('click', (e) => toggleCustomDropdown(e, 'ganttAssignedToDropdownOptions', 'ganttAssignedToDropdownHeader'));
            if (ganttAssigneeDropdownHeader) ganttAssigneeDropdownHeader.addEventListener('click', (e) => toggleCustomDropdown(e, 'ganttAssigneeDropdownOptions', 'ganttAssigneeDropdownHeader'));

            // Close custom dropdowns when clicking outside
            window.addEventListener('click', (event) => {
                const dropdowns = document.querySelectorAll('.custom-dropdown-options.show');
                dropdowns.forEach(dropdown => {
                    const header = dropdown.previousElementSibling; // Assuming header is the direct previous sibling
                    if (header && !header.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('show');
                        header.classList.remove('active');
                    }
                });
            });
        }

        // Function to toggle custom dropdown visibility
        function toggleCustomDropdown(event, optionsId, headerId) {
            event.stopPropagation(); // Prevent click from propagating to window and closing immediately
            const options = document.getElementById(optionsId);
            const header = document.getElementById(headerId);

            // Close other open dropdowns
            document.querySelectorAll('.custom-dropdown-options.show').forEach(openOptions => {
                if (openOptions.id !== optionsId) {
                    openOptions.classList.remove('show');
                    openOptions.previousElementSibling.classList.remove('active');
                }
            });

            options.classList.toggle('show');
            header.classList.toggle('active');
        }

        // Function to update selected text in custom dropdown header
        function updateSelectedText(dropdownOptionsId, selectedTextId, isFilter = false) {
            const optionsContainer = document.getElementById(dropdownOptionsId);
            const selectedTextElement = document.getElementById(selectedTextId);
            const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
            const selectedNames = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedNames.push(checkbox.nextElementSibling.textContent);
                }
            });

            if (selectedNames.length === 0) {
                selectedTextElement.textContent = isFilter ? 'All Assignees' : '-- Select Assignee(s) --';
            } else if (selectedNames.length === 1) {
                selectedTextElement.textContent = selectedNames[0];
            } else {
                selectedTextElement.textContent = `${selectedNames.length} selected`;
            }
        }


        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    localStorage.setItem("username", currentUserData.username || "User");
                    localStorage.setItem("userRole", currentUserData.role || "Member");
                    localStorage.setItem("userAvatar", currentUserData.photoURL || "https://placehold.co/40x40/6366f1/ffffff?text=U");
                } else {
                    // Set defaults if user document doesn't exist
                    localStorage.setItem("username", "User");
                    localStorage.setItem("userRole", "Member");
                    localStorage.setItem("userAvatar", "https://placehold.co/40x40/6366f1/ffffff?text=U");
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }
        
        // NEW: Centralized function to populate all custom dropdowns
        async function populateCustomDropdowns() {
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                // Populate Assign Task Assign To
                populateSingleCustomDropdown(
                    'assignTaskAssignToDropdownOptions', 
                    'assignTaskAssignToSelectedText', 
                    users, 
                    false, 
                    true // Select current user by default
                );

                // Populate Assign Task Collaborators
                populateSingleCustomDropdown(
                    'assignTaskCollaboratorsDropdownOptions', 
                    'assignTaskCollaboratorsSelectedText', 
                    users, 
                    false, 
                    true, // Select current user by default (as 'Self')
                    true // Add 'Self' option specifically
                );

                // Populate Gantt Assigned To (modal)
                populateSingleCustomDropdown(
                    'ganttAssignedToDropdownOptions', 
                    'ganttAssignedToSelectedText', 
                    users, 
                    false, 
                    true // Select current user by default
                );

                // Populate Gantt Assignee Filter
                populateSingleCustomDropdown(
                    'ganttAssigneeDropdownOptions', 
                    'ganttAssigneeSelectedText', 
                    users, 
                    true // Is filter dropdown
                );

            } catch (error) {
                console.error("Error populating custom dropdowns: ", error);
            }
        }

        // Helper function to populate a single custom dropdown
        function populateSingleCustomDropdown(optionsId, selectedTextId, users, isFilter = false, selectCurrentUser = false, addSelfOption = false) {
            const optionsContainer = document.getElementById(optionsId);
            if (!optionsContainer) return;

            optionsContainer.innerHTML = ''; // Clear existing options

            if (isFilter) {
                const allOptionDiv = document.createElement('div');
                allOptionDiv.className = 'custom-dropdown-option';
                allOptionDiv.innerHTML = `
                    <input type="checkbox" id="${optionsId}-all" value="all" checked>
                    <label for="${optionsId}-all">All Assignees</label>
                `;
                optionsContainer.appendChild(allOptionDiv);
                allOptionDiv.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb.id !== `${optionsId}-all`) cb.checked = false;
                        });
                    }
                    updateSelectedText(optionsId, selectedTextId, isFilter);
                    if (isFilter) renderGanttChart(); // Trigger Gantt re-render for filter
                });
            } else if (!isFilter && !addSelfOption) {
                // For non-filter, non-self dropdowns, add a default placeholder
                const defaultOptionDiv = document.createElement('div');
                defaultOptionDiv.className = 'custom-dropdown-option';
                defaultOptionDiv.innerHTML = `
                    <input type="checkbox" id="${optionsId}-default" value="" disabled>
                    <label for="${optionsId}-default">-- Select Assignee(s) --</label>
                `;
                optionsContainer.appendChild(defaultOptionDiv);
            }


            if (addSelfOption) {
                const selfOptionDiv = document.createElement('div');
                selfOptionDiv.className = 'custom-dropdown-option';
                selfOptionDiv.innerHTML = `
                    <input type="checkbox" id="${optionsId}-self" value="${currentUser ? currentUser.uid : 'self'}" ${selectCurrentUser && currentUser ? 'checked' : ''}>
                    <label for="${optionsId}-self">Self</label>
                `;
                optionsContainer.appendChild(selfOptionDiv);
                selfOptionDiv.querySelector('input').addEventListener('change', () => {
                     updateSelectedText(optionsId, selectedTextId, isFilter);
                     if (isFilter) renderGanttChart();
                });
            }

            users.forEach((user) => {
                // Skip adding 'Self' if already added via addSelfOption, or if it's the current user and 'Self' handles it
                if (addSelfOption && currentUser && user.id === currentUser.uid) {
                    return; 
                }

                const optionDiv = document.createElement('div');
                optionDiv.className = 'custom-dropdown-option';
                const isChecked = selectCurrentUser && currentUser && user.id === currentUser.uid;

                optionDiv.innerHTML = `
                    <input type="checkbox" id="${optionsId}-${user.id}" value="${user.id}" ${isChecked ? 'checked' : ''}>
                    <label for="${optionsId}-${user.id}">${user.username || 'Unnamed User'}</label>
                `;
                optionsContainer.appendChild(optionDiv);

                optionDiv.querySelector('input').addEventListener('change', (e) => {
                    // If "All Assignees" is checked, uncheck it when another option is selected
                    if (isFilter && e.target.checked) {
                        const allCheckbox = optionsContainer.querySelector(`#${optionsId}-all`);
                        if (allCheckbox && allCheckbox.checked) {
                            allCheckbox.checked = false;
                        }
                    } else if (isFilter && !e.target.checked) {
                        // If no other options are checked, re-check "All Assignees"
                        const anyOtherChecked = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]')).some(cb => cb.checked && cb.id !== `${optionsId}-all`);
                        if (!anyOtherChecked) {
                            optionsContainer.querySelector(`#${optionsId}-all`).checked = true;
                        }
                    }
                    updateSelectedText(optionsId, selectedTextId, isFilter);
                    if (isFilter) renderGanttChart(); // Trigger Gantt re-render for filter
                });
            });

            updateSelectedText(optionsId, selectedTextId, isFilter); // Initial update of selected text
        }
        
        // NEW: Setup all Firestore listeners
        function setupListeners(userId) {
            // Clean up old listeners first
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeUserTasks) unsubscribeUserTasks();
            if (unsubscribeAllTasks) unsubscribeAllTasks();

            // 1. User data listener
            unsubscribeUser = onSnapshot(doc(db, 'users', userId), (doc) => {
                if (doc.exists()) {
                    currentUserData = doc.data();
                    updateUIForUser();
                }
            });

            // 2. User-specific tasks listener
            // Modified: Use array-contains-any for assignedTo if it's an array
            const userTasksQuery = query(collection(db, 'forms'), where('assignedTo', 'array-contains', userId));
            unsubscribeUserTasks = onSnapshot(userTasksQuery, (snapshot) => {
                userTasks = [];
                snapshot.forEach(doc => {
                    userTasks.push({ id: doc.id, ...doc.data() });
                });
                updateUserSpecificUI(); // Update UI parts that ONLY show the current user's data
            });

            // 3. All tasks listener (for global views like Gantt and Calendar)
            const allTasksQuery = query(collection(db, 'forms'));
            unsubscribeAllTasks = onSnapshot(allTasksQuery, (snapshot) => {
                allTasks = [];
                const userNames = {}; // Cache for usernames
                
                const promises = snapshot.docs.map(async (taskDoc) => {
                    const task = { id: taskDoc.id, ...taskDoc.data() };
                    
                    // Fetch username for each assigned user if not already cached
                    const assignedToUserIds = Array.isArray(task.assignedTo) ? task.assignedTo : (task.assignedTo ? [task.assignedTo] : []);
                    for (const assignedId of assignedToUserIds) {
                        if (assignedId && !userNames[assignedId]) {
                            try {
                                const userDoc = await getDoc(doc(db, 'users', assignedId));
                                if (userDoc.exists()) {
                                    userNames[assignedId] = userDoc.data().username || 'Unknown User';
                                } else {
                                    userNames[assignedId] = 'Unknown User';
                                }
                            } catch (e) {
                                 userNames[assignedId] = 'Unknown User';
                            }
                        }
                    }
                    task.assignedToNames = assignedToUserIds.map(id => userNames[id]).filter(name => name); // Store array of names
                    allTasks.push(task);
                });

                Promise.all(promises).then(() => {
                    updateGlobalUI(); // Update UI parts that show data from ALL users
                });
            });
        }
        
        // NEW: This function updates UI parts that ONLY show the current user's data
        function updateUserSpecificUI() {
            updatePendingTasksList();
            updateActiveTasksList();
            updateCompletedTasksList();
            updateDashboardStats();
            renderRecentTasks();
            checkOverdueTasksAndRingBell();

            const myTasksSection = document.getElementById('myTasksOverviewSection');
            if (myTasksSection.classList.contains('active')) {
                 const activeFilterBtn = document.querySelector('.task-filter-btn.active');
                 const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                 renderMyTasks(activeFilter);
            }
        }

        // NEW: This function updates UI parts that show data from ALL users
        function updateGlobalUI() {
            if (calendar) loadTasksIntoCalendar();
            
            // Always render Gantt chart with the latest allTasks data
            renderGanttChart();
        }

        // Update UI with user-specific data
        function updateUIForUser() {
            const username = localStorage.getItem("username") || "User";
            const role = localStorage.getItem("userRole") || "Member";
            const avatar = localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U";
            
            // Update all username displays
            document.querySelectorAll("#usernameDisplay").forEach(el => {
                el.textContent = username;
            });
            
            document.getElementById("dashboardGreeting").innerHTML = `<i class="fas fa-hand-sparkles mr-3"></i> Welcome, <span id="usernameDisplay">${username}</span>!`;
            userRoleDisplay.textContent = role;
            userAvatar.src = avatar;
            
            // Update performance tag based on user stats
            updatePerformanceTag();
        }
        
        // Update the performance tag based on task completion rate
        function updatePerformanceTag() {
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const completionRate = total > 0 ? (completed / total) * 100 : 0;
            
            let performanceText = "";
            let performanceClass = "";
            
            if (completionRate >= 80) {
                performanceText = "Top Performer";
                performanceClass = "bg-green-100 text-green-800";
            } else if (completionRate >= 50) {
                performanceText = "Solid Performer";
                performanceClass = "bg-blue-100 text-blue-800";
            } else if (completionRate > 0) {
                performanceText = "Needs Improvement";
                performanceClass = "bg-yellow-100 text-yellow-800";
            } else {
                performanceText = "New User";
                performanceClass = "bg-gray-100 text-gray-800";
            }
            
            userPerformanceTag.textContent = performanceText;
            userPerformanceTag.className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${performanceClass}`;
        }
        
        // NEW: Chat-to-Task functions
        function renderInitialChatMessages() {
            const initialMessages = [
                { sender: 'Sarah Chen', text: 'We need to design the homepage by Monday.', time: '10:09 AM', avatar: 'https://placehold.co/40x40/f87171/ffffff?text=SC' },
                { sender: 'You', text: 'Sounds good! Should we include the new branding elements?', time: '10:11 AM', avatar: localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U", sent: true },
                { sender: 'Mike Rodriguez', text: 'Yes, and we also need to optimize the mobile layout for better performance.', time: '10:12 AM', avatar: 'https://placehold.co/40x40/34d399/ffffff?text=MR' },
                { sender: 'Sarah Chen', text: 'Also, remember to add a new feature for user profile customization.', time: '10:15 AM', avatar: 'https://placehold.co/40x40/f87171/ffffff?text=SC' },
                { sender: 'You', text: 'Got it. I\'ll prioritize the homepage design first.', time: '10:17 AM', avatar: localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U", sent: true }
            ];
            
            chatMessagesEl.innerHTML = '';
            initialMessages.forEach((msg, index) => addMessageToChat(msg, index));
            // After rendering, ensure checkboxes are hidden by default
            toggleChatCheckboxesVisibility(false);
        }

        function addMessageToChat({ sender, text, time, avatar, sent = false }, index) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sent ? 'sent' : ''}`;
            messageDiv.dataset.messageIndex = index; // Store index for selection

            // Checkbox is always added, but its visibility is controlled by CSS class
            const checkboxClass = isSelectionModeActive ? 'visible' : '';

            messageDiv.innerHTML = `
                ${!sent ? `<input type="checkbox" class="chat-message-checkbox ${checkboxClass}" data-message-index="${index}">` : ''}
                <img src="${avatar}" alt="avatar" class="avatar">
                <div class="message-content">
                    <div class="message-sender">${sender}</div>
                    <div class="message-bubble">${text}</div>
                    <div class="message-time">${time}</div>
                </div>
                ${sent ? `<input type="checkbox" class="chat-message-checkbox ${checkboxClass}" data-message-index="${index}">` : ''}
            `;
            
            chatMessagesEl.appendChild(messageDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        function handleSendMessage(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (text) {
                const message = {
                    sender: 'You',
                    text: text,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    avatar: localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U",
                    sent: true
                };
                // For demonstration, we'll just add it to the DOM. In a real app, this would be stored.
                const messageCount = chatMessagesEl.children.length;
                addMessageToChat(message, messageCount);
                chatInput.value = '';
            }
        }

        // NEW: Toggle visibility of chat message checkboxes
        function toggleChatCheckboxesVisibility(isVisible) {
            document.querySelectorAll('.chat-message-checkbox').forEach(checkbox => {
                if (isVisible) {
                    checkbox.classList.add('visible');
                } else {
                    checkbox.classList.remove('visible');
                }
            });
        }

        // NEW: Toggle chat selection mode
        function toggleChatSelectionMode() {
            isSelectionModeActive = !isSelectionModeActive;
            toggleChatCheckboxesVisibility(isSelectionModeActive);

            if (isSelectionModeActive) {
                toggleChatSelectionBtn.innerHTML = '<i class="fas fa-times mr-1"></i> Cancel Selection';
                // No need to show markSelectedAsTaskBtn immediately, it's controlled by selectedChatMessages.length
            } else {
                toggleChatSelectionBtn.innerHTML = '<i class="fas fa-check-square mr-1"></i> Select';
                // Clear all selections and hide the "Mark as Task" button
                document.querySelectorAll('.chat-message-checkbox').forEach(cb => cb.checked = false);
                selectedChatMessages = [];
            }
            updateMarkSelectedAsTaskButtonVisibility(); // Always call to update button state
        }

        // NEW: Handle checkbox changes for chat messages
        function handleChatMessageCheckboxChange(e) {
            if (e.target.classList.contains('chat-message-checkbox')) {
                const messageDiv = e.target.closest('.chat-message');
                const messageText = messageDiv.querySelector('.message-bubble').textContent;
                const messageIndex = parseInt(e.target.dataset.messageIndex);

                if (e.target.checked) {
                    selectedChatMessages.push({ index: messageIndex, text: messageText });
                } else {
                    selectedChatMessages = selectedChatMessages.filter(msg => msg.index !== messageIndex);
                }
                updateMarkSelectedAsTaskButtonVisibility();
            }
        }

        // NEW: Update visibility of the floating "Mark Selected as Task" button
        function updateMarkSelectedAsTaskButtonVisibility() {
            if (isSelectionModeActive && selectedChatMessages.length > 0) {
                markSelectedAsTaskBtn.style.display = 'inline-block';
            } else {
                markSelectedAsTaskBtn.style.display = 'none';
            }
        }

        // NEW: Handle clicking the floating "Mark Selected as Task" button
        function handleMarkSelectedAsTask() {
            if (selectedChatMessages.length === 0) {
                showCustomAlert("No Messages Selected", "Please select at least one chat message to mark as a task.");
                return;
            }

            // Combine selected messages into a single string
            const combinedMessageText = selectedChatMessages
                .sort((a, b) => a.index - b.index) // Sort by original order
                .map(msg => msg.text)
                .join('\n\n'); // Join with double newline for readability

            assignTaskForm.reset(); // Reset the form first
            assignTaskTitleDisplay.value = combinedMessageText; // Then set the value
            console.log("DEBUG: Value set to assignTaskTitleDisplay:", assignTaskTitleDisplay.value); // Debugging
            assignTaskLiveTimerDisplay.textContent = '00:00:00'; 
            assignTaskChecklistItems.innerHTML = ''; 
            
            // Clear selected messages and hide button after navigating
            selectedChatMessages = [];
            // Exit selection mode after marking as task
            toggleChatSelectionMode(); // This will also clear checkboxes and hide the button

            showSection('assignTaskPage'); 
        }


        function showMessageContextMenu(e) {
            // Only show context menu if not in selection mode
            if (isSelectionModeActive) {
                e.preventDefault(); // Prevent default context menu
                return;
            }

            // Find the message bubble element that was clicked on
            const messageBubble = e.target.closest('.message-bubble');
            if (!messageBubble) return;

            e.preventDefault();
            
            // Store the message text in the context menu's dataset
            messageContextMenu.dataset.messageText = messageBubble.textContent;

            messageContextMenu.style.display = 'block';
            messageContextMenu.style.top = `${e.pageY}px`;
            messageContextMenu.style.left = `${e.pageX}px`;
        }

        // MODIFIED: handleMarkAsTaskClick to show the new page (for single message via context menu)
        function handleMarkAsTaskClick() {
            const messageText = messageContextMenu.dataset.messageText;
            if (!messageText) return;

            assignTaskForm.reset(); // Reset the form first
            assignTaskTitleDisplay.value = messageText; // Populate the textarea on the new page
            console.log("DEBUG: Single message text for Task Title:", messageText); // Debugging
            assignTaskLiveTimerDisplay.textContent = '00:00:00'; // Reset timer display
            assignTaskChecklistItems.innerHTML = ''; // Clear checklist items
            showSection('assignTaskPage'); // Navigate to the new page
            messageContextMenu.style.display = 'none'; // Hide the context menu
        }
        
        // MODIFIED: handleCreateTaskFromChat to use the new page's elements and multiple assignees
        async function handleCreateTaskFromChat(e) {
            e.preventDefault();

            const title = assignTaskTitleDisplay.value;
            const isSubtask = assignTaskIsSubtask.checked;
            const priority = assignTaskPriority.value;
            
            // Get selected assignees from custom dropdown
            const assignedToCheckboxes = assignTaskAssignToDropdownOptions.querySelectorAll('input[type="checkbox"]:checked');
            const assignedTo = Array.from(assignedToCheckboxes).map(checkbox => checkbox.value).filter(val => val !== 'all');

            // Get selected collaborators from custom dropdown
            const collaboratorsCheckboxes = assignTaskCollaboratorsDropdownOptions.querySelectorAll('input[type="checkbox"]:checked');
            const collaborators = Array.from(collaboratorsCheckboxes).map(checkbox => checkbox.value).filter(val => val !== 'all');


            const startDate = assignTaskStartDate.value;
            const dueDate = assignTaskDate.value;
            const reminder = assignTaskReminder.value;
            const taskEmail = assignTaskEmail.value;
            const imageFile = assignTaskImageUpload.files[0];
            const comments = assignTaskComments.value;
            const relatedLink = assignTaskLink.value;
            const parentTaskId = assignTaskParentId.value.trim();
            const addTo = assignTaskAddTo.value;
            
            // Get checklist items
            const checklistItems = Array.from(assignTaskChecklistItems.children).map(li => ({
                text: li.textContent.replace('×', '').trim(), // Remove the 'x' from the text
                completed: li.querySelector('input[type="checkbox"]').checked
            }));


            if (!currentUser || !title || assignedTo.length === 0 || !dueDate) { // Check for multiple assignees
                showCustomAlert("Error", "Please fill out all required fields (Task Title, Assign To, Due Date).");
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            if (dueDate < today) {
                showCustomAlert("Error", "Due date cannot be in the past.");
                return;
            }
            if (startDate && startDate > dueDate) {
                showCustomAlert("Error", "Start date cannot be after the due date.");
                return;
            }


            const createdByUsername = localStorage.getItem("username") || "User";

            let imageUrl = '';
            if (imageFile) {
                console.log("Image file selected:", imageFile.name);
                imageUrl = `gs://your-firebase-storage-bucket/${imageFile.name}`; 
                showCustomAlert("Image Upload", "Image upload functionality requires Firebase Storage setup. Storing filename as placeholder.");
            }

            try {
                const taskData = {
                    title: title,
                    description: 'Created from chat message.',
                    isSubtask: isSubtask, 
                    priority: priority, 
                    taskType: 'General', 
                    dueDate: `${dueDate}T23:59`, 
                    ganttStartDate: startDate, 
                    status: 'pending',
                    progress: 0, 
                    points: parseInt(assignTaskPoints.value) || 0, // Get points from dropdown
                    comments: comments ? [{ text: comments, by: createdByUsername, createdAt: serverTimestamp() }] : [], 
                    notes: [], 
                    createdBy: createdByUsername,
                    assignedTo: assignedTo, // MODIFIED: now an array
                    collaborators: collaborators, 
                    taskSpecificEmail: taskEmail, 
                    imageUrl: imageUrl, 
                    relatedLink: relatedLink, 
                    parentTaskId: parentTaskId, 
                    reminder: reminder, 
                    checklist: checklistItems, 
                    createdAt: serverTimestamp(),
                    isLocked: false,
                    lockUntil: null,
                    dependencies: '' 
                };

                if (addTo === 'note') {
                    taskData.notes.push(title);
                }

                await addDoc(collection(db, "forms"), taskData);

                assignTaskForm.reset();
                assignTaskLiveTimerDisplay.textContent = '00:00:00';
                assignTaskChecklistItems.innerHTML = '';
                showCustomAlert("Success", "Task created successfully!");
                
                if (addTo === 'gantt') {
                    showSection('ganttSection');
                } else {
                    showSection('myTasksOverviewSection');
                }

            } catch (error) {
                console.error("Error creating task from chat: ", error);
                showCustomAlert("Error", "Failed to create task: " + error.message);
            }
        }

        // NEW: Timer functions for Assign Task Page
        let assignTaskTimerInterval;
        let assignTaskSecondsElapsed = 0;

        function startAssignTaskTimer() {
            clearInterval(assignTaskTimerInterval);
            assignTaskSecondsElapsed = 0;
            updateAssignTaskTimerDisplay();

            assignTaskTimerInterval = setInterval(() => {
                assignTaskSecondsElapsed++;
                updateAssignTaskTimerDisplay();
            }, 1000);
        }

        function updateAssignTaskTimerDisplay() {
            const hrs = String(Math.floor(assignTaskSecondsElapsed / 3600)).padStart(2, '0');
            const mins = String(Math.floor((assignTaskSecondsElapsed % 3600) / 60)).padStart(2, '0');
            const secs = String(assignTaskSecondsElapsed % 60).padStart(2, '0');
            assignTaskLiveTimerDisplay.textContent = `${hrs}:${mins}:${secs}`;
        }

        // NEW: Checklist functions for Assign Task Page
        function addAssignTaskChecklistItem() {
            const input = assignTaskChecklistInput;
            const value = input.value.trim();
            if (value) {
                const li = document.createElement("li");
                li.className = "flex items-center";
                li.innerHTML = `<input type="checkbox" class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 rounded">${value} <button class="ml-auto text-red-600 text-sm remove-item">×</button>`;
                assignTaskChecklistItems.appendChild(li);
                input.value = '';
            }
        }

        function handleAssignTaskChecklistClick(e) {
            if (e.target.classList.contains("remove-item")) {
                e.target.closest("li").remove();
            }
        }


        // Handle adding a new task from the main form
        async function handleAddTask(e) {
            e.preventDefault();

            const taskName = document.getElementById('taskName').value;
            const taskDescription = document.getElementById('taskDescription').value;
            const taskPriority = document.getElementById('taskPriority').value;
            const taskType = document.getElementById('taskType').value;
            const taskDate = document.getElementById('taskDate').value;
            const taskTime = document.getElementById('taskTime').value;
            const taskPoints = parseInt(document.getElementById('taskPoints').value) || 0;

            if (!currentUser) {
                showCustomAlert("Error", "You must be logged in to add a task.");
                return;
            }

            // Date validation: ensure taskDate is not in the past
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Normalize to start of today
            const selectedDate = new Date(taskDate);
            selectedDate.setHours(0, 0, 0, 0); // Normalize selected date

            if (selectedDate < now) {
                showCustomAlert("Validation Error", "Due Date cannot be in the past.");
                return;
            }

            // MODIFIED: assignedTo is now an array, so it's the current user's ID in an array
            const assignedToUserIds = [currentUser.uid]; 
            const createdByUsername = localStorage.getItem("username") || "User";

            try {
                await addDoc(collection(db, "forms"), {
                    title: taskName,
                    description: taskDescription,
                    priority: taskPriority,
                    taskType: taskType,
                    dueDate: `${taskDate}T${taskTime}`,
                    ganttStartDate: taskDate, // Use taskDate as ganttStartDate by default
                    status: 'pending',
                    progress: 0, // Default progress for new tasks
                    points: taskPoints,
                    comments: [],
                    notes: [], // Initialize notes as an empty array
                    createdBy: createdByUsername,
                    assignedTo: assignedToUserIds, // MODIFIED: now an array
                    isSubtask: false, // Default for main task form
                    collaborators: [], // Default for main task form
                    imageUrl: '', // Default for main task form
                    relatedLink: '', // Default for main task form
                    parentTaskId: '', // Default for main task form
                    reminder: '', // Default for main task form
                    checklist: [], // Default for main task form
                    createdAt: serverTimestamp(),
                    isLocked: false,
                    lockUntil: null,
                    dependencies: '' 
                });

                addTaskForm.reset();
                showCustomAlert("Success", "Task added successfully!");
                showSection('confirmTaskSection');

            } catch (error) {
                console.error("Error adding task: ", error);
                showCustomAlert("Error", "Failed to add task: " + error.message);
            }
        }

        // ADDITION: Handle adding a new task from the Gantt Chart modal
        async function handleAddGanttTask(e) {
            e.preventDefault();

            const taskName = document.getElementById('ganttTaskName').value;
            const startDate = document.getElementById('ganttStartDate').value;
            const endDate = document.getElementById('ganttEndDate').value;
            const priority = document.getElementById('ganttTaskPriority').value;
            
            // Get multiple selected assignees for Gantt from custom dropdown
            const assignedToCheckboxes = ganttAssignedToDropdownOptions.querySelectorAll('input[type="checkbox"]:checked');
            const assignedTo = Array.from(assignedToCheckboxes).map(checkbox => checkbox.value).filter(val => val !== 'all');

            const progress = parseInt(document.getElementById('ganttTaskProgress').value) || 0;
            const dependencies = document.getElementById('ganttDependencies').value.trim();

            if (!currentUser) {
                showCustomAlert("Error", "You must be logged in to add a task.");
                return;
            }
            if (assignedTo.length === 0) { // Check for multiple assignees
                showCustomAlert("Error", "Please select at least one assignee for the Gantt task.");
                return;
            }
            
            // Validate dates: end date must be greater than or equal to start date
            if (new Date(startDate) > new Date(endDate)) {
                 showCustomAlert("Validation Error", "Start date cannot be after the end date.");
                 return;
            }

            const createdByUsername = localStorage.getItem("username") || "User";

            try {
                await addDoc(collection(db, "forms"), {
                    title: taskName,
                    description: 'Added from Gantt Chart', // Default description
                    priority: priority,
                    taskType: 'General', // Default type
                    // For consistency, dueDate aligns with endDate for Gantt view
                    dueDate: `${endDate}T23:59`, // Set time to end of day
                    ganttStartDate: startDate, // Specific start date for Gantt chart rendering
                    status: 'pending', // New tasks are pending by default
                    progress: progress,
                    points: 0, // Default points
                    comments: [],
                    notes: [],
                    createdBy: createdByUsername,
                    assignedTo: assignedTo, // MODIFIED: now an array
                    isSubtask: false, // Default for Gantt task form
                    collaborators: [], // Default for Gantt task form
                    imageUrl: '', // Default for Gantt task form
                    relatedLink: '', // Default for Gantt task form
                    parentTaskId: '', // Default for Gantt task form
                    reminder: '', // Default for Gantt task form
                    checklist: [], // Default for Gantt task form
                    createdAt: serverTimestamp(),
                    isLocked: false,
                    lockUntil: null,
                    dependencies: '' 
                });

                addGanttTaskForm.reset();
                addGanttTaskModal.style.display = 'none';
                showCustomAlert("Success", "Task added! The chart will refresh automatically.");
                // The onSnapshot listener will handle the re-rendering.

            } catch (error) {
                console.error("Error adding Gantt task: ", error);
                showCustomAlert("Error", "Failed to add task: " + error.message);
            }
        }


        // MODIFICATION: New function to handle deleting a note from Firestore
        async function handleDeleteNote(taskId, noteIndex) {
            if (!currentUser) {
                showCustomAlert("Error", "You must be logged in to delete notes.");
                return;
            }

            const taskRef = doc(db, 'forms', taskId);
            try {
                const taskDoc = await getDoc(taskRef);
                if (taskDoc.exists()) {
                    const taskData = taskDoc.data();
                    // Create a mutable copy of the notes array
                    const notes = [...(taskData.notes || [])];

                    // Check if the index is valid
                    if (noteIndex >= 0 && noteIndex < notes.length) {
                        // Remove the note at the specified index
                        notes.splice(noteIndex, 1); 
                        // Update the document with the new notes array
                        await updateDoc(taskRef, { notes: notes });
                        showCustomAlert("Success", "Note deleted successfully!");
                        // The real-time listener (onSnapshot) will automatically re-render the UI
                    } else {
                        showCustomAlert("Error", "Note not found or index is out of bounds.");
                    }
                }
            } catch (error) {
                console.error("Error deleting note: ", error);
                showCustomAlert("Error", "Failed to delete note: " + error.message);
            }
        }

        // Update pending tasks list
        function updatePendingTasksList() {
            pendingTasksList.innerHTML = '';
            // Filter tasks where the current user is one of the assignedTo users
            const currentPendingTasks = userTasks.filter(task => 
                task.status === 'pending' && Array.isArray(task.assignedTo) && task.assignedTo.includes(currentUser.uid)
            ); 
            pendingBadge.textContent = currentPendingTasks.length;
            pendingBadge.style.display = currentPendingTasks.length > 0 ? 'flex' : 'none';
            
            currentPendingTasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.description || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'low'}">${task.priority || 'Low'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.dueDate ? task.dueDate.split('T')[0] : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="btn-success confirm-task" data-id="${task.id}" ${task.isLocked ? 'disabled' : ''}>
                            <i class="fas fa-check"></i> Confirm
                        </button>
                    </td>
                `;
                pendingTasksList.appendChild(tr);
            });

            document.querySelectorAll('.confirm-task').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { status: 'active' });
                        showCustomAlert("Task Confirmed", "Task status updated to Active!");
                    } catch (error) {
                        console.error("Error confirming task:", error);
                        showCustomAlert("Error", "Failed to confirm task: " + error.message);
                    }
                });
            });
        }

        // Update active tasks list
        function updateActiveTasksList() {
            activeTasksList.innerHTML = '';
            const now = new Date(); // Get current time
            // Filter tasks where the current user is one of the assignedTo users
            const currentActiveTasks = userTasks.filter(task => 
                task.status === 'active' && Array.isArray(task.assignedTo) && task.assignedTo.includes(currentUser.uid)
            ); 
            activeBadge.textContent = currentActiveTasks.length;
            activeBadge.style.display = currentActiveTasks.length > 0 ? 'flex' : 'none';
            
            currentActiveTasks.forEach(task => {
                const tr = document.createElement('tr');
                const dueDateObj = new Date(task.dueDate);
                const isOverdue = dueDateObj < now; // Check if the due date/time has passed

                let buttonHtml = '';
                let buttonClass = '';
                let completionStatus = '';
                let buttonText = '';

                if (isOverdue) {
                    buttonClass = 'btn-danger';
                    buttonText = '<i class="fas fa-exclamation-triangle"></i> Late Complete';
                    completionStatus = 'late';
                } else {
                    buttonClass = 'btn-success';
                    buttonText = '<i class="fas fa-check-circle"></i> Complete';
                    completionStatus = 'on_time';
                }

                buttonHtml = `
                    <button class="${buttonClass} complete-yes" data-id="${task.id}" data-completion-status="${completionStatus}" ${task.isLocked ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.description || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'low'}">${task.priority || 'Low'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.dueDate ? task.dueDate.split('T')[0] : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${buttonHtml}
                    </td>
                `;
                activeTasksList.appendChild(tr);
            });

            document.querySelectorAll('.complete-yes').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    const completionStatus = btn.dataset.completionStatus; // Get the status from data attribute
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { status: 'completed', completionStatus: completionStatus, completedAt: serverTimestamp() });
                        showCustomAlert("Task Completed", `Task status updated to ${completionStatus === 'late' ? 'Late Complete' : 'Completed'}!`);
                    } catch (error) {
                        console.error("Error completing task:", error);
                        showCustomAlert("Error", "Failed to complete task: " + error.message);
                    }
                });
            });
        }

        // Update completed tasks list for assigning points
        function updateCompletedTasksList() {
            completedTasksList.innerHTML = '';
            // Filter tasks where the current user is one of the assignedTo users
            const completed = userTasks.filter(task => 
                task.status === 'completed' && Array.isArray(task.assignedTo) && task.assignedTo.includes(currentUser.uid)
            );
            if (completed.length === 0) {
                completedTasksList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No completed tasks yet.</td></tr>`;
                return;
            }

            completed.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${task.completionStatus === 'late' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${task.completionStatus === 'late' ? 'Completed (Late)' : 'Completed'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium">${task.points || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <input type="number" class="w-20 p-1 border rounded mr-2" value="${task.points || 0}" min="0" step="10">
                        <button class="btn-success assign-points" data-id="${task.id}">Assign</button>
                    </td>
                `;
                completedTasksList.appendChild(tr);
            });

            document.querySelectorAll('.assign-points').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const taskId = e.target.dataset.id;
                    const newPoints = parseInt(e.target.previousElementSibling.value);
                    if (!isNaN(newPoints)) {
                        try {
                            await updateDoc(doc(db, 'forms', taskId), { points: newPoints });
                            showCustomAlert("Success", "Points assigned successfully!");
                        } catch (error) {
                            console.error("Error assigning points:", error);
                            showCustomAlert("Error", "Failed to assign points.");
                        }
                    }
                });
            });
        }

        // Update dashboard statistics
        function updateDashboardStats() { 
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const pendingActive = userTasks.filter(t => t.status === 'pending' || t.status === 'active').length; 
            const totalPoints = userTasks.reduce((sum, task) => sum + (task.points || 0), 0);
            
            totalTasksEl.textContent = total;
            completedTasksEl.textContent = completed;
            pendingTasksEl.textContent = pendingActive;
            totalPointsEl.textContent = totalPoints;
            
            updatePerformanceTag();
            renderPerformanceSparkline();
            renderAchievementBadges(completed, totalPoints);
        }

        // Update task progress bar
        function updateTaskProgress() {
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            taskProgressBar.style.width = `${percentage}%`;
            completedCountEl.textContent = `${completed} completed`;
            totalCountEl.textContent = `${total} total`;
        }

        // Render recent tasks for dashboard
        function renderRecentTasks() {
            recentTasksListEl.innerHTML = '';
            
            if (userTasks.length === 0) {
                recentTasksListEl.innerHTML = `
                    <div class="empty-dashboard-message">
                        <i class="fas fa-tasks"></i>
                        <p>No recent tasks found</p>
                    </div>
                `;
                return;
            }
            
            const recentTasks = [...userTasks]
                .sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate))
                .slice(0, 5);
            
            recentTasks.forEach(task => {
                const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                const formattedDate = dueDate ? dueDate.toLocaleDateString() : 'No due date';
                
                const taskItem = document.createElement('div');
                taskItem.className = 'recent-task-item draggable-task';
                taskItem.draggable = true;
                taskItem.dataset.taskId = task.id;
                
                taskItem.innerHTML = `
                    <div class="recent-task-checkbox">
                        <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                               data-task-id="${task.id}" class="task-checkbox">
                    </div>
                    <div class="recent-task-content">
                        <div class="recent-task-title">${task.title}</div>
                        <div class="recent-task-due">Due: ${formattedDate} • ${task.priority} Priority</div>
                    </div>
                    <div class="recent-task-actions">
                        <button class="widget-action-btn" data-task-id="${task.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                `;
                
                recentTasksListEl.appendChild(taskItem);
                
                const checkbox = taskItem.querySelector('.task-checkbox');
                checkbox.addEventListener('change', async (e) => {
                    const taskId = e.target.dataset.taskId;
                    const isCompleted = e.target.checked;
                    
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { 
                            status: isCompleted ? 'completed' : 'active' 
                        });
                    } catch (error) {
                        console.error("Error updating task status:", error);
                        e.target.checked = !isCompleted; 
                    }
                });
            });
            
            setupDragAndDrop();
        }

        // Setup drag and drop for tasks
        function setupDragAndDrop() {
            const draggableTasks = document.querySelectorAll('.draggable-task');
            const dropzone = document.createElement('div');
            dropzone.className = 'dropzone';
            dropzone.innerHTML = '<p class="dropzone-label">Drop here to mark as complete</p>';
            
            draggableTasks.forEach(task => {
                task.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
                    e.target.classList.add('dragging');
                });
                
                task.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    dropzone.classList.remove('active');
                    if (dropzone.parentNode) {
                        dropzone.parentNode.removeChild(dropzone);
                    }
                });
                
                task.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (!dropzone.parentNode) {
                        recentTasksListEl.appendChild(dropzone);
                    }
                    dropzone.classList.add('active');
                });
                
                task.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
            });
            
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('active');
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('active');
            });
            
            dropzone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropzone.classList.remove('active');
                
                const taskId = e.dataTransfer.getData('text/plain');
                try {
                    await updateDoc(doc(db, 'forms', taskId), { 
                        status: 'completed' 
                    });
                    showCustomAlert("Task Completed", "Task marked as complete via drag and drop!");
                } catch (error) {
                    console.error("Error completing task:", error);
                    showCustomAlert("Error", "Failed to complete task: " + error.message);
                }
                
                if (dropzone.parentNode) {
                    dropzone.parentNode.removeChild(dropzone);
                }
            });
        }

        // Render performance sparkline chart
        function renderPerformanceSparkline() {
            const ctx = document.createElement('canvas');
            performanceSparkline.innerHTML = '';
            performanceSparkline.appendChild(ctx);
            
            const labels = Array.from({ length: 7 }, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (6 - i));
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            });
            
            const completedData = Array.from({ length: 7 }, () => 
                Math.floor(Math.random() * 10) 
            );
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: completedData,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            });
        }

        // Render achievement badges
        function renderAchievementBadges(completedCount, totalPoints) {
            achievementBadges.innerHTML = '';
            
            if (completedCount >= 1) {
                addBadge('First Task', 'fa-star');
            }
            if (completedCount >= 5) {
                addBadge('Task Master', 'fa-trophy');
            }
            if (totalPoints >= 100) {
                addBadge('Centurion', 'fa-award');
            }
            if (userTasks.some(t => t.priority === 'High' && t.status === 'completed')) {
                addBadge('High Priority Hero', 'fa-fire');
            }
            
            function addBadge(text, icon) {
                const badge = document.createElement('span');
                badge.className = 'achievement-badge';
                badge.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
                achievementBadges.appendChild(badge);
            }
        }

        // Initialize FullCalendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [],
                height: 'auto',
                eventClick: function(info) {
                    showCustomAlert(info.event.title, `Due: ${new Date(info.event.start).toLocaleString()}`);
                }
            });
            
            calendar.render();
        }

        // Load tasks into calendar
        function loadTasksIntoCalendar() {
            if (!calendar) return;
            
            const calendarEvents = allTasks.map(task => ({
                id: task.id,
                title: task.title,
                start: task.dueDate,
                allDay: false,
                color: getPriorityColor(task.priority),
                extendedProps: {
                    description: task.description,
                    status: task.status
                }
            }));
            
            calendar.removeAllEvents();
            calendar.addEventSource(calendarEvents);
        }

        // Get color based on task priority
        function getPriorityColor(priority) {
            switch (priority) {
                case 'High': return '#dc3545';
                case 'Medium': return '#ffc107';
                case 'Low': return '#17a2b8';
                default: return '#6c757d';
            }
        }

        // Toggle critical path highlighting
        function toggleCriticalPath() {
            showCriticalPath = !showCriticalPath;
            if (ganttChart) {
                ganttChart.refresh(showCriticalPath); // Frappe Gantt's refresh can take a boolean to toggle critical path
                showCustomAlert("Critical Path", `Critical Path highlighting is now ${showCriticalPath ? 'ON' : 'OFF'}.`);
            } else {
                showCustomAlert("Gantt Chart Not Ready", "Gantt chart not initialized yet. Please add some tasks.");
            }
        }

        // Initialize Gantt Chart
        function renderGanttChart() {
            if (!ganttChartEl) return;
            
            // Destroy existing chart to re-render
            if (ganttChart && ganttChartEl.firstElementChild) {
                ganttChartEl.innerHTML = ''; // Clear SVG to re-initiate
                ganttChart = null; // Dereference the old chart instance
            }
            
            // Filter tasks based on selected filters and search query
            const priorityFilterValue = priorityFilter.value;
            const statusFilterValue = statusFilter.value; // Corrected: Directly use statusFilter.value
            
            // Get selected assignees from custom filter dropdown
            const assigneeFilterCheckboxes = ganttAssigneeDropdownOptions.querySelectorAll('input[type="checkbox"]:checked');
            const selectedAssignees = Array.from(assigneeFilterCheckboxes).map(checkbox => checkbox.value);
            const isAllAssigneesSelected = selectedAssignees.includes('all');

            const searchTerm = ganttSearch.value.toLowerCase();
            
            const now = new Date(); // Current time for overdue check

            const filteredTasks = allTasks.filter(task => {
                // Priority filter
                if (priorityFilterValue !== 'all' && task.priority !== priorityFilterValue) return false;
                
                // Status filter
                if (statusFilterValue !== 'all') {
                    if (statusFilterValue === 'overdue') {
                        const dueDate = new Date(task.dueDate);
                        if (!((task.status === 'pending' || task.status === 'active') && dueDate < now)) {
                            return false;
                        }
                    } else if (task.status !== statusFilterValue) {
                        return false;
                    }
                }
                
                // Assignee filter (MODIFIED: check if any of the task's assignedTo matches any selected assignee)
                if (!isAllAssigneesSelected) {
                    const taskAssignedTo = Array.isArray(task.assignedTo) ? task.assignedTo : (task.assignedTo ? [task.assignedTo] : []);
                    const hasMatchingAssignee = selectedAssignees.some(selectedId => taskAssignedTo.includes(selectedId));
                    if (!hasMatchingAssignee) return false;
                }

                // Search filter
                if (searchTerm && !task.title.toLowerCase().includes(searchTerm) && 
                    !(task.description && task.description.toLowerCase().includes(searchTerm)) &&
                    !(task.assignedToNames && task.assignedToNames.some(name => name.toLowerCase().includes(searchTerm)))) { // Check assignedToNames
                    return false;
                }

                return true;
            });
            
            // Convert tasks to Gantt format
            const ganttTasks = filteredTasks.map(task => {
                // Use ganttStartDate if available, otherwise default to createdAt or current date
                const startDate = task.ganttStartDate ? new Date(task.ganttStartDate) : new Date(task.createdAt?.toDate() || new Date());
                const dueDate = new Date(task.dueDate);
                
                // Determine custom class based on status and overdue
                let customClass = '';
                let isOverdue = false;
                if (task.status === 'completed') {
                    customClass = 'gantt-completed';
                } else {
                    if (dueDate < now && (task.status === 'pending' || task.status === 'active')) {
                        customClass = 'gantt-overdue';
                        isOverdue = true;
                    } else if (task.status === 'pending') {
                         customClass = 'gantt-pending';
                    } else if (task.status === 'active') {
                        customClass = 'gantt-active';
                    }
                }

                // Parse dependencies string into an array of IDs
                const dependenciesArray = task.dependencies ? task.dependencies.split(',').map(d => d.trim()).filter(d => d) : [];
                
                // Example: Hardcoding a dependency for demonstration if you want to see critical path
                // In a real app, this would come from your task data structure
                if (task.title.includes("Design Homepage")) {
                    dependenciesArray.push("task-develop-frontend"); // Assuming "task-develop-frontend" is another task's ID
                }

                return {
                    id: task.id,
                    name: task.title,
                    start: startDate,
                    end: dueDate,
                    progress: task.progress || 0, // Use task.progress field
                    dependencies: dependenciesArray.join(', '), // Frappe Gantt expects comma-separated string
                    priority: task.priority || 'Medium',
                    status: isOverdue && task.status !== 'completed' ? 'overdue' : task.status,
                    notes: task.notes || [],
                    custom_class: customClass,
                    assigned_to: task.assignedToNames.join(', ') || 'Unknown User' // Display assigned user names
                };
            });
            
            // Initialize Gantt chart
            if (ganttTasks.length > 0) {
                // Ensure the default view mode is 'Day' as per the prompt's active button
                const currentViewModeBtn = document.querySelector('.gantt-view-btn.active');
                const initialViewMode = currentViewModeBtn ? currentViewModeBtn.dataset.view : "Day";

                ganttChart = new Gantt("#ganttChart", ganttTasks, {
                    view_mode: initialViewMode,
                    date_format: "YYYY-MM-DD",
                    // Enable critical path highlighting based on toggle state
                    highlight_critical_path: showCriticalPath, 
                    custom_popup_html: function(task) {
                        const startDate = task.start.toLocaleDateString('en-CA'); 
                        const endDate = task.end.toLocaleDateString('en-CA'); 
                        const progress = task.progress || 0;
                        
                        const notesHtml = task.notes && task.notes.length > 0
                            ? `<ul>${task.notes.map((note, index) => `
                                <li>
                                    <span>${note}</span>
                                    <button class="delete-note-btn gantt-delete-btn" data-task-id="${task.id}" data-note-index="${index}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </li>`).join('')}</ul>`
                            : `<p class="text-sm text-gray-500">No notes for this task yet.</p>`;

                        return `
                            <div class="gantt-popup p-4 bg-white rounded-lg shadow-xl" style="width: 320px;">
                                <div class="mb-3">
                                    <h5 class="font-bold text-lg text-gray-800">${task.name}</h5>
                                    <p class="text-xs text-gray-500">Task Details Overview</p>
                                </div>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-3">
                                    <div class="font-semibold text-gray-600">Assigned To:</div>
                                    <div class="text-gray-800">${task.assigned_to}</div>

                                    <div class="font-semibold text-gray-600">Start Date:</div>
                                    <div class="text-gray-800">🗓 ${startDate}</div>

                                    <div class="font-semibold text-gray-600">End Date:</div>
                                    <div class="text-gray-800">🗓 ${endDate}</div>
                                </div>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                    <div class="font-semibold text-gray-600">Status:</div>
                                    <div><span class="status-tag status-${task.status}">${task.status}</span></div>

                                    <div class="font-semibold text-gray-600">Priority:</div>
                                    <div><span class="priority-tag priority-${task.priority.toLowerCase()}">${task.priority}</span></div>

                                    <div class="font-semibold text-gray-600">Progress:</div>
                                    <div class="text-gray-800">${progress}% done</div>
                                </div>
                                <div class="gantt-popup-notes">
                                    <h6><i class="fas fa-sticky-note mr-2"></i>Notes:</h6>
                                    ${notesHtml}
                                    <div class="gantt-popup-add-note">
                                        <input type="text" placeholder="Add a new note..." id="ganttNewNoteInput-${task.id}" class="flex-grow p-1 border rounded">
                                        <button data-task-id="${task.id}" id="addGanttNoteBtn-${task.id}" class="bg-indigo-500 text-white px-3 py-1 rounded">Add</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    // Callback when task progress is changed by dragging
                    on_progress_change: async (task, progress) => {
                        console.log(`Task ${task.id} progress changed to ${progress}`);
                        try {
                            const taskRef = doc(db, 'forms', task.id);
                            await updateDoc(taskRef, { progress: progress });
                            showCustomAlert("Success", `Progress for "${task.name}" updated to ${progress}%.`);
                        } catch (error) {
                            console.error("Error updating task progress:", error);
                            showCustomAlert("Error", "Failed to update task progress.");
                        }
                    },
                    // Callback when task dates are changed by dragging
                    on_date_change: async (task, start, end) => {
                        console.log(`Task ${task.id} dates changed from ${start.toISOString().split('T')[0]} to ${end.toISOString().split('T')[0]}`);
                        try {
                            const taskRef = doc(db, 'forms', task.id);
                            // Ensure the end date includes a time component to avoid conflicts with dueDate
                            // Frappe Gantt's end date is inclusive, so we'll set dueDate to end of day.
                            await updateDoc(taskRef, { 
                                ganttStartDate: start.toISOString().split('T')[0],
                                dueDate: `${end.toISOString().split('T')[0]}T23:59` // Set to end of day
                            });
                            showCustomAlert("Success", `Dates for "${task.name}" updated.`);
                        } catch (error) {
                            console.error("Error updating task dates:", error);
                            showCustomAlert("Error", "Failed to update task dates.");
                        }
                    },
                    // Callback for general changes (like inline editing of task name)
                    on_change: async (task, arg2, arg3) => {
                         console.log(`Task ${task.id} changed:`, task.name, arg2, arg3);
                        try {
                            const taskRef = doc(db, 'forms', task.id);
                            // Update the task name in Firestore
                            await updateDoc(taskRef, { title: task.name });
                             showCustomAlert("Success", `Task name updated to "${task.name}".`);
                        } catch (error) {
                            console.error("Error updating task name:", error);
                            showCustomAlert("Error", "Failed to update task name.");
                        }
                    },
                    on_popup_open: (task) => {
                        // Event listeners for delete note buttons within the popup
                        document.querySelectorAll('.gantt-delete-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const button = e.currentTarget;
                                const taskId = button.dataset.taskId;
                                const noteIndex = parseInt(button.dataset.noteIndex, 10);
                                showCustomAlert("Confirm Delete", "Are you sure you want to delete this note?", () => {
                                    handleDeleteNote(taskId, noteIndex);
                                    // Optimistically hide the note element
                                    button.closest('li').style.display = 'none'; 
                                }, true); // Pass true to indicate it's a confirmation
                            });
                        });
                        
                        // Event listener for adding a new note from the popup
                        const addNoteBtn = document.getElementById(`addGanttNoteBtn-${task.id}`);
                        if (addNoteBtn) {
                            addNoteBtn.addEventListener('click', async () => {
                                const newNoteInput = document.getElementById(`ganttNewNoteInput-${task.id}`);
                                const newNoteText = newNoteInput.value.trim();
                                if (newNoteText && currentUser) {
                                    try {
                                        await updateDoc(doc(db, 'forms', task.id), {
                                            notes: arrayUnion(newNoteText)
                                        });
                                        newNoteInput.value = '';
                                        showCustomAlert("Note Added", "Note successfully added to task!");
                                    } catch (error) {
                                        console.error("Error adding note:", error);
                                        showCustomAlert("Error", "Failed to add note: " + error.message);
                                    }
                                } else if (!currentUser) {
                                    showCustomAlert("Error", "You must be logged in to add notes.");
                                }
                            });
                        }
                    }
                });
                // Ensure the critical path is rendered initially based on `showCriticalPath` state
                ganttChart.refresh(showCriticalPath);

            } else {
                ganttChartEl.innerHTML = '<div class="empty-dashboard-message"><i class="fas fa-tasks"></i><p>No tasks to display. Try changing filters or adding a new task!</p></div>';
                ganttChart = null;
            }
        }
        
        // Fit Gantt chart to screen
        function fitGanttToScreen() {
            if (ganttChart) {
                ganttChart.refresh();
            } else {
                showCustomAlert("Gantt Chart Not Ready", "No Gantt chart to fit. Please add some tasks first.");
            }
        }

        // Show a specific section
        function showSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            navButtons.forEach(btn => {
                if (btn.dataset.section) {
                    btn.classList.toggle('active', btn.dataset.section === sectionId);
                }
            });

            // Start or stop sparkle animation based on section
            if (sectionId === 'chatSection') {
                startSparkleAnimation();
                // When entering chat section, reset selection mode
                isSelectionModeActive = false;
                toggleChatSelectionBtn.innerHTML = '<i class="fas fa-check-square mr-1"></i> Select';
                document.querySelectorAll('.chat-message-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.classList.remove('visible'); // Ensure hidden initially
                });
                selectedChatMessages = [];
                updateMarkSelectedAsTaskButtonVisibility(); // Ensure button is hidden
            } else {
                stopSparkleAnimation();
                markSelectedAsTaskBtn.style.display = 'none'; // Hide button when leaving chat
            }
            
            if (sectionId === 'calendarSection' && calendar) {
                calendar.render();
            }
            
            if (sectionId === 'ganttSection') {
                renderGanttChart();
            }
            
            if (sectionId === 'myTasksOverviewSection') {
                const activeFilterBtn = document.querySelector('.task-filter-btn.active');
                const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                renderMyTasks(activeFilter);
                
                if (!overdueCheckInterval) {
                    overdueCheckInterval = setInterval(checkOverdueTasksAndRingBell, 60000);
                }
            } else {
                if (overdueCheckInterval) {
                    clearInterval(overdueCheckInterval);
                    overdueCheckInterval = null;
                }
            }
            
            if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }

        // Render the main "My Tasks" view
        async function renderMyTasks(filterStatus = 'all') {
            if (!currentUser) {
                myTasksListContainerEl.innerHTML = '<p class="text-center text-gray-500">Please log in to view your tasks.</p>';
                noMyTasksMessageEl.style.display = 'none';
                return;
            }

            const now = new Date();
            let filteredTasks = [];
            
            // For 'shared' filter, show tasks where the current user is NOT an assignee
            // For other filters, show tasks where the current user IS an assignee
            const tasksForFilter = (filterStatus === 'shared') 
                ? allTasks.filter(task => Array.isArray(task.assignedTo) && !task.assignedTo.includes(currentUser.uid))
                : userTasks.filter(task => Array.isArray(task.assignedTo) && task.assignedTo.includes(currentUser.uid));


            if (filterStatus === 'all' || filterStatus === 'shared') {
                filteredTasks = tasksForFilter;
            } else if (filterStatus === 'pending') {
                filteredTasks = tasksForFilter.filter(task => task.status === 'pending');
            }
             else if (filterStatus === 'inprogress') {
                filteredTasks = tasksForFilter.filter(task => task.status === 'active');
            }
            else if (filterStatus === 'completed') {
                filteredTasks = tasksForFilter.filter(task => task.status === 'completed');
            } else if (filterStatus === 'overdue') {
                filteredTasks = tasksForFilter.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    return (task.status === 'pending' || task.status === 'active') && dueDate < now;
                });
            }

            myTasksListContainerEl.innerHTML = '';

            if (filteredTasks.length === 0) {
                noMyTasksMessageEl.style.display = 'block';
            } else {
                noMyTasksMessageEl.style.display = 'none';
                filteredTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                filteredTasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    
                    const dueDateObj = new Date(task.dueDate);
                    const isOverdue = (task.status === 'pending' || task.status === 'active') && dueDateObj < now;

                    let formattedDueDate = 'N/A';
                    let formattedDueTime = 'N/A';

                    if (task.dueDate && !isNaN(dueDateObj.getTime())) {
                        formattedDueDate = dueDateObj.toLocaleDateString();
                        formattedDueTime = dueDateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    const lockIcon = task.isLocked ? `<i class="fas fa-lock absolute top-4 right-4 text-red-500 text-xl" title="This task is locked and cannot be modified."></i>` : '';
                    const lockStatusClass = task.isLocked ? 'border-l-4 border-red-500 pl-4' : '';

                    let flagIcon = '';
                    if (task.status === 'completed') {
                        flagIcon = `<i class="fas fa-flag flag-green" title="Task Completed ${task.completionStatus === 'late' ? '(Late)' : 'Successfully'}"></i>`;
                    } else if (isOverdue) {
                        flagIcon = '<i class="fas fa-flag flag-red" title="Overdue - Action Required"></i>';
                    }
                    
                    let completeButtonHTML = '';
                    if (task.status === 'active' && !task.isLocked) {
                        if (isOverdue) {
                            completeButtonHTML = `<button class="btn-danger complete-task-my-tasks flex-1" data-id="${task.id}" data-late="true"><i class="fas fa-exclamation-triangle mr-2"></i> Late Complete</button>`;
                        } else {
                            completeButtonHTML = `<button class="btn-success complete-task-my-tasks flex-1" data-id="${task.id}" data-late="false"><i class="fas fa-check-circle mr-2"></i> Complete</button>`;
                        }
                    }
                    
                    let statusTagHTML = '';
                    if (isOverdue && task.status !== 'completed') {
                        statusTagHTML = '<span class="status-tag status-overdue">Overdue</span>';
                    } else {
                        switch (task.status) {
                            case 'completed':
                                statusTagHTML = '<span class="status-tag status-completed">Completed</span>';
                                break;
                            case 'pending':
                                statusTagHTML = '<span class="status-tag status-pending">Pending</span>';
                                break;
                            case 'active':
                                statusTagHTML = '<span class="status-tag status-active">Active</span>';
                                break;
                            default:
                                statusTagHTML = `<span class="font-medium text-gray-600">${task.status}</span>`; // Fallback
                        }
                    }
                    
                    const notesHtml = task.notes && task.notes.length > 0
                        ? `<ul>${task.notes.map((note, index) => `
                            <li class="flex justify-between items-center bg-yellow-50 p-2 rounded-md mb-1">
                                <span>${note}</span>
                                <button class="delete-note-btn" data-task-id="${task.id}" data-note-index="${index}" title="Delete note">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </li>`).join('')}</ul>`
                        : `<p class="text-sm text-gray-500">No notes for this task yet.</p>`;

                    const commentsHtml = task.comments && task.comments.length > 0
                        ? `<div>
                                <h6 class="font-semibold text-gray-700 mb-1 flex items-center"><i class="fas fa-comment-dots mr-2 text-indigo-500"></i>Comments:</h6>
                                <ul>${task.comments.map(comment => `
                                    <li class="text-xs text-gray-600 bg-gray-50 p-2 rounded-md mb-1">
                                        <strong>${comment.by || 'Unknown'}:</strong> ${comment.text} 
                                        <span class="text-gray-400 ml-2">${comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleString() : ''}</span>
                                    </li>`).join('')}</ul>
                            </div>`
                        : `<p class="text-sm text-gray-500">No comments for this task yet.</p>`;

                    // MODIFIED: Display assignedToNames (array of names)
                    const assignedToNamesHtml = task.assignedToNames && task.assignedToNames.length > 0
                        ? `<p class="flex items-center"><i class="fas fa-user-tag mr-2 text-indigo-500"></i> Assigned To: <span class="font-medium text-gray-700">${task.assignedToNames.join(', ')}</span></p>`
                        : '';

                    const collaboratorsHtml = task.collaborators && task.collaborators.length > 0
                        ? `<p class="flex items-center"><i class="fas fa-users mr-2 text-indigo-500"></i> Collaborators: <span class="font-medium text-gray-700">${task.collaborators.map(id => {
                            // Find username from allTasks or a separate user list if available
                            const user = allTasks.find(t => t.assignedTo && t.assignedTo.includes(id)); // This is a hack, should use a dedicated user list
                            return user ? user.assignedToNames.find(name => name) : 'Unknown'; // Find first name if multiple
                        }).filter(name => name).join(', ')}</span></p>`
                        : '';

                    const subtaskHtml = task.isSubtask ? `<p class="flex items-center"><i class="fas fa-code-branch mr-2 text-indigo-500"></i> Subtask: <span class="font-medium text-gray-700">Yes</span></p>` : '';
                    const parentTaskHtml = task.parentTaskId ? `<p class="flex items-center"><i class="fas fa-link mr-2 text-indigo-500"></i> Parent Task ID: <span class="font-medium text-gray-700">${task.parentTaskId}</span></p>` : '';
                    const imageUrlHtml = task.imageUrl ? `<p class="flex items-center"><i class="fas fa-image mr-2 text-indigo-500"></i> Image: <a href="${task.imageUrl}" target="_blank" class="text-blue-500 hover:underline">View Image</a></p>` : '';
                    const relatedLinkHtml = task.relatedLink ? `<p class="flex items-center"><i class="fas fa-external-link-alt mr-2 text-indigo-500"></i> Link: <a href="${task.relatedLink}" target="_blank" class="text-blue-500 hover:underline">Open Link</a></p>` : '';

                    const emailHtml = task.taskSpecificEmail 
                        ? `<p class="flex items-center"><i class="fas fa-envelope mr-2 text-indigo-500"></i> Task Email: <span class="font-medium text-gray-700">${task.taskSpecificEmail}</span></p>`
                        : '';
                     taskCard.innerHTML = `
  <div class="task-header flex justify-between items-center cursor-pointer" onclick="toggleTaskDetails(this)">
    <h3 class="font-semibold text-xl text-gray-800">${task.title}</h3>
    <input type="checkbox" class="h-5 w-5 accent-green-500 rounded-full" ${task.status === 'completed' ? 'checked' : ''}>
  </div>

  <div class="task-details mt-2 pl-2 text-sm text-gray-700 hidden">
    <div class="flex justify-between items-start mb-3 ${lockStatusClass}">
        <div class="flex items-center">
            <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'low'}">${task.priority || 'Low'}</span>
            ${flagIcon}
        </div>
    </div>
    ${lockIcon}
    <p class="text-sm text-gray-600 mb-4">${task.description || 'No description provided.'}</p>
    <div class="text-sm text-gray-500 space-y-1 mb-4">
        <p class="flex items-center"><i class="fas fa-calendar-alt mr-2 text-indigo-500"></i> Due Date: <span class="font-medium text-gray-700">${formattedDueDate}</span></p>
        <p class="flex items-center"><i class="fas fa-clock mr-2 text-indigo-500"></i> Due Time: <span class="font-medium text-gray-700">${formattedDueTime}</span></p>
        <p class="flex items-center"><i class="fas fa-info-circle mr-2 text-indigo-500"></i> Status: ${statusTagHTML}</p>
        <p class="flex items-center"><i class="fas fa-percentage mr-2 text-indigo-500"></i> Progress: <span class="font-medium text-gray-700">${task.progress || 0}%</span></p>
        ${emailHtml}
        <p class="flex items-center"><i class="fas fa-user-edit mr-2 text-indigo-500"></i> Created By: <span class="font-medium text-gray-700">${task.createdBy || 'N/A'}</span></p>
        ${assignedToNamesHtml} <!-- MODIFIED: Display assignedToNames -->
        <p class="flex items-center"><i class="fas fa-code-branch mr-2 text-indigo-500"></i> Type: <span class="font-medium text-gray-700">${task.taskType || 'General'}</span></p>
        <p class="flex items-center"><i class="fas fa-star mr-2 text-indigo-500"></i> Points: <span class="font-medium text-gray-700">${task.points || 0}</span></p>
        ${subtaskHtml}
        ${parentTaskHtml}
        ${collaboratorsHtml}
        ${imageUrlHtml}
        ${relatedLinkHtml}

        <div class="gantt-popup-notes">
            <h6><i class="fas fa-sticky-note mr-2"></i>Notes:</h6>
            ${notesHtml}
            <div class="gantt-popup-add-note mt-2">
                <input type="text" placeholder="Add a new note..." id="myTasksNewNoteInput-${task.id}" class="flex-grow p-2 border rounded-md">
                <button data-task-id="${task.id}" id="addMyTasksNoteBtn-${task.id}" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Add</button>
            </div>
        </div>
        ${commentsHtml}
    </div>
    <div class="task-actions flex flex-wrap gap-2 mt-4">
        ${task.status === 'pending' && !task.isLocked ? `<button class="btn-success confirm-task-my-tasks flex-1" data-id="${task.id}"><i class="fas fa-check mr-2"></i> Confirm</button>` : ''}
        ${completeButtonHTML}
        ${task.status !== 'completed' && !task.isLocked ? `<button class="btn-danger edit-task-my-tasks flex-1" data-id="${task.id}"><i class="fas fa-edit mr-2"></i> Edit</button>` : ''}
    </div>
  </div>
`;

                    
                    myTasksListContainerEl.appendChild(taskCard);
                    
                    const addMyTasksNoteBtn = document.getElementById(`addMyTasksNoteBtn-${task.id}`);
                    if (addMyTasksNoteBtn) {
                        addMyTasksNoteBtn.addEventListener('click', async () => {
                            const newNoteInput = document.getElementById(`myTasksNewNoteInput-${task.id}`);
                            const newNoteText = newNoteInput.value.trim();
                            if (newNoteText && currentUser) {
                                try {
                                    await updateDoc(doc(db, 'forms', task.id), {
                                        notes: arrayUnion(newNoteText)
                                    });
                                    newNoteInput.value = '';
                                    showCustomAlert("Note Added", "Note successfully added to task!");
                                } catch (error) {
                                    console.error("Error adding note:", error);
                                    showCustomAlert("Error", "Failed to add note: " + error.message);
                                }
                            } else if (!currentUser) {
                                showCustomAlert("Error", "You must be logged in to add notes.");
                            }
                        });
                    }
                });
                setupMyTasksEventListeners();
            }
        }

        // Setup event listeners for the buttons within "My Tasks" view
        function setupMyTasksEventListeners() {
            document.querySelectorAll('.delete-note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const taskId = button.dataset.taskId;
                    const noteIndex = parseInt(button.dataset.noteIndex, 10);
                    // Use custom alert instead of confirm
                    showCustomAlert("Confirm Delete", "Are you sure you want to delete this note?", () => {
                        handleDeleteNote(taskId, noteIndex);
                    }, true); // Pass true to indicate it's a confirmation
                });
            });

            document.querySelectorAll('.confirm-task-my-tasks').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { status: 'active' });
                        showCustomAlert("Task Confirmed", "Task status updated to Active!");
                    } catch (error) {
                        console.error("Error confirming task:", error);
                        showCustomAlert("Error", "Failed to confirm task: " + error.message);
                    }
                });
            });

            document.querySelectorAll('.complete-task-my-tasks').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    const isLate = btn.dataset.late === 'true';
                    try {
                        const updateData = {
                            status: 'completed',
                            completedAt: serverTimestamp(),
                            completionStatus: isLate ? 'late' : 'on_time'
                        };
                        await updateDoc(doc(db, 'forms', taskId), updateData);
                        if (rangBellForTasks.has(taskId)) {
                            rangBellForTasks.delete(taskId);
                        }
                        showCustomAlert("Task Completed", "Task marked as " + (isLate ? 'Late Complete' : 'Completed') + "!");
                    } catch (error) {
                        console.error("Error completing task:", error);
                        showCustomAlert("Error", "Failed to complete task: " + error.message);
                    }
                });
            });

            document.querySelectorAll('.edit-task-my-tasks').forEach(btn => {
                btn.addEventListener('click', () => {
                    const taskId = btn.dataset.id;
                    showCustomAlert("Edit Task", `Editing task with ID: ${taskId}. (Functionality to be implemented)`);
                });
            });
        }

        // Check for overdue tasks and play bell sound
        function checkOverdueTasksAndRingBell() {
            const now = new Date();
            const overdueTasks = userTasks.filter(task => {
                if (task.status === 'pending' || task.status === 'active') {
                    const dueDate = new Date(task.dueDate);
                    const overdueBy30Min = dueDate.getTime() + (30 * 60 * 1000); // 30 minutes grace period
                    return now.getTime() > overdueBy30Min;
                }
                return false;
            });

            overdueTasks.forEach(task => {
                if (!rangBellForTasks.has(task.id)) {
                    playBellSound();
                    rangBellForTasks.add(task.id);
                    console.log(`Bell rang for overdue task: ${task.title} (ID: ${task.id})`);
                }
            });
        }

        // Play bell sound
        function playBellSound() {
            if (bellSound) {
                bellSound.play().catch(error => {
                    console.warn("Could not play bell sound:", error);
                });
                // Temporarily disable the sound to prevent rapid firing
                bellSound.volume = 0.1; // Reduce volume
                setTimeout(() => {
                    bellSound.volume = 1.0; // Restore volume after a short delay
                }, 5000); // Wait 5 seconds before allowing full volume again
            }
        }

        // Refresh dashboard data
        function refreshDashboard() {
            updateUserSpecificUI();
            updateGlobalUI();
            showCustomAlert("Refreshed", "Dashboard data has been refreshed!");
        }

        // Setup dark mode toggle
        function setupDarkModeToggle() {
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            const currentTheme = localStorage.getItem('theme');
            
            if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
                document.body.classList.add('dark');
                darkModeToggle.checked = true;
            }
            
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.body.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        // Clean up on logout
        function cleanupOnLogout() {
            if (unsubscribeUserTasks) unsubscribeUserTasks();
            if (unsubscribeAllTasks) unsubscribeAllTasks();
            if (unsubscribeUser) unsubscribeUser();
            
            userTasks = [];
            allTasks = [];
            updateUserSpecificUI();
            updateGlobalUI();
            
            if (overdueCheckInterval) {
                clearInterval(overdueCheckInterval);
                overdueCheckInterval = null;
            }
            
            document.getElementById("usernameDisplay").textContent = "User";
            document.getElementById("dashboardGreeting").innerHTML = `<i class="fas fa-hand-sparkles mr-3"></i> Welcome, <span id="usernameDisplay">User</span>!`;
        }

        // Update current date display
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dashboardDate').textContent = now.toLocaleDateString('en-US', options);
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDate();
            initApp();
        });

        // Update date every minute
        setInterval(updateCurrentDate, 60000);
    </script>
    <script>
// This script block is for the timer and checklist on the main "Add New Task" page.
// It's important that `timerInterval` and `secondsElapsed` are unique to this context
// or managed globally if the same timer is used across multiple sections.
// Given the previous error, I will ensure these are locally scoped if possible,
// or clearly distinguished from the `assignTaskTimerInterval` in the main module.

// For simplicity and to avoid conflicts, I'm making these local to this script block.
// The main "Assign Task from Chat" page has its own `assignTaskTimerInterval`.
let localTimerInterval = null;
let localSecondsElapsed = 0;

document.getElementById("startTimerBtn")?.addEventListener("click", () => {
  clearInterval(localTimerInterval);
  localSecondsElapsed = 0;
  updateLocalTimerDisplay();

  localTimerInterval = setInterval(() => {
    localSecondsElapsed++;
    updateLocalTimerDisplay();
  }, 1000);
});

function updateLocalTimerDisplay() {
  const hrs = String(Math.floor(localSecondsElapsed / 3600)).padStart(2, '0');
  const mins = String(Math.floor((localSecondsElapsed % 3600) / 60)).padStart(2, '0');
  const secs = String(localSecondsElapsed % 60).padStart(2, '0');
  document.getElementById("liveTimerDisplay").textContent = `${hrs}:${mins}:${secs}`;
}

document.getElementById("addChecklistBtn")?.addEventListener("click", () => {
  const input = document.getElementById("checklistInput");
  const value = input.value.trim();
  if (value) {
    const li = document.createElement("li");
    li.innerHTML = `<input type="checkbox" class="mr-2">${value} <button class="ml-2 text-red-600 text-sm remove-item">×</button>`;
    document.getElementById("checklistItems").appendChild(li);
    input.value = '';
  }
});

document.getElementById("checklistItems")?.addEventListener("click", (e) => {
  if (e.target.classList.contains("remove-item")) {
    e.target.closest("li").remove();
  }
});

</script>
<script>
  function toggleTaskDetails(headerElement) {
    const details = headerElement.nextElementSibling;
    if (details) {
      details.classList.toggle('hidden');
    }
  }
</script>
</body>
</html>
