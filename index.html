<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager Pro - User Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- jQuery Gantt plugin CSS & JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.gantt/1.2.1/css/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-gantt/1.2.1/js/jquery.fn.gantt.js"></script>

    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styles for the dashboard */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            background-color: #f8f9fa;
        }
        .sidebar {
            width: 250px;
            background-color: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #374151;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            height: 100vh;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: .5rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: .5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            padding: .75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-pills {
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .nav-btn {
            background: none;
            border: none;
            color: #d1d5db;
            text-align: left;
            padding: 1rem;
            width: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active, .nav-btn:hover {
            background-color: #374151;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto; /* Allow scrolling for modal content */
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Fix for button and tag text visibility */
        .btn-success {
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px; /* Add some space between buttons */
            transition: background-color 0.2s ease-in-out;
        }
        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545; /* Red */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        .priority-tag {
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-low {
            background-color: #17a2b8; /* Teal */
        }

        .priority-medium {
            background-color: #ffc107; /* Yellow */
            color: #212529; /* Dark text for yellow bg */
        }

        .priority-high {
            background-color: #dc3545; /* Red */
        }

        /* Custom Alert Modal styles */
        .custom-alert-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .custom-alert-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }

        .custom-alert-content h3 {
            margin-top: 0;
            color: #333;
        }

        .custom-alert-content p {
            margin-bottom: 20px;
            color: #555;
        }

        .custom-alert-content button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .custom-alert-content button:hover {
            background-color: #45a049;
        }

        /* My Tasks Overview Section specific styles */
        
    .tasks-list-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem 0;
    }

    .task-card {
        min-width: 300px;
        flex: 0 0 auto;
        scroll-snap-align: start;
    }

        .task-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Stronger shadow */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative; /* For lock icon positioning */
            overflow: hidden; /* Ensure rounded corners clip children */
            border: 1px solid #e2e8f0; /* Subtle border */
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12); /* Even stronger shadow on hover */
        }

        .task-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.25rem; /* Larger title */
        }

        .task-card p {
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .task-actions button {
            padding: 0.6rem 1rem; /* Adjust button padding */
            font-size: 0.9rem;
        }

        .priority-tag {
            /* Keep existing priority styles */
            padding: 6px 10px; /* Slightly larger padding */
            font-size: 0.9em;
        }
        
        .task-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .task-filter-btn {
            background-color: #e2e8f0;
            color: #475569;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .task-filter-btn.active, .task-filter-btn:hover {
            background-color: #4f46e5;
            color: white;
        }

        /* Dashboard specific styles */
        .dashboard-header-welcome {
            background: linear-gradient(to right, #4f46e5, #6366f1);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .dashboard-header-welcome h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .dashboard-header-welcome p {
            font-size: 1.125rem;
            opacity: 0.9;
        }
        .stat-card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            transition: transform 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4f46e5;
            margin-top: 0.5rem;
        }
        .stat-card .label {
            font-size: 1rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .stat-card i {
            font-size: 1.8rem;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 99;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                padding-top: 70px; /* Space for fixed sidebar/header */
            }
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                background-color: #4f46e5;
                color: white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
        }
        .mobile-menu-btn {
            display: none; /* Hidden by default for desktop */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* New CSS for Flags */
        .flag {
            font-size: 1.2em; /* Slightly larger for visibility */
            margin-left: 8px; /* Space from other elements */
        }
        .flag-red {
            color: #ef4444; /* Tailwind red-500 */
        }
        .flag-green {
            color: #10b981; /* Tailwind emerald-500 */
        }

        /* NEW DASHBOARD STYLES */
        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            padding: 1.5rem;
            transition: all 0.2s ease;
        }
        
        .dashboard-widget:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.12);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .widget-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .widget-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .widget-action-btn {
            display: flex;
            gap: 0.5rem;
        }
        
        .widget-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .widget-action-btn:hover {
            color: #4f46e5;
        }
        
        .task-progress {
            margin-top: 1rem;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4f46e5;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .recent-tasks-list {
            margin-top: 1rem;
        }
        
        .recent-task-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .recent-task-item:last-child {
            border-bottom: none;
        }
        
        .recent-task-checkbox {
            margin-right: 0.75rem;
            cursor: pointer;
        }
        
        .recent-task-content {
            flex-grow: 1;
        }
        
        .recent-task-title {
            font-weight: 500;
            color: #374151;
        }
        
        .recent-task-due {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .recent-task-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .empty-dashboard-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .empty-dashboard-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background-color: #f3f4f6;
            transform: translateY(-2px);
        }
        
        .quick-action-icon {
            font-size: 1.5rem;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }
        
        .quick-action-label {
            font-size: 0.875rem;
            color: #374151;
        }
        
        /* Drag and drop styles */
        .draggable-task {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .draggable-task.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }
        
        .dropzone.active {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .dropzone-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* Achievement badges */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: #374151;
        }
        
        .achievement-badge i {
            margin-right: 0.25rem;
            color: #f59e0b;
        }
        
        /* Sparkline chart container */
        .sparkline-container {
            height: 60px;
            margin-top: 1rem;
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 0.5rem;
        }
        
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        input:checked + .theme-slider {
            background-color: #4f46e5;
        }
        
        input:checked + .theme-slider:before {
            transform: translateX(26px);
        }
        
        /* MODIFIED: Chat-to-Task System Styles for Sparkle Background */
        .chat-container {
            position: relative; /* Needed for positioning the canvas */
            display: flex;
            flex-direction: column;
            height: calc(100vh - 8rem);
            background-color: #000; /* Dark background for sparkles */
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        #sparkleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Behind other content */
        }
        .chat-header, .chat-messages, .chat-input-area {
            position: relative;
            z-index: 1; /* In front of the canvas */
            background-color: transparent; /* Make sections see-through */
        }
        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #374151; /* Darker border for contrast */
            font-weight: 600;
            color: #f1f5f9; /* Lighter text color */
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-message {
            display: flex;
            gap: 0.75rem;
            max-width: 75%;
        }
        .chat-message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #374151;
        }
        .message-content {
            display: flex;
            flex-direction: column;
        }
        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #94a3b8; /* Lighter sender color */
        }
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background-color: rgba(30, 41, 59, 0.8); /* Semi-transparent dark bubble */
            color: #e2e8f0;
            cursor: pointer;
            position: relative;
            backdrop-filter: blur(2px); /* Frosted glass effect */
        }
        .message-bubble:hover {
            background-color: rgba(51, 65, 85, 0.8);
        }
        .message-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        .chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .chat-message.sent .message-bubble {
            background-color: rgba(79, 70, 229, 0.8); /* Semi-transparent accent color bubble */
            color: white;
        }
        .chat-message.sent .message-sender, .chat-message.sent .message-time {
            text-align: right;
        }

        .chat-input-area {
            padding: 1.5rem;
            border-top: 1px solid #374151; /* Darker border */
        }
        .chat-input-form {
            display: flex;
            gap: 0.75rem;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #4b5563;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .chat-input::placeholder {
            color: #64748b;
        }
        .chat-send-btn {
            padding: 0.75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .chat-send-btn:hover {
            background-color: #4338ca;
        }

        /* Message Context Menu */
        #messageContextMenu {
            display: none;
            position: absolute;
            z-index: 1001;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 0.5rem 0;
            min-width: 180px;
        }
        .context-menu-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            color: #374151;
            font-size: 0.9rem;
        }
        .context-menu-btn:hover {
            background-color: #f1f5f9;
        }

        /* Status tags */
        .status-tag {
            padding: 4px 12px;
            border-radius: 9999px; /* pill shape */
            font-size: 0.8em;
            font-weight: 600;
            text-transform: capitalize;
            display: inline-block;
        }
        .status-completed {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
        }
        .status-pending {
            background-color: #fef3c7; /* Tailwind yellow-100 */
            color: #92400e; /* Tailwind yellow-800 */
        }
        .status-active {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            color: #4b5563; /* Tailwind gray-600 */
        }
        .status-overdue {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
        }
        
        /* --- GANTT CHART STYLES --- */
        .gantt-container {
            overflow-x: auto;
        }
        .gantt {
            width: 100%;
        }
        .gantt .bar .bar-inner {
            border-radius: 3px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .gantt .bar .bar-inner:hover {
            opacity: 1;
        }
        .gantt .bar-label {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 5px;
        }
        /* Custom colors for task bars */
        .ganttRed .bar-inner {
            background-color: #ef4444; /* Red for High Priority/Overdue */
        }
        .ganttOrange .bar-inner {
            background-color: #f97316; /* Orange for Medium Priority */
        }
        .ganttGreen .bar-inner {
            background-color: #22c55e; /* Green for Completed */
        }
        .ganttBlue .bar-inner {
            background-color: #3b82f6; /* Blue for Low Priority */
        }
        .ganttGray .bar-inner {
             background-color: #6b7280; /* Gray for other statuses */
        }

    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="text-2xl font-bold mb-4"><i class="fas fa-rocket text-indigo-300 mr-2"></i> Task Manager</h1>
            <div class="user-info text-gray-300">
                <p class="text-sm">Logged in as:</p>
                <div class="user-details flex items-center mt-2">
                    <img id="userAvatar" src="https://placehold.co/40x40/6366f1/ffffff?text=U" alt="User Avatar" class="rounded-full mr-3 border-2 border-indigo-300">
                    <div>
                        <div id="usernameDisplay" class="font-semibold text-lg text-white">User</div>
                        <div class="user-role text-sm text-indigo-200" id="userRoleDisplay">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-pills flex-grow" id="mainNav">
            <button class="nav-btn" id="adminBtn"><i class="fas fa-user-shield"></i><span>Admin</span></button>
            <button class="nav-btn" data-section="dashboardSection"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></button>
            <button class="nav-btn" data-section="chatSection"><i class="fas fa-comments"></i><span>Chat</span></button>
            <button class="nav-btn" data-section="ganttChartSection">
                <i class="fas fa-project-diagram"></i>
                <span>Gantt Chart</span>
            </button>
            <button class="nav-btn" data-section="calendarSection"><i class="fas fa-calendar-week"></i><span>Calendar View</span></button>
            <button class="nav-btn" data-section="myTasksOverviewSection"><i class="fas fa-list-check"></i><span>My Tasks</span></button>
            <button class="nav-btn" data-section="taskNameSection"><i class="fas fa-plus-circle"></i><span>Add Task</span></button>
            <button class="nav-btn" data-section="confirmTaskSection"><i class="fas fa-tasks"></i><span>Confirm Tasks <span class="notification-badge bg-red-500 text-white rounded-full px-2 py-1 text-xs ml-2" id="pendingBadge">0</span></span></button>
            <button class="nav-btn" data-section="markCompleteSection"><i class="fas fa-check-double"></i><span>Active Tasks <span class="notification-badge bg-blue-500 text-white rounded-full px-2 py-1 text-xs ml-2" id="activeBadge">0</span></span></button>
            <button class="nav-btn" data-section="taskPointSection"><i class="fas fa-award"></i><span>Assign Points</span></button>
            <button class="nav-btn" data-section="addCommentSection"><i class="fas fa-comments"></i><span>Add Comment</span></button>
            <button class="nav-btn" data-section="leaveSection"><i class="fas fa-calendar-alt"></i><span>Record Leave</span></button>
            <button class="nav-btn" data-section="showAllSection"><i class="fas fa-archive"></i><span>All Data</span></button>
            <button class="nav-btn" id="inboxBtnTrigger"><i class="fas fa-inbox"></i><span>Inbox <span class="notification-badge bg-yellow-500 text-white rounded-full px-2 py-1 text-xs ml-2" id="inboxBadgeDisplay">0</span></span></button>
            <button class="nav-btn" data-section="saveCSVSection"><i class="fas fa-file-csv"></i><span>Export Data</span></button>
            <button class="nav-btn" onclick="window.location.href='Toggle.html'">
              <i class="fas fa-toggle-on"></i>
              <span>Work Status</span>
            </button>

            <!-- Logout Button -->
            <button class="nav-btn" id="logoutButton">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Enhanced Dashboard Section -->
        <section id="dashboardSection" class="section active">
            <div class="dashboard-header-welcome">
               <h2 id="dashboardGreeting" class="font-bold text-3xl mb-1 flex items-center">
                  <i class="fas fa-hand-sparkles mr-3"></i> Welcome, <span id="usernameDisplay">User</span>!
                </h2>
                <p id="dashboardDate" class="current-date text-lg opacity-90"></p>
                <div class="flex items-center mt-2">
                    <span id="userPerformanceTag" class="inline-block px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">Loading performance...</span>
                    <label class="theme-toggle ml-auto">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="theme-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-clipboard-list text-indigo-600"></i>
                    <div class="value" id="totalTasks">0</div>
                    <div class="label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <div class="value" id="completedTasks">0</div>
                    <div class="label">Completed Tasks</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-hourglass-half text-yellow-500"></i>
                    <div class="value" id="pendingTasks">0</div>
                    <div class="label">Pending Tasks</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star text-purple-500"></i>
                    <div class="value" id="totalPoints">0</div>
                    <div class="label">Total Points Earned</div>
                </div>
            </div>
            
            <div class="dashboard-widgets">
                <!-- Task Progress Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-tasks text-indigo-500"></i> Task Progress</h3>
                        <div class="widget-actions">
                            <button class="widget-action-btn" id="refreshProgress"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div class="task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="taskProgressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="completedCount">0 completed</span>
                            <span id="totalCount">0 total</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Tasks Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-clock text-blue-500"></i> Recent Tasks</h3>
                        <div class="widget-actions">
                            <button class="widget-action-btn" id="viewAllTasks"><i class="fas fa-ellipsis-h"></i></button>
                        </div>
                    </div>
                    <div class="recent-tasks-list" id="recentTasksList">
                        <div class="empty-dashboard-message">
                            <i class="fas fa-tasks"></i>
                            <p>No recent tasks found</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-bolt text-yellow-500"></i> Quick Actions</h3>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action-btn" id="quickAddTask">
                            <i class="fas fa-plus quick-action-icon"></i>
                            <span class="quick-action-label">Add Task</span>
                        </button>
                        <button class="quick-action-btn" id="quickCompleteTask">
                            <i class="fas fa-check quick-action-icon"></i>
                            <span class="quick-action-label">Complete</span>
                        </button>
                        <button class="quick-action-btn" id="quickCalendar">
                            <i class="fas fa-calendar quick-action-icon"></i>
                            <span class="quick-action-label">Calendar</span>
                        </button>
                        <button class="quick-action-btn" id="quickExport">
                            <i class="fas fa-file-export quick-action-icon"></i>
                            <span class="quick-action-label">Export</span>
                        </button>
                    </div>
                </div>
                
                <!-- Performance Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title"><i class="fas fa-chart-line text-green-500"></i> Performance</h3>
                    </div>
                    <div id="performanceSparkline" class="sparkline-container">
                        <!-- Sparkline chart will be rendered here -->
                    </div>
                    <div id="achievementBadges" class="mt-2">
                        <!-- Achievement badges will appear here -->
                    </div>
                </div>
            </div>
            
            <section id="adminSection" class="section">
              <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-user-shield mr-3 text-red-600"></i> Admin Dashboard</h2>
              <p class="text-lg text-gray-700">Welcome, Admin. Use this dashboard to manage system-wide settings and users.</p>
            </section>
        </section>

        <!-- Chat-to-Task System Section -->
        <section id="chatSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-comments mr-3 text-indigo-500"></i> Chat-to-Task System
            </h2>
            <div class="chat-container">
                <canvas id="sparkleCanvas"></canvas> <!-- Sparkle background canvas -->
                <div class="chat-header">Team Discussion</div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be dynamically inserted here -->
                </div>
                <div class="chat-input-area">
                    <form id="chatInputForm" class="chat-input-form">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." autocomplete="off">
                        <button type="submit" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- Gantt Chart Section -->
        <section id="ganttChartSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-project-diagram mr-3 text-blue-600"></i> Project Gantt Chart
            </h2>
            <div class="gantt-container bg-white p-6 rounded-lg shadow-lg">
                <div class="gantt"></div>
            </div>
        </section>

        <!-- Calendar Section -->
        <section id="calendarSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-calendar-alt mr-3 text-orange-600"></i> Task Calendar</h2>
            <div id="calendar" class="bg-white p-6 rounded-lg shadow-lg"></div>
        </section>

        <section id="myTasksOverviewSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-list-check mr-3 text-teal-600"></i> My Tasks Overview</h2>
            <div class="task-filters flex flex-wrap gap-3 mb-6 p-2 bg-gray-100 rounded-lg shadow-sm">
                <button class="task-filter-btn active" data-filter="all">All</button>
                <button class="task-filter-btn" data-filter="pending">Pending</button>
                <button class="task-filter-btn" data-filter="inprogress">In Progress</button>
                <button class="task-filter-btn" data-filter="completed">Completed</button>
                <button class="task-filter-btn" data-filter="overdue">Overdue</button>
                <button class="task-filter-btn" data-filter="shared">Shared</button>
            </div>
            <div id="myTasksListContainer" class="tasks-list-grid">
                <div id="myTasksListContainer" class="space-y-3">
                  <!-- Sample Task Item -->
                  <div class="task-card bg-gray-800 text-white rounded-lg px-4 py-3 shadow-sm">
                  <!-- Task Header -->
                  <div class="flex items-center justify-between cursor-pointer" onclick="toggleTaskDetails(this)">
                    <span class="text-base font-medium">Seo bhi karana hai</span>
                    <input type="checkbox" class="h-5 w-5 accent-green-500 rounded-full">
                  </div>
                
                  <!-- Task Details (Initially Hidden) -->
                  <div class="task-details mt-2 pl-2 text-sm text-gray-300 hidden">
                    <p><strong>Description:</strong> Work on optimizing keywords and meta tags.</p>
                    <p><strong>Priority:</strong> Medium</p>
                    <p><strong>Due:</strong> 2025-07-03</p>
                  </div>
                </div>
                
                </div>

                <!-- Tasks will be rendered here by JS -->
            </div>
            <p id="noMyTasksMessage" class="hidden text-center mt-8 text-gray-500 italic text-lg">No tasks match the current filter.</p>
        </section>

        <section id="taskNameSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-plus-circle mr-3 text-green-600"></i> Add New Task</h2>
            <form id="addTaskForm" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="taskName" class="block text-gray-700 font-medium mb-1">Task Name:</label><input type="text" id="taskName" required placeholder="e.g., Prepare monthly report" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="form-group"><label for="taskDescription" class="block text-gray-700 font-medium mb-1">Task Description:</label><textarea id="taskDescription" rows="3" placeholder="Provide details about the task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                <div class="form-group"><label for="taskPriority" class="block text-gray-700 font-medium mb-1">Priority:</label><select id="taskPriority" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div>
                <div class="form-group">
                    <label for="taskPoints" class="block text-gray-700 font-medium mb-1">Points:</label>
                    <select id="taskPoints" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="30">30</option>
                        <option value="50">50</option>
                        <option value="80">80</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="form-group"><label for="taskDate" class="block text-gray-700 font-medium mb-1">Due Date:</label><input type="date" id="taskDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="form-group"><label for="taskTime" class="block text-gray-700 font-medium mb-1">Due Time:</label><input type="time" id="taskTime" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                
                <div class="form-group">
                  <label for="taskType" class="block text-gray-700 font-medium mb-1">Task Type:</label>
                  <select id="taskType" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Select Task Type --</option>
                    <option value="Audit">Audit – Check systems</option>
                    <option value="Deploy">Deploy – Push updates</option>
                    <option value="Mentor">Mentor – Guide junior dev</option>
                    <option value="Fix">Fix – Bug fix</option>
                    <option value="Test">Test – Manual/Auto test</option>
                    <option value="Design">Design – UI/UX work</option>
                    <option value="Write">Write – Docs or content</option>
                    <option value="Optimize">Optimize – Performance/SEO</option>
                    <option value="Integrate">Integrate – API/Plugin</option>
                    <option value="Review">Review – Code/content check</option>
                  </select>
                </div>
                <button type="submit" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-save mr-2"></i>Add Task</button>
            </form>
        </section>

        <section id="confirmTaskSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-tasks mr-3 text-purple-600"></i> Confirm Pending Tasks</h2>
            <div id="pendingTasksContainer" class="bg-white p-6 rounded-lg shadow-lg"><h3>Tasks Awaiting Confirmation</h3><table id="pendingTasksTable" class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th></tr></thead><tbody id="pendingTasksList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </section>

        <section id="markCompleteSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-check-double mr-3 text-blue-600"></i> Manage Active Tasks</h2>
            <div id="activeTasksContainer" class="bg-white p-6 rounded-lg shadow-lg"><h3>Currently Active Tasks</h3><table id="activeTasksTable" class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mark Complete</th></tr></thead><tbody id="activeTasksList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </section>

        <section id="taskPointSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-award mr-3 text-yellow-600"></i> Assign Points to Completed Tasks</h2>
            <div id="completedTasksContainer" class="bg-white p-6 rounded-lg shadow-lg"><h3>Completed Tasks Log</h3><table id="completedTasksTable" class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Points</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assign Points</th></tr></thead><tbody id="completedTasksList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </section>

        <section id="addCommentSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-comments mr-3 text-pink-600"></i> Add Comment to Task</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="taskSelect" class="block text-gray-700 font-medium mb-1">Select Task:</label><select id="taskSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="">-- Select a Task --</option></select></div>
                <div class="form-group"><label for="commentText" class="block text-gray-700 font-medium mb-1">Comment:</label><textarea id="commentText" rows="3" required placeholder="Enter your comment" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                <button id="addCommentBtn" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-paper-plane mr-2"></i>Add Comment</button>
            </div>
        </section>

        <section id="leaveSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-calendar-alt mr-3 text-red-600"></i> Record Leave</h2>
            <form id="leaveForm" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="leaveDate" class="block text-gray-700 font-medium mb-1">Leave Date:</label><input type="date" id="leaveDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="form-group"><label for="leaveReason" class="block text-gray-700 font-medium mb-1">Reason for Leave:</label><textarea id="leaveReason" rows="3" required placeholder="Enter leave reason" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                <div class="form-group"><label for="leaveType" class="block text-gray-700 font-medium mb-1">Leave Type:</label><select id="leaveType" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="Informed">Informed</option><option value="Uninformed">Uninformed</option><option value="1st Half Leave">1st Half Leave</option><option value="2nd Half Leave">2d Half Leave</option><option value="Emergency Leave">Emergency Leave</option></select></div>
                <button type="submit" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-calendar-check mr-2"></i>Submit Leave Request</button>
            </form>
        </section>

        <section id="showAllSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-archive mr-3 text-gray-600"></i> View All Recorded Data</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="dataTypeSelect" class="block text-gray-700 font-medium mb-1">Select Data Type to View:</label><select id="dataTypeSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="tasks">Tasks</option><option value="leaves">Leaves</option></select></div>
                <div id="allDataContainer" class="mt-4"><table id="allDataTable" class="min-w-full divide-y divide-gray-200"><thead id="allDataHeader" class="bg-gray-50"></thead><tbody id="allDataBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </div>
        </section>

        <section id="saveCSVSection" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-file-csv mr-3 text-green-700"></i> Export Data to CSV</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="form-group"><label for="csvDataType" class="block text-gray-700 font-medium mb-1">Select Data to Export:</label><select id="csvDataType" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><option value="tasks">Tasks</option><option value="leaves">Leaves</option><option value="all">All Data (Combined)</option></select></div>
                <button id="exportCSVBtn" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200"><i class="fas fa-download mr-2"></i>Export to CSV</button>
            </div>
        </section>
    </div>

    <!-- Inbox Modal -->
    <div id="inboxModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeInboxModalBtn">×</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-envelope-open-text mr-3 text-indigo-500"></i> Inbox Notifications</h2>
            <div id="inboxMessages" class="text-gray-700">
                <p class="empty-inbox-msg">Your inbox is currently empty.</p>
            </div>
        </div>
    </div>
    
    <!-- Mark as Task Modal -->
    <div id="markAsTaskModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeMarkAsTaskModalBtn">×</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Create Task from Message</h2>
            <form id="markAsTaskForm">
                <div class="form-group">
                    <label for="markAsTaskTitle" class="block text-gray-700 font-medium mb-1">Title:</label>
                    <textarea id="markAsTaskTitle" required rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <!-- Task Points -->
                <div class="form-group">
                  <label for="markAsTaskPoints" class="block text-gray-700 font-medium mb-1">Points:</label>
                  <select id="markAsTaskPoints" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="80">80</option>
                    <option value="100">100</option>
                  </select>
                </div>

                <!-- Subtask Checkbox -->
                <div class="form-group flex items-center">
                    <input type="checkbox" id="markAsTaskIsSubtask" class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <label for="markAsTaskIsSubtask" class="text-gray-700 font-medium">Is this a subtask?</label>
                </div>

                <!-- Priority Options -->
                <div class="form-group">
                    <label for="markAsTaskPriority" class="block text-gray-700 font-medium mb-1">Priority:</label>
                    <select id="markAsTaskPriority" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="markAsTaskAssignTo" class="block text-gray-700 font-medium mb-1">Assign To:</label>
                    <select id="markAsTaskAssignTo" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                
                <!-- Collaborations -->
                <div class="form-group">
                    <label for="markAsTaskCollaborators" class="block text-gray-700 font-medium mb-1">Collaborators (select multiple):</label>
                    <select id="markAsTaskCollaborators" multiple class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 h-24">
                        <!-- Users will be populated here, including 'Self' option -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="markAsTaskStartDate" class="block text-gray-700 font-medium mb-1">Start Date:</label>
                    <input type="date" id="markAsTaskStartDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>


                <div class="form-group">
                    <label for="markAsTaskDate" class="block text-gray-700 font-medium mb-1">Due Date:</label>
                    <input type="date" id="markAsTaskDate" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="form-group">
                  <label for="markAsTaskReminder" class="block text-gray-700 font-medium mb-1">
                    Reminder (e.g., 1 day, 2 hours):
                  </label>
                  <input type="text" id="markAsTaskReminder" placeholder="e.g., 1 day, 2 hours" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                

                <div class="form-group">
                    <label for="markAsTaskEmail" class="block text-gray-700 font-medium mb-1">Task-Specific Email ID:</label>
                    <input type="email" id="markAsTaskEmail" placeholder="Enter an email for this task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Upload Image -->
                <div class="form-group">
                    <label for="markAsTaskImageUpload" class="block text-gray-700 font-medium mb-1">Upload Image:</label>
                    <input type="file" id="markAsTaskImageUpload" accept="image/*" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Add Comments -->
                <div class="form-group">
                    <label for="markAsTaskComments" class="block text-gray-700 font-medium mb-1">Comments:</label>
                    <textarea id="markAsTaskComments" rows="3" placeholder="Add initial comments for this task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- Add Link -->
                <div class="form-group">
                    <label for="markAsTaskLink" class="block text-gray-700 font-medium mb-1">Related Link:</label>
                    <input type="url" id="markAsTaskLink" placeholder="e.g., https://example.com/related-doc" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Parent Task ID -->
                <div class="form-group">
                    <label for="markAsTaskParentId" class="block text-gray-700 font-medium mb-1">Parent Task ID (if subtask):</label>
                    <input type="text" id="markAsTaskParentId" placeholder="Enter ID of parent task" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="form-group">
                    <label for="markAsTaskAddTo" class="block text-gray-700 font-medium mb-1">Add to:</label>
                    <select id="markAsTaskAddTo" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="personal">Personal Task List</option>
                        <option value="note">Sticky Note</option>
                        <option value="gantt">Gantt Chart</option> <!-- Added Gantt Chart option -->
                    </select>
                </div>
                <!-- ⏱️ Timer and Checklist Section -->
                <hr class="my-4">

                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">Start Timer:</label>
                  <button type="button" id="startTimerBtn" class="w-full py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    <i class="fas fa-play mr-2"></i>Start Timer
                  </button>
                  <div id="liveTimerDisplay" class="mt-2 text-lg font-bold text-indigo-700">00:00:00</div>
                </div>
                
                <div class="form-group mt-4">
                  <label for="checklistInput" class="block text-gray-700 font-medium mb-1">Checklist:</label>
                  <div class="flex gap-2 mb-2">
                    <input type="text" id="checklistInput" placeholder="Add checklist item" class="flex-grow p-2 border border-gray-300 rounded">
                    <button type="button" id="addChecklistBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Add</button>
                  </div>
                  <ul id="checklistItems" class="list-disc pl-5 text-gray-800 space-y-1">
                    <!-- checklist items go here -->
                  </ul>
                </div>

                <button type="submit" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">Create Task</button>
            </form>
        </div>
    </div>


    <!-- Custom Alert Modal (for "Task added successfully!") -->
    <div id="customAlertModal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <h3 id="customAlertTitle" class="text-xl font-semibold mb-2"></h3>
            <p id="customAlertMessage" class="text-gray-700 mb-4"></p>
            <button id="customAlertCloseBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-200">OK</button>
        </div>
    </div>

    <!-- Message Context Menu -->
    <div id="messageContextMenu">
        <button id="contextMenuMarkAsTaskBtn" class="context-menu-btn">
            <i class="fas fa-check-square"></i> Mark as Task
        </button>
        <button id="contextMenuReplyBtn" class="context-menu-btn">
            <i class="fas fa-reply"></i> Reply
        </button>
        <button id="contextMenuShareBtn" class="context-menu-btn">
            <i class="fas fa-share"></i> Share
        </button>
    </div>

    <!-- Audio element for bell sound -->
    <audio id="bellSound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-ringing-1237.mp3" preload="auto"></audio>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <!-- Sparkline chart library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="firebase-login-toggle.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            serverTimestamp, 
            query, 
            where, 
            getDocs, 
            updateDoc, 
            doc, 
            getDoc,
            onSnapshot,
            arrayUnion // Import arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYF8V_BDf34UjEYAyDLLFs9cgb7IEjO7I",
            authDomain: "taskmanager-b93e4.firebaseapp.com",
            projectId: "taskmanager-b93e4",
            storageBucket: "taskmanager-b93e4.firebasestorage.app",
            messagingSenderId: "613129920368",
            appId: "1:613129920368:web:6077e6ae85031c29f4b9b5",
            measurementId: "G-W5C4YSJSDZ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: Sparkle Animation ---
        const sparkleCanvas = document.getElementById('sparkleCanvas');
        const sparkleCtx = sparkleCanvas.getContext('2d');
        let particles = [];
        let animationFrameId;

        function resizeCanvas() {
            sparkleCanvas.width = sparkleCanvas.offsetWidth;
            sparkleCanvas.height = sparkleCanvas.offsetHeight;
        }

        function createParticles() {
            particles = [];
            const particleCount = Math.floor((sparkleCanvas.width * sparkleCanvas.height) / 5000);
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * sparkleCanvas.width,
                    y: Math.random() * sparkleCanvas.height,
                    vx: Math.random() * 0.4 - 0.2,
                    vy: Math.random() * 0.4 - 0.2,
                    radius: Math.random() * 1.5 + 0.5,
                    opacity: Math.random() * 0.5 + 0.2
                });
            }
        }

        function drawParticles() {
            sparkleCtx.clearRect(0, 0, sparkleCanvas.width, sparkleCanvas.height);
            particles.forEach(p => {
                sparkleCtx.beginPath();
                sparkleCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                sparkleCtx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                sparkleCtx.fill();
            });
        }

        function updateParticles() {
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                if (p.x < 0 || p.x > sparkleCanvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > sparkleCanvas.height) p.vy *= -1;
            });
        }

        function animateSparkles() {
            updateParticles();
            drawParticles();
            animationFrameId = requestAnimationFrame(animateSparkles);
        }
        
        function startSparkleAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            resizeCanvas();
            createParticles();
            animateSparkles();
        }

        function stopSparkleAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }
        
        window.addEventListener('resize', () => {
             if (document.getElementById('chatSection').classList.contains('active')) {
                startSparkleAnimation();
             }
        });


        // Custom Alert Modal Functions
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        function showCustomAlert(title, message) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'block';
        }

        customAlertCloseBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == customAlertModal) {
                customAlertModal.style.display = 'none';
            }
        });

        // --- User Management ---
        async function logoutUser() {
          try {
            await signOut(auth);
            localStorage.clear(); 
            showCustomAlert("Logged Out", "Logged out successfully!");
            window.location.href = "LandingPage.html"; 
          } catch (error) {
            console.error("Logout failed:", error.message);
            showCustomAlert("Error", "Logout failed. Check console for details.");
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          const logoutBtn = document.getElementById("logoutButton");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
              logoutUser();
            });
          }
        });

        // --- Main Application Logic ---
        let userTasks = [];
        let allTasks = [];
        let currentUser = null;
        let currentUserData = {};
        let unsubscribeUserTasks = null;
        let unsubscribeAllTasks = null;
        let unsubscribeUser = null;
        let overdueCheckInterval;
        let calendar;

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navButtons = document.querySelectorAll('.nav-btn');
        const addTaskForm = document.getElementById('addTaskForm');
        const pendingTasksList = document.getElementById('pendingTasksList');
        const activeTasksList = document.getElementById('activeTasksList');
        const completedTasksList = document.getElementById('completedTasksList');
        const taskSelect = document.getElementById('taskSelect');
        const addCommentBtn = document.getElementById('addCommentBtn');
        const leaveForm = document.getElementById('leaveForm');
        const dataTypeSelect = document.getElementById('dataTypeSelect');
        const allDataHeader = document.getElementById('allDataHeader');
        const allDataBody = document.getElementById('allDataBody');
        const csvDataType = document.getElementById('csvDataType');
        const exportCSVBtn = document.getElementById('exportCSVBtn');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const pendingBadge = document.getElementById('pendingBadge');
        const activeBadge = document.getElementById('activeBadge');
        const totalTasksEl = document.getElementById('totalTasks');
        const completedTasksEl = document.getElementById('completedTasks');
        const pendingTasksEl = document.getElementById('pendingTasks');
        const totalPointsEl = document.getElementById('totalPoints');
        const myTasksListContainerEl = document.getElementById('myTasksListContainer');
        const taskFilterBtns = document.querySelectorAll('.task-filter-btn');
        const noMyTasksMessageEl = document.getElementById('noMyTasksMessage');
        const inboxBtnTrigger = document.getElementById('inboxBtnTrigger');
        const inboxModal = document.getElementById('inboxModal');
        const closeInboxModalBtn = document.getElementById('closeInboxModalBtn');
        const inboxMessagesEl = document.getElementById('inboxMessages');
        const inboxBadgeDisplayEl = document.getElementById('inboxBadgeDisplay');
        const bellSound = document.getElementById('bellSound');
        let rangBellForTasks = new Set();
        
        // Dashboard specific elements
        const taskProgressBar = document.getElementById('taskProgressBar');
        const completedCountEl = document.getElementById('completedCount');
        const totalCountEl = document.getElementById('totalCount');
        const recentTasksListEl = document.getElementById('recentTasksList');
        const refreshProgressBtn = document.getElementById('refreshProgress');
        const viewAllTasksBtn = document.getElementById('viewAllTasks');
        const quickAddTaskBtn = document.getElementById('quickAddTask');
        const quickCompleteTaskBtn = document.getElementById('quickCompleteTask');
        const quickCalendarBtn = document.getElementById('quickCalendar');
        const quickExportBtn = document.getElementById('quickExport');
        const userPerformanceTag = document.getElementById('userPerformanceTag');
        const userAvatar = document.getElementById('userAvatar');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const performanceSparkline = document.getElementById('performanceSparkline');
        const achievementBadges = document.getElementById('achievementBadges');

        // Chat-to-Task Elements
        const chatMessagesEl = document.getElementById('chatMessages');
        const chatInputForm = document.getElementById('chatInputForm');
        const chatInput = document.getElementById('chatInput');
        const messageContextMenu = document.getElementById('messageContextMenu');
        const contextMenuMarkAsTaskBtn = document.getElementById('contextMenuMarkAsTaskBtn');
        const contextMenuReplyBtn = document.getElementById('contextMenuReplyBtn');
        const contextMenuShareBtn = document.getElementById('contextMenuShareBtn');
        const markAsTaskModal = document.getElementById('markAsTaskModal');
        const closeMarkAsTaskModalBtn = document.getElementById('closeMarkAsTaskModalBtn');
        const markAsTaskForm = document.getElementById('markAsTaskForm');
        const markAsTaskTitle = document.getElementById('markAsTaskTitle');
        const markAsTaskAssignTo = document.getElementById('markAsTaskAssignTo');
        const markAsTaskEmail = document.getElementById('markAsTaskEmail');

        // Mark as Task Modal new fields
        const markAsTaskIsSubtask = document.getElementById('markAsTaskIsSubtask');
        const markAsTaskPriority = document.getElementById('markAsTaskPriority');
        const markAsTaskCollaborators = document.getElementById('markAsTaskCollaborators');
        const markAsTaskImageUpload = document.getElementById('markAsTaskImageUpload');
        const markAsTaskComments = document.getElementById('markAsTaskComments');
        const markAsTaskLink = document.getElementById('markAsTaskLink');
        const markAsTaskParentId = document.getElementById('markAsTaskParentId');

        // Timer and Checklist Elements (from the second script block)
        const startTimerBtn = document.getElementById('startTimerBtn');
        const liveTimerDisplay = document.getElementById('liveTimerDisplay');
        const checklistInput = document.getElementById('checklistInput');
        const addChecklistBtn = document.getElementById('addChecklistBtn');
        const checklistItems = document.getElementById('checklistItems');


        // Initialize the application
        function initApp() {
            setupEventListeners();
            initializeCalendar();
            setupDarkModeToggle();
            renderInitialChatMessages();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    await populateAssignToDropdown(); // Populate all assignee dropdowns
                    await populateCollaboratorsDropdown(); // Populate collaborators dropdown
                    setupListeners(user.uid);
                    updateUIForUser();
                } else {
                    // User is signed out
                    cleanupOnLogout();
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            navButtons.forEach(btn => {
                if (btn.dataset.section) { 
                    btn.addEventListener('click', () => showSection(btn.dataset.section));
                }
            });
            
            if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('active'));
            
            // Task management
            addTaskForm.addEventListener('submit', handleAddTask);
            refreshProgressBtn.addEventListener('click', refreshDashboard);
            viewAllTasksBtn.addEventListener('click', () => showSection('myTasksOverviewSection'));
            quickAddTaskBtn.addEventListener('click', () => showSection('taskNameSection'));
            quickCompleteTaskBtn.addEventListener('click', () => showSection('markCompleteSection'));
            quickCalendarBtn.addEventListener('click', () => showSection('calendarSection'));
            quickExportBtn.addEventListener('click', () => showSection('saveCSVSection'));
            
            // Task filters
            taskFilterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    taskFilterBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    renderMyTasks(filter);
                });
            });
            
            // Inbox
            inboxBtnTrigger.addEventListener('click', () => inboxModal.style.display = 'block');
            closeInboxModalBtn.addEventListener('click', () => inboxModal.style.display = 'none');
            
            // Chat-to-Task Event Listeners
            chatInputForm.addEventListener('submit', handleSendMessage);

            // Context Menu Listener
            chatMessagesEl.addEventListener('contextmenu', showMessageContextMenu);
            contextMenuMarkAsTaskBtn.addEventListener('click', handleMarkAsTaskClick);
            contextMenuReplyBtn.addEventListener('click', () => showCustomAlert('Reply', 'Reply functionality coming soon!'));
            contextMenuShareBtn.addEventListener('click', () => showCustomAlert('Share', 'Share functionality coming soon!'));


            // Mark as Task Modal Listeners
            closeMarkAsTaskModalBtn.addEventListener('click', () => markAsTaskModal.style.display = 'none');
            markAsTaskForm.addEventListener('submit', handleCreateTaskFromChat);
            window.addEventListener('click', (event) => {
                if (event.target == markAsTaskModal) {
                    markAsTaskModal.style.display = 'none';
                }
            });

            // Timer and Checklist Event Listeners
            if (startTimerBtn) startTimerBtn.addEventListener('click', startTimer);
            if (addChecklistBtn) addChecklistBtn.addEventListener('click', addChecklistItem);
            if (checklistItems) checklistItems.addEventListener('click', handleChecklistItemClick);
        }

        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    localStorage.setItem("username", currentUserData.username || "User");
                    localStorage.setItem("userRole", currentUserData.role || "Member");
                    localStorage.setItem("userAvatar", currentUserData.photoURL || "https://placehold.co/40x40/6366f1/ffffff?text=U");
                } else {
                    // Set defaults if user document doesn't exist
                    localStorage.setItem("username", "User");
                    localStorage.setItem("userRole", "Member");
                    localStorage.setItem("userAvatar", "https://placehold.co/40x40/6366f1/ffffff?text=U");
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }
        
        // Populate "Assign To" dropdowns with users from Firestore
        async function populateAssignToDropdown() {
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const assignToSelects = [
                    document.getElementById('markAsTaskAssignTo')
                ];

                assignToSelects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">-- Select Assignee --</option>'; // Default option
                        usersSnapshot.forEach((doc) => {
                            const user = doc.data();
                            const option = document.createElement('option');
                            option.value = doc.id; // User UID
                            option.textContent = user.username || 'Unnamed User';
                            // For task creation forms, default to current user if available
                            if (currentUser && doc.id === currentUser.uid) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }
                });
            } catch (error) {
                console.error("Error populating users dropdown: ", error);
                document.getElementById('markAsTaskAssignTo').innerHTML = '<option value="">Could not load users</option>';
            }
        }

        // Populate "Collaborators" dropdown with users from Firestore
        async function populateCollaboratorsDropdown() {
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const collaboratorsSelect = document.getElementById('markAsTaskCollaborators');
                
                if (collaboratorsSelect) {
                    collaboratorsSelect.innerHTML = ''; // Clear existing options
                    
                    // Add 'Self' option
                    const selfOption = document.createElement('option');
                    selfOption.value = currentUser ? currentUser.uid : 'self'; // Use current user's UID or a placeholder
                    selfOption.textContent = 'Self';
                    selfOption.selected = true; // Select 'Self' by default
                    collaboratorsSelect.appendChild(selfOption);

                    usersSnapshot.forEach((doc) => {
                        const user = doc.data();
                        // Only add other users if they are not the current user (to avoid duplication with 'Self')
                        if (currentUser && doc.id !== currentUser.uid) {
                            const option = document.createElement('option');
                            option.value = doc.id; // User UID
                            option.textContent = user.username || 'Unnamed User';
                            collaboratorsSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error("Error populating collaborators dropdown: ", error);
                const collaboratorsSelect = document.getElementById('markAsTaskCollaborators');
                if (collaboratorsSelect) {
                    collaboratorsSelect.innerHTML = '<option value="">Could not load users</option>';
                }
            }
        }
        
        // Setup all Firestore listeners
        function setupListeners(userId) {
            // Clean up old listeners first
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeUserTasks) unsubscribeUserTasks();
            if (unsubscribeAllTasks) unsubscribeAllTasks();

            // 1. User data listener
            unsubscribeUser = onSnapshot(doc(db, 'users', userId), (doc) => {
                if (doc.exists()) {
                    currentUserData = doc.data();
                    updateUIForUser();
                }
            });

            // 2. User-specific tasks listener
            const userTasksQuery = query(collection(db, 'forms'), where('assignedTo', '==', userId));
            unsubscribeUserTasks = onSnapshot(userTasksQuery, (snapshot) => {
                userTasks = [];
                snapshot.forEach(doc => {
                    userTasks.push({ id: doc.id, ...doc.data() });
                });
                updateUserSpecificUI(); // Update UI parts that ONLY show the current user's data
            });

            // 3. All tasks listener (for global views like Calendar and Gantt)
            const allTasksQuery = query(collection(db, 'forms'));
            unsubscribeAllTasks = onSnapshot(allTasksQuery, (snapshot) => {
                const userPromises = [];
                const userCache = new Map();

                snapshot.docs.forEach(doc => {
                    const task = { id: doc.id, ...doc.data() };
                    if (task.assignedTo && !userCache.has(task.assignedTo)) {
                        const userDocRef = getDoc(doc(db, 'users', task.assignedTo)); // Corrected getDoc usage
                        userPromises.push(userDocRef);
                        userCache.set(task.assignedTo, userDocRef);
                    }
                });

                Promise.all(userPromises).then(userDocs => {
                    userDocs.forEach(userDoc => {
                        if (userDoc.exists()) {
                            userCache.set(userDoc.id, userDoc.data());
                        }
                    });

                    allTasks = snapshot.docs.map(doc => {
                        const task = { id: doc.id, ...doc.data() };
                        const userData = userCache.get(task.assignedTo);
                        task.assignedToName = userData ? userData.username : 'Unassigned';
                        return task;
                    });

                    updateGlobalUI();
                });
            });
        }
        
        // This function updates UI parts that ONLY show the current user's data
        function updateUserSpecificUI() {
            updatePendingTasksList();
            updateActiveTasksList();
            updateCompletedTasksList();
            updateDashboardStats();
            renderRecentTasks();
            checkOverdueTasksAndRingBell();

            const myTasksSection = document.getElementById('myTasksOverviewSection');
            if (myTasksSection.classList.contains('active')) {
                 const activeFilterBtn = document.querySelector('.task-filter-btn.active');
                 const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                 renderMyTasks(activeFilter);
            }
        }

        // This function updates UI parts that show data from ALL users
        function updateGlobalUI() {
            if (calendar) loadTasksIntoCalendar();
            // If gantt chart section is active, re-render it
            if (document.getElementById('ganttChartSection').classList.contains('active')) {
                renderGanttChart();
            }
        }

        // Update UI with user-specific data
        function updateUIForUser() {
            const username = localStorage.getItem("username") || "User";
            const role = localStorage.getItem("userRole") || "Member";
            const avatar = localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U";
            
            // Update all username displays
            document.querySelectorAll("#usernameDisplay").forEach(el => {
                el.textContent = username;
            });
            
            document.getElementById("dashboardGreeting").innerHTML = `<i class="fas fa-hand-sparkles mr-3"></i> Welcome, <span id="usernameDisplay">${username}</span>!`;
            userRoleDisplay.textContent = role;
            userAvatar.src = avatar;
            
            // Update performance tag based on user stats
            updatePerformanceTag();
        }

        // Update the performance tag based on task completion rate
        function updatePerformanceTag() {
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const completionRate = total > 0 ? (completed / total) * 100 : 0;
            
            let performanceText = "";
            let performanceClass = "";
            
            if (completionRate >= 80) {
                performanceText = "Top Performer";
                performanceClass = "bg-green-100 text-green-800";
            } else if (completionRate >= 50) {
                performanceText = "Solid Performer";
                performanceClass = "bg-blue-100 text-blue-800";
            } else if (completionRate > 0) {
                performanceText = "Needs Improvement";
                performanceClass = "bg-yellow-100 text-yellow-800";
            } else {
                performanceText = "New User";
                performanceClass = "bg-gray-100 text-gray-800";
            }
            
            userPerformanceTag.textContent = performanceText;
            userPerformanceTag.className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${performanceClass}`;
        }
        
        // Chat-to-Task functions
        function renderInitialChatMessages() {
            const initialMessages = [
                { sender: 'Sarah Chen', text: 'We need to design the homepage by Monday.', time: '10:09 AM', avatar: 'https://placehold.co/40x40/f87171/ffffff?text=SC' },
                { sender: 'You', text: 'Sounds good! Should we include the new branding elements?', time: '10:11 AM', avatar: localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U", sent: true },
                { sender: 'Mike Rodriguez', text: 'Yes, and we also need to optimize the mobile layout for better performance.', time: '10:12 AM', avatar: 'https://placehold.co/40x40/34d399/ffffff?text=MR' }
            ];
            
            chatMessagesEl.innerHTML = '';
            initialMessages.forEach(msg => addMessageToChat(msg));
        }

        function addMessageToChat({ sender, text, time, avatar, sent = false }) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sent ? 'sent' : ''}`;
            
            messageDiv.innerHTML = `
                <img src="${avatar}" alt="avatar" class="avatar">
                <div class="message-content">
                    <div class="message-sender">${sender}</div>
                    <div class="message-bubble">${text}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatMessagesEl.appendChild(messageDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        function handleSendMessage(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (text) {
                const message = {
                    sender: 'You',
                    text: text,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    avatar: localStorage.getItem("userAvatar") || "https://placehold.co/40x40/6366f1/ffffff?text=U",
                    sent: true
                };
                addMessageToChat(message);
                chatInput.value = '';
            }
        }

        function showMessageContextMenu(e) {
            // Find the message bubble element that was clicked on
            const messageBubble = e.target.closest('.message-bubble');
            if (!messageBubble) return;

            e.preventDefault();
            
            // Store the message text in the context menu's dataset
            messageContextMenu.dataset.messageText = messageBubble.textContent;

            messageContextMenu.style.display = 'block';
            messageContextMenu.style.top = `${e.pageY}px`;
            messageContextMenu.style.left = `${e.pageX}px`;
        }

        function handleMarkAsTaskClick() {
            const messageText = messageContextMenu.dataset.messageText;
            if (!messageText) return;

            markAsTaskTitle.value = messageText;
            markAsTaskModal.style.display = 'block';
            messageContextMenu.style.display = 'none';
        }
        
        async function handleCreateTaskFromChat(e) {
            e.preventDefault();

            const title = markAsTaskTitle.value;
            const isSubtask = markAsTaskIsSubtask.checked;
            const priority = markAsTaskPriority.value;
            const assignedTo = markAsTaskAssignTo.value;
            const collaborators = Array.from(markAsTaskCollaborators.selectedOptions).map(option => option.value);
            const startDate = document.getElementById('markAsTaskStartDate').value;
            const dueDate = document.getElementById('markAsTaskDate').value;
            const taskEmail = markAsTaskEmail.value;
            const imageFile = markAsTaskImageUpload.files[0]; // Get the selected image file
            const comments = markAsTaskComments.value;
            const relatedLink = markAsTaskLink.value;
            const parentTaskId = markAsTaskParentId.value.trim();
            const addTo = document.getElementById('markAsTaskAddTo').value;
            const taskPoints = parseInt(document.getElementById('markAsTaskPoints').value) || 0; // Get task points

            if (!currentUser || !title || !startDate || !dueDate || !assignedTo) {
                showCustomAlert("Error", "Please fill out all required fields, including start and due dates.");
                return;
            }

            // Simple validation for dates (dueDate >= today)
            const today = new Date().toISOString().split('T')[0];
            if (dueDate < today || startDate > dueDate) {
                showCustomAlert("Error", "Due date cannot be in the past, and start date cannot be after the due date.");
                return;
            }

            const createdByUsername = localStorage.getItem("username") || "User";

            // Placeholder for image URL (actual upload to Firebase Storage would be needed)
            let imageUrl = '';
            if (imageFile) {
                console.log("Image file selected:", imageFile.name);
                imageUrl = `gs://your-firebase-storage-bucket/${imageFile.name}`; // Placeholder URL
                showCustomAlert("Image Upload", "Image upload functionality requires Firebase Storage setup. Storing filename as placeholder.");
            }

            try {
                const taskData = {
                    title: title,
                    description: 'Created from chat message.',
                    isSubtask: isSubtask,
                    priority: priority,
                    taskType: 'General', // Default type
                    startDate: startDate, // NEW: Saving start date
                    dueDate: `${dueDate}T23:59`,
                    status: 'pending',
                    progress: 0,
                    points: taskPoints, // Use points from modal
                    comments: comments ? [{ text: comments, by: createdByUsername, createdAt: serverTimestamp() }] : [],
                    notes: [],
                    createdBy: createdByUsername,
                    assignedTo: assignedTo,
                    collaborators: collaborators,
                    taskSpecificEmail: taskEmail,
                    imageUrl: imageUrl,
                    relatedLink: relatedLink,
                    parentTaskId: parentTaskId,
                    createdAt: serverTimestamp(),
                    isLocked: false,
                    lockUntil: null
                };

                // If 'Sticky Note' is selected, add the title as the first note.
                if (addTo === 'note') {
                    taskData.notes.push(title);
                }
                // No special handling needed for 'gantt' as it's already a task with dates

                await addDoc(collection(db, "forms"), taskData);

                markAsTaskForm.reset();
                markAsTaskModal.style.display = 'none';
                showCustomAlert("Success", "Task created successfully!");
                
                // Navigate to My Tasks section
                showSection('myTasksOverviewSection');

            } catch (error) {
                console.error("Error creating task from chat: ", error);
                showCustomAlert("Error", "Failed to create task: " + error.message);
            }
        }


        // Handle adding a new task from the main form
        async function handleAddTask(e) {
            e.preventDefault();

            const taskName = document.getElementById('taskName').value;
            const taskDescription = document.getElementById('taskDescription').value;
            const taskPriority = document.getElementById('taskPriority').value;
            const taskType = document.getElementById('taskType').value;
            const taskDate = document.getElementById('taskDate').value;
            const taskTime = document.getElementById('taskTime').value;
            const taskPoints = parseInt(document.getElementById('taskPoints').value) || 0;

            if (!currentUser) {
                showCustomAlert("Error", "You must be logged in to add a task.");
                return;
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const selectedDate = new Date(taskDate);

            if (selectedDate < today) {
                showCustomAlert("Validation Error", "Due Date cannot be in the past.");
                return;
            }

            const assignedToUserId = currentUser.uid;
            const createdByUsername = localStorage.getItem("username") || "User";

            try {
                await addDoc(collection(db, "forms"), {
                    title: taskName,
                    description: taskDescription,
                    priority: taskPriority,
                    taskType: taskType,
                    startDate: new Date().toISOString().split('T')[0], // Set start date to today
                    dueDate: `${taskDate}T${taskTime}`,
                    status: 'pending',
                    progress: 0,
                    points: taskPoints,
                    comments: [],
                    notes: [],
                    createdBy: createdByUsername,
                    assignedTo: assignedToUserId,
                    isSubtask: false,
                    collaborators: [],
                    imageUrl: '',
                    relatedLink: '',
                    parentTaskId: '',
                    createdAt: serverTimestamp(),
                    isLocked: false,
                    lockUntil: null
                });

                addTaskForm.reset();
                showCustomAlert("Success", "Task added successfully!");
                showSection('confirmTaskSection');

            } catch (error) {
                console.error("Error adding task: ", error);
                showCustomAlert("Error", "Failed to add task: " + error.message);
            }
        }

        // Update pending tasks list
        function updatePendingTasksList() {
            pendingTasksList.innerHTML = '';
            const currentPendingTasks = userTasks.filter(task => task.status === 'pending'); 
            pendingBadge.textContent = currentPendingTasks.length;
            pendingBadge.style.display = currentPendingTasks.length > 0 ? 'flex' : 'none';
            
            currentPendingTasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.description || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'low'}">${task.priority || 'Low'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.dueDate ? task.dueDate.split('T')[0] : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="btn-success confirm-task" data-id="${task.id}" ${task.isLocked ? 'disabled' : ''}>
                            <i class="fas fa-check"></i> Confirm
                        </button>
                    </td>
                `;
                pendingTasksList.appendChild(tr);
            });

            document.querySelectorAll('.confirm-task').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { status: 'active' });
                        showCustomAlert("Task Confirmed", "Task status updated to Active!");
                    } catch (error) {
                        console.error("Error confirming task:", error);
                        showCustomAlert("Error", "Failed to confirm task: " + error.message);
                    }
                });
            });
        }

        // Update active tasks list
        function updateActiveTasksList() {
            activeTasksList.innerHTML = '';
            const now = new Date(); // Get current time
            const currentActiveTasks = userTasks.filter(task => task.status === 'active'); 
            activeBadge.textContent = currentActiveTasks.length;
            activeBadge.style.display = currentActiveTasks.length > 0 ? 'flex' : 'none';
            
            currentActiveTasks.forEach(task => {
                const tr = document.createElement('tr');
                const dueDateObj = new Date(task.dueDate);
                const isOverdue = dueDateObj < now; // Check if the due date/time has passed

                let buttonHtml = '';
                let buttonClass = '';
                let completionStatus = '';
                let buttonText = '';

                if (isOverdue) {
                    buttonClass = 'btn-danger';
                    buttonText = '<i class="fas fa-exclamation-triangle"></i> Late Complete';
                    completionStatus = 'late';
                } else {
                    buttonClass = 'btn-success';
                    buttonText = '<i class="fas fa-check-circle"></i> Complete';
                    completionStatus = 'on_time';
                }

                buttonHtml = `
                    <button class="${buttonClass} complete-yes" data-id="${task.id}" data-completion-status="${completionStatus}" ${task.isLocked ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.description || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'low'}">${task.priority || 'Low'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.dueDate ? task.dueDate.split('T')[0] : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${buttonHtml}
                    </td>
                `;
                activeTasksList.appendChild(tr);
            });

            document.querySelectorAll('.complete-yes').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    const completionStatus = btn.dataset.completionStatus; // Get the status from data attribute
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { status: 'completed', completionStatus: completionStatus, completedAt: serverTimestamp() });
                        showCustomAlert("Task Completed", `Task status updated to ${completionStatus === 'late' ? 'Late Complete' : 'Completed'}!`);
                    } catch (error) {
                        console.error("Error completing task:", error);
                        showCustomAlert("Error", "Failed to complete task: " + error.message);
                    }
                });
            });
        }

        // Update completed tasks list for assigning points
        function updateCompletedTasksList() {
            completedTasksList.innerHTML = '';
            const completed = userTasks.filter(task => task.status === 'completed');

            if (completed.length === 0) {
                completedTasksList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No completed tasks yet.</td></tr>`;
                return;
            }

            completed.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${task.completionStatus === 'late' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${task.completionStatus === 'late' ? 'Completed (Late)' : 'Completed'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium">${task.points || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <input type="number" class="w-20 p-1 border rounded mr-2" value="${task.points || 0}" min="0" step="10">
                        <button class="btn-success assign-points" data-id="${task.id}">Assign</button>
                    </td>
                `;
                completedTasksList.appendChild(tr);
            });

            document.querySelectorAll('.assign-points').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const taskId = e.target.dataset.id;
                    const newPoints = parseInt(e.target.previousElementSibling.value);
                    if (!isNaN(newPoints)) {
                        try {
                            await updateDoc(doc(db, 'forms', taskId), { points: newPoints });
                            showCustomAlert("Success", "Points assigned successfully!");
                        } catch (error) {
                            console.error("Error assigning points:", error);
                            showCustomAlert("Error", "Failed to assign points.");
                        }
                    }
                });
            });
        }

        // Update dashboard statistics
        function updateDashboardStats() { 
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const pendingActive = userTasks.filter(t => t.status === 'pending' || t.status === 'active').length; 
            const totalPoints = userTasks.reduce((sum, task) => sum + (task.points || 0), 0);
            
            totalTasksEl.textContent = total;
            completedTasksEl.textContent = completed;
            pendingTasksEl.textContent = pendingActive;
            totalPointsEl.textContent = totalPoints;
            
            updatePerformanceTag();
            renderPerformanceSparkline();
            renderAchievementBadges(completed, totalPoints);
        }

        // Update task progress bar
        function updateTaskProgress() {
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            taskProgressBar.style.width = `${percentage}%`;
            completedCountEl.textContent = `${completed} completed`;
            totalCountEl.textContent = `${total} total`;
        }

        // Render recent tasks for dashboard
        function renderRecentTasks() {
            recentTasksListEl.innerHTML = '';
            
            if (userTasks.length === 0) {
                recentTasksListEl.innerHTML = `
                    <div class="empty-dashboard-message">
                        <i class="fas fa-tasks"></i>
                        <p>No recent tasks found</p>
                    </div>
                `;
                return;
            }
            
            const recentTasks = [...userTasks]
                .sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate))
                .slice(0, 5);
            
            recentTasks.forEach(task => {
                const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                const formattedDate = dueDate ? dueDate.toLocaleDateString() : 'No due date';
                
                const taskItem = document.createElement('div');
                taskItem.className = 'recent-task-item draggable-task';
                taskItem.draggable = true;
                taskItem.dataset.taskId = task.id;
                
                taskItem.innerHTML = `
                    <div class="recent-task-checkbox">
                        <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                               data-task-id="${task.id}" class="task-checkbox">
                    </div>
                    <div class="recent-task-content">
                        <div class="recent-task-title">${task.title}</div>
                        <div class="recent-task-due">Due: ${formattedDate} • ${task.priority} Priority</div>
                    </div>
                    <div class="recent-task-actions">
                        <button class="widget-action-btn" data-task-id="${task.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                `;
                
                recentTasksListEl.appendChild(taskItem);
                
                const checkbox = taskItem.querySelector('.task-checkbox');
                checkbox.addEventListener('change', async (e) => {
                    const taskId = e.target.dataset.taskId;
                    const isCompleted = e.target.checked;
                    
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { 
                            status: isCompleted ? 'completed' : 'active' 
                        });
                    } catch (error) {
                        console.error("Error updating task status:", error);
                        e.target.checked = !isCompleted; 
                    }
                });
            });
            
            setupDragAndDrop();
        }

        // Setup drag and drop for tasks
        function setupDragAndDrop() {
            const draggableTasks = document.querySelectorAll('.draggable-task');
            const dropzone = document.createElement('div');
            dropzone.className = 'dropzone';
            dropzone.innerHTML = '<p class="dropzone-label">Drop here to mark as complete</p>';
            
            draggableTasks.forEach(task => {
                task.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
                    e.target.classList.add('dragging');
                });
                
                task.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    dropzone.classList.remove('active');
                    if (dropzone.parentNode) {
                        dropzone.parentNode.removeChild(dropzone);
                    }
                });
                
                task.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (!dropzone.parentNode) {
                        recentTasksListEl.appendChild(dropzone);
                    }
                    dropzone.classList.add('active');
                });
                
                task.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
            });
            
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('active');
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('active');
            });
            
            dropzone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropzone.classList.remove('active');
                
                const taskId = e.dataTransfer.getData('text/plain');
                try {
                    await updateDoc(doc(db, 'forms', taskId), { 
                        status: 'completed' 
                    });
                    showCustomAlert("Task Completed", "Task marked as complete via drag and drop!");
                } catch (error) {
                    console.error("Error completing task:", error);
                    showCustomAlert("Error", "Failed to complete task: " + error.message);
                }
                
                if (dropzone.parentNode) {
                    dropzone.parentNode.removeChild(dropzone);
                }
            });
        }

        // Render performance sparkline chart
        function renderPerformanceSparkline() {
            const ctx = document.createElement('canvas');
            performanceSparkline.innerHTML = '';
            performanceSparkline.appendChild(ctx);
            
            const labels = Array.from({ length: 7 }, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (6 - i));
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            });
            
            const completedData = Array.from({ length: 7 }, () => 
                Math.floor(Math.random() * 10) 
            );
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: completedData,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            });
        }

        // Render achievement badges
        function renderAchievementBadges(completedCount, totalPoints) {
            achievementBadges.innerHTML = '';
            
            if (completedCount >= 1) {
                addBadge('First Task', 'fa-star');
            }
            if (completedCount >= 5) {
                addBadge('Task Master', 'fa-trophy');
            }
            if (totalPoints >= 100) {
                addBadge('Centurion', 'fa-award');
            }
            if (userTasks.some(t => t.priority === 'High' && t.status === 'completed')) {
                addBadge('High Priority Hero', 'fa-fire');
            }
            
            function addBadge(text, icon) {
                const badge = document.createElement('span');
                badge.className = 'achievement-badge';
                badge.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
                achievementBadges.appendChild(badge);
            }
        }

        // Initialize FullCalendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [],
                height: 'auto',
                eventClick: function(info) {
                    showCustomAlert(info.event.title, `Due: ${new Date(info.event.start).toLocaleString()}`);
                }
            });
            
            calendar.render();
        }

        // Load tasks into calendar
        function loadTasksIntoCalendar() {
            if (!calendar) return;
            
            const calendarEvents = allTasks.map(task => ({
                id: task.id,
                title: task.title,
                start: task.dueDate,
                allDay: false,
                color: getPriorityColor(task.priority),
                extendedProps: {
                    description: task.description,
                    status: task.status
                }
            }));
            
            calendar.removeAllEvents();
            calendar.addEventSource(calendarEvents);
        }

        // Get color based on task priority
        function getPriorityColor(priority) {
            switch (priority) {
                case 'High': return '#dc3545';
                case 'Medium': return '#ffc107';
                case 'Low': return '#17a2b8';
                default: return '#6c757d';
            }
        }

        // --- GANTT CHART FUNCTIONALITY ---
        function renderGanttChart() {
            const ganttSection = document.getElementById('ganttChartSection');
            // Ensure the container is ready
            ganttSection.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-project-diagram mr-3 text-blue-600"></i> Project Gantt Chart
                </h2>
                <div class="gantt-container bg-white p-6 rounded-lg shadow-lg">
                    <div class="gantt"></div>
                </div>
            `;
            const ganttContainer = ganttSection.querySelector(".gantt");

            if (!allTasks || allTasks.length === 0) {
                ganttContainer.innerHTML = '<p class="text-center text-gray-500">No tasks available to display in the Gantt chart.</p>';
                return;
            }

            const tasksByAssignee = allTasks.reduce((acc, task) => {
                const assignee = task.assignedToName || 'Unassigned';
                if (!acc[assignee]) {
                    acc[assignee] = [];
                }
                acc[assignee].push(task);
                return acc;
            }, {});

            const ganttData = Object.keys(tasksByAssignee).map(assignee => {
                return {
                    name: assignee,
                    desc: `Tasks for ${assignee}`,
                    values: tasksByAssignee[assignee]
                        .filter(task => task.startDate && task.dueDate) // Ensure tasks have dates
                        .map(task => {
                            const fromDate = new Date(task.startDate);
                            const toDate = new Date(task.dueDate);
                            const now = new Date();

                            let customClass = 'ganttBlue'; // Default for Low priority
                            if (task.priority === 'High') customClass = 'ganttRed';
                            if (task.priority === 'Medium') customClass = 'ganttOrange';
                            
                            if (task.status === 'completed') {
                                customClass = 'ganttGreen';
                            } else if (toDate < now) {
                                customClass = 'ganttRed'; // Overdue tasks are red
                            }

                            return {
                                from: `/Date(${fromDate.getTime()})/`,
                                to: `/Date(${toDate.getTime()})/`,
                                label: task.title,
                                customClass: customClass,
                                dataObj: task // Store original task data for click events
                            };
                        })
                };
            }).filter(series => series.values.length > 0); // Only include assignees with valid tasks

            if (ganttData.length > 0) {
                $(ganttContainer).gantt({
                    source: ganttData,
                    navigate: 'scroll',
                    scale: 'weeks',
                    maxScale: 'months',
                    minScale: 'days',
                    itemsPerPage: 20,
                    onItemClick: function(data) {
                        const task = data.dataObj;
                        showCustomAlert(`Task: ${task.title}`, `Status: ${task.status} | Priority: ${task.priority}\nAssigned to: ${task.assignedToName}`);
                    },
                    onAddClick: function(dt, rowId) {
                        showSection('taskNameSection');
                    },
                    onRender: function() {
                        console.log("Gantt chart has been rendered.");
                    }
                });
            } else {
                ganttContainer.innerHTML = '<p class="text-center text-gray-500">No tasks with valid start and end dates to display.</p>';
            }
        }


        // Show a specific section
        function showSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            navButtons.forEach(btn => {
                if (btn.dataset.section) {
                    btn.classList.toggle('active', btn.dataset.section === sectionId);
                }
            });

            // Start or stop sparkle animation based on section
            if (sectionId === 'chatSection') {
                startSparkleAnimation();
            } else {
                stopSparkleAnimation();
            }
            
            if (sectionId === 'calendarSection' && calendar) {
                calendar.render();
            }

            // --- GANTT CHART TRIGGER ---
            if (sectionId === 'ganttChartSection') {
                renderGanttChart();
            }
            
            if (sectionId === 'myTasksOverviewSection') {
                const activeFilterBtn = document.querySelector('.task-filter-btn.active');
                const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                renderMyTasks(activeFilter);
                
                if (!overdueCheckInterval) {
                    overdueCheckInterval = setInterval(checkOverdueTasksAndRingBell, 60000);
                }
            } else {
                if (overdueCheckInterval) {
                    clearInterval(overdueCheckInterval);
                    overdueCheckInterval = null;
                }
            }
            
            if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }

        // Render the main "My Tasks" view
        async function renderMyTasks(filterStatus = 'all') {
            if (!currentUser) {
                myTasksListContainerEl.innerHTML = '<p class="text-center text-gray-500">Please log in to view your tasks.</p>';
                noMyTasksMessageEl.style.display = 'none';
                return;
            }

            const now = new Date();
            let filteredTasks = [];
            
            const sourceTasks = filterStatus === 'shared' ? allTasks.filter(task => task.assignedTo !== currentUser.uid) : userTasks;

            if (filterStatus === 'all' || filterStatus === 'shared') {
                filteredTasks = sourceTasks;
            } else if (filterStatus === 'pending') {
                filteredTasks = sourceTasks.filter(task => task.status === 'pending');
            } else if (filterStatus === 'inprogress') {
                filteredTasks = sourceTasks.filter(task => task.status === 'active');
            } else if (filterStatus === 'completed') {
                filteredTasks = sourceTasks.filter(task => task.status === 'completed');
            } else if (filterStatus === 'overdue') {
                filteredTasks = sourceTasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    return (task.status === 'pending' || task.status === 'active') && dueDate < now;
                });
            }

            myTasksListContainerEl.innerHTML = '';

            if (filteredTasks.length === 0) {
                noMyTasksMessageEl.style.display = 'block';
            } else {
                noMyTasksMessageEl.style.display = 'none';
                filteredTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                filteredTasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    
                    const dueDateObj = new Date(task.dueDate);
                    const isOverdue = (task.status === 'pending' || task.status === 'active') && dueDateObj < now;

                    let formattedDueDate = 'N/A';
                    let formattedDueTime = 'N/A';

                    if (task.dueDate && !isNaN(dueDateObj.getTime())) {
                        formattedDueDate = dueDateObj.toLocaleDateString();
                        formattedDueTime = dueDateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    const lockIcon = task.isLocked ? `<i class="fas fa-lock absolute top-4 right-4 text-red-500 text-xl" title="This task is locked and cannot be modified."></i>` : '';
                    const lockStatusClass = task.isLocked ? 'border-l-4 border-red-500 pl-4' : '';

                    let flagIcon = '';
                    if (task.status === 'completed') {
                        flagIcon = `<i class="fas fa-flag flag-green" title="Task Completed ${task.completionStatus === 'late' ? '(Late)' : 'Successfully'}"></i>`;
                    } else if (isOverdue) {
                        flagIcon = '<i class="fas fa-flag flag-red" title="Overdue - Action Required"></i>';
                    }
                    
                    let completeButtonHTML = '';
                    if (task.status === 'active' && !task.isLocked) {
                        if (isOverdue) {
                            completeButtonHTML = `<button class="btn-danger complete-task-my-tasks flex-1" data-id="${task.id}" data-late="true"><i class="fas fa-exclamation-triangle mr-2"></i> Late Complete</button>`;
                        } else {
                            completeButtonHTML = `<button class="btn-success complete-task-my-tasks flex-1" data-id="${task.id}" data-late="false"><i class="fas fa-check-circle mr-2"></i> Complete</button>`;
                        }
                    }
                    
                    let statusTagHTML = '';
                    if (isOverdue && task.status !== 'completed') {
                        statusTagHTML = '<span class="status-tag status-overdue">Overdue</span>';
                    } else {
                        switch (task.status) {
                            case 'completed':
                                statusTagHTML = '<span class="status-tag status-completed">Completed</span>';
                                break;
                            case 'pending':
                                statusTagHTML = '<span class="status-tag status-pending">Pending</span>';
                                break;
                            case 'active':
                                statusTagHTML = '<span class="status-tag status-active">Active</span>';
                                break;
                            default:
                                statusTagHTML = `<span class="font-medium text-gray-600">${task.status}</span>`; // Fallback
                        }
                    }
                    
                    const notesHtml = task.notes && task.notes.length > 0
                        ? `<ul>${task.notes.map((note, index) => `
                            <li class="flex justify-between items-center bg-yellow-50 p-2 rounded-md mb-1">
                                <span>${note}</span>
                                <button class="delete-note-btn" data-task-id="${task.id}" data-note-index="${index}" title="Delete note">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </li>`).join('')}</ul>`
                        : `<p class="text-sm text-gray-500">No notes for this task yet.</p>`;

                    const commentsHtml = task.comments && task.comments.length > 0
                        ? `<div>
                                <h6 class="font-semibold text-gray-700 mb-1 flex items-center"><i class="fas fa-comment-dots mr-2 text-indigo-500"></i>Comments:</h6>
                                <ul>${task.comments.map(comment => `
                                    <li class="text-xs text-gray-600 bg-gray-50 p-2 rounded-md mb-1">
                                        <strong>${comment.by || 'Unknown'}:</strong> ${comment.text} 
                                        <span class="text-gray-400 ml-2">${comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleString() : ''}</span>
                                    </li>`).join('')}</ul>
                            </div>`
                        : `<p class="text-sm text-gray-500">No comments for this task yet.</p>`;

                    const collaboratorsHtml = task.collaborators && task.collaborators.length > 0
                        ? `<p class="flex items-center"><i class="fas fa-users mr-2 text-indigo-500"></i> Collaborators: <span class="font-medium text-gray-700">${task.collaborators.map(id => {
                            // Find username from allTasks or a separate user list if available
                            const user = allTasks.find(t => t.assignedTo === id); // This is a hack, should use a dedicated user list
                            return user ? user.assignedToName : 'Unknown';
                        }).join(', ')}</span></p>`
                        : '';

                    const subtaskHtml = task.isSubtask ? `<p class="flex items-center"><i class="fas fa-code-branch mr-2 text-indigo-500"></i> Subtask: <span class="font-medium text-gray-700">Yes</span></p>` : '';
                    const parentTaskHtml = task.parentTaskId ? `<p class="flex items-center"><i class="fas fa-link mr-2 text-indigo-500"></i> Parent Task ID: <span class="font-medium text-gray-700">${task.parentTaskId}</span></p>` : '';
                    const imageUrlHtml = task.imageUrl ? `<p class="flex items-center"><i class="fas fa-image mr-2 text-indigo-500"></i> Image: <a href="${task.imageUrl}" target="_blank" class="text-blue-500 hover:underline">View Image</a></p>` : '';
                    const relatedLinkHtml = task.relatedLink ? `<p class="flex items-center"><i class="fas fa-external-link-alt mr-2 text-indigo-500"></i> Link: <a href="${task.relatedLink}" target="_blank" class="text-blue-500 hover:underline">Open Link</a></p>` : '';

                    const emailHtml = task.taskSpecificEmail 
                        ? `<p class="flex items-center"><i class="fas fa-envelope mr-2 text-indigo-500"></i> Task Email: <span class="font-medium text-gray-700">${task.taskSpecificEmail}</span></p>`
                        : '';
                     taskCard.innerHTML = `
                      <div class="task-header flex justify-between items-center cursor-pointer" onclick="toggleTaskDetails(this)">
                        <h3 class="font-semibold text-xl text-gray-800">${task.title}</h3>
                        <input type="checkbox" class="h-5 w-5 accent-green-500 rounded-full" ${task.status === 'completed' ? 'checked' : ''}>
                      </div>
                    
                      <div class="task-details mt-2 pl-2 text-sm text-gray-700 hidden">
                        <div class="flex justify-between items-start mb-3 ${lockStatusClass}">
                            <div class="flex items-center">
                                <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'low'}">${task.priority || 'Low'}</span>
                                ${flagIcon}
                            </div>
                        </div>
                        ${lockIcon}
                        <p class="text-sm text-gray-600 mb-4">${task.description || 'No description provided.'}</p>
                        <div class="text-sm text-gray-500 space-y-1 mb-4">
                            <p class="flex items-center"><i class="fas fa-calendar-alt mr-2 text-indigo-500"></i> Due Date: <span class="font-medium text-gray-700">${formattedDueDate}</span></p>
                            <p class="flex items-center"><i class="fas fa-clock mr-2 text-indigo-500"></i> Due Time: <span class="font-medium text-gray-700">${formattedDueTime}</span></p>
                            <p class="flex items-center"><i class="fas fa-info-circle mr-2 text-indigo-500"></i> Status: ${statusTagHTML}</p>
                            <p class="flex items-center"><i class="fas fa-percentage mr-2 text-indigo-500"></i> Progress: <span class="font-medium text-gray-700">${task.progress || 0}%</span></p>
                            ${emailHtml}
                            <p class="flex items-center"><i class="fas fa-user-edit mr-2 text-indigo-500"></i> Created By: <span class="font-medium text-gray-700">${task.createdBy || 'N/A'}</span></p>
                            <p class="flex items-center"><i class="fas fa-code-branch mr-2 text-indigo-500"></i> Type: <span class="font-medium text-gray-700">${task.taskType || 'General'}</span></p>
                            <p class="flex items-center"><i class="fas fa-star mr-2 text-indigo-500"></i> Points: <span class="font-medium text-gray-700">${task.points || 0}</span></p>
                            ${subtaskHtml}
                            ${parentTaskHtml}
                            ${collaboratorsHtml}
                            ${imageUrlHtml}
                            ${relatedLinkHtml}
                    
                            <div class="gantt-popup-notes">
                                <h6><i class="fas fa-sticky-note mr-2"></i>Notes:</h6>
                                ${notesHtml}
                                <div class="gantt-popup-add-note mt-2">
                                    <input type="text" placeholder="Add a new note..." id="myTasksNewNoteInput-${task.id}" class="flex-grow p-2 border rounded-md">
                                    <button data-task-id="${task.id}" id="addMyTasksNoteBtn-${task.id}" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Add</button>
                                </div>
                            </div>
                            ${commentsHtml}
                        </div>
                        <div class="task-actions flex flex-wrap gap-2 mt-4">
                            ${task.status === 'pending' && !task.isLocked ? `<button class="btn-success confirm-task-my-tasks flex-1" data-id="${task.id}"><i class="fas fa-check mr-2"></i> Confirm</button>` : ''}
                            ${completeButtonHTML}
                            ${task.status !== 'completed' && !task.isLocked ? `<button class="btn-danger edit-task-my-tasks flex-1" data-id="${task.id}"><i class="fas fa-edit mr-2"></i> Edit</button>` : ''}
                        </div>
                      </div>
                    `;
                    
                    myTasksListContainerEl.appendChild(taskCard);
                    
                    const addMyTasksNoteBtn = document.getElementById(`addMyTasksNoteBtn-${task.id}`);
                    if (addMyTasksNoteBtn) {
                        addMyTasksNoteBtn.addEventListener('click', async () => {
                            const newNoteInput = document.getElementById(`myTasksNewNoteInput-${task.id}`);
                            const newNoteText = newNoteInput.value.trim();
                            if (newNoteText && currentUser) {
                                try {
                                    await updateDoc(doc(db, 'forms', task.id), {
                                        notes: arrayUnion(newNoteText)
                                    });
                                    newNoteInput.value = '';
                                    showCustomAlert("Note Added", "Note successfully added to task!");
                                } catch (error) {
                                    console.error("Error adding note:", error);
                                    showCustomAlert("Error", "Failed to add note: " + error.message);
                                }
                            } else if (!currentUser) {
                                showCustomAlert("Error", "You must be logged in to add notes.");
                            }
                        });
                    }
                });
                setupMyTasksEventListeners();
            }
        }

        // Setup event listeners for the buttons within "My Tasks" view
        function setupMyTasksEventListeners() {
            document.querySelectorAll('.delete-note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const taskId = button.dataset.taskId;
                    const noteIndex = parseInt(button.dataset.noteIndex, 10);
                    // Use custom alert instead of confirm
                    showCustomAlert("Confirm Delete", "Are you sure you want to delete this note?", () => {
                        handleDeleteNote(taskId, noteIndex);
                    }, true); // Pass true to indicate it's a confirmation
                });
            });

            document.querySelectorAll('.confirm-task-my-tasks').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    try {
                        await updateDoc(doc(db, 'forms', taskId), { status: 'active' });
                        showCustomAlert("Task Confirmed", "Task status updated to Active!");
                    } catch (error) {
                        console.error("Error confirming task:", error);
                        showCustomAlert("Error", "Failed to confirm task: " + error.message);
                    }
                });
            });

            document.querySelectorAll('.complete-task-my-tasks').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const taskId = btn.dataset.id;
                    const isLate = btn.dataset.late === 'true';
                    try {
                        const updateData = {
                            status: 'completed',
                            completedAt: serverTimestamp(),
                            completionStatus: isLate ? 'late' : 'on_time'
                        };
                        await updateDoc(doc(db, 'forms', taskId), updateData);
                        if (rangBellForTasks.has(taskId)) {
                            rangBellForTasks.delete(taskId);
                        }
                        showCustomAlert("Task Completed", "Task marked as " + (isLate ? 'Late Complete' : 'Completed') + "!");
                    } catch (error) {
                        console.error("Error completing task:", error);
                        showCustomAlert("Error", "Failed to complete task: " + error.message);
                    }
                });
            });

            document.querySelectorAll('.edit-task-my-tasks').forEach(btn => {
                btn.addEventListener('click', () => {
                    const taskId = btn.dataset.id;
                    showCustomAlert("Edit Task", `Editing task with ID: ${taskId}. (Functionality to be implemented)`);
                });
            });
        }

        // Check for overdue tasks and play bell sound
        function checkOverdueTasksAndRingBell() {
            const now = new Date();
            const overdueTasks = userTasks.filter(task => {
                if (task.status === 'pending' || task.status === 'active') {
                    const dueDate = new Date(task.dueDate);
                    const overdueBy30Min = dueDate.getTime() + (30 * 60 * 1000); // 30 minutes grace period
                    return now.getTime() > overdueBy30Min;
                }
                return false;
            });

            overdueTasks.forEach(task => {
                if (!rangBellForTasks.has(task.id)) {
                    playBellSound();
                    rangBellForTasks.add(task.id);
                    console.log(`Bell rang for overdue task: ${task.title} (ID: ${task.id})`);
                }
            });
        }

        // Play bell sound
        function playBellSound() {
            if (bellSound) {
                bellSound.play().catch(error => {
                    console.warn("Could not play bell sound:", error);
                });
            }
        }

        // Refresh dashboard data
        function refreshDashboard() {
            updateUserSpecificUI();
            updateGlobalUI();
            showCustomAlert("Refreshed", "Dashboard data has been refreshed!");
        }

        // Setup dark mode toggle
        function setupDarkModeToggle() {
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            const currentTheme = localStorage.getItem('theme');
            
            if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
                document.body.classList.add('dark');
                darkModeToggle.checked = true;
            }
            
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.body.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        // Clean up on logout
        function cleanupOnLogout() {
            if (unsubscribeUserTasks) unsubscribeUserTasks();
            if (unsubscribeAllTasks) unsubscribeAllTasks();
            if (unsubscribeUser) unsubscribeUser();
            
            userTasks = [];
            allTasks = [];
            updateUserSpecificUI();
            updateGlobalUI();
            
            if (overdueCheckInterval) {
                clearInterval(overdueCheckInterval);
                overdueCheckInterval = null;
            }
            
            document.getElementById("usernameDisplay").textContent = "User";
            document.getElementById("dashboardGreeting").innerHTML = `<i class="fas fa-hand-sparkles mr-3"></i> Welcome, <span id="usernameDisplay">User</span>!`;
        }

        // Update current date display
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dashboardDate').textContent = now.toLocaleDateString('en-US', options);
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDate();
            initApp();
        });

        // Update date every minute
        setInterval(updateCurrentDate, 60000);

        // Timer and Checklist Functions (from the second script block)
        let timerIntervalInstance; // Renamed to avoid conflict
        let secondsElapsed = 0;

        function isWorkingHour() {
            const now = new Date();
            const hour = now.getHours();

            if (hour === 13) {
                return 'lunch';
            }

            if ((hour >= 9 && hour < 13) || (hour >= 14 && hour < 18)) {
                return true;
            }

            return false;
        }

        function updateTimerDisplay() {
            const hrs = String(Math.floor(secondsElapsed / 3600)).padStart(2, '0');
            const mins = String(Math.floor((secondsElapsed % 3600) / 60)).padStart(2, '0');
            const secs = String(secondsElapsed % 60).padStart(2, '0');
            if (liveTimerDisplay) liveTimerDisplay.textContent = `${hrs}:${mins}:${secs}`;
        }

        function startTimer() {
            if (timerIntervalInstance) {
                clearInterval(timerIntervalInstance);
            }

            const status = isWorkingHour();

            if (status === 'lunch') {
                if (liveTimerDisplay) liveTimerDisplay.textContent = 'Lunch Break 🍱';
                return;
            }

            if (status === false) {
                if (liveTimerDisplay) liveTimerDisplay.textContent = 'Outside working hours 🚫';
                return;
            }

            secondsElapsed = 0; // Reset timer for new start
            updateTimerDisplay();

            timerIntervalInstance = setInterval(() => {
                const checkNow = isWorkingHour();

                if (checkNow === 'lunch') {
                    if (liveTimerDisplay) liveTimerDisplay.textContent = 'Lunch Break 🍱';
                    clearInterval(timerIntervalInstance);
                    return;
                }

                if (checkNow === false) {
                    if (liveTimerDisplay) liveTimerDisplay.textContent = 'Outside working hours 🚫';
                    clearInterval(timerIntervalInstance);
                    return;
                }

                secondsElapsed++;
                updateTimerDisplay();
            }, 1000);
        }

        function addChecklistItem() {
            const value = checklistInput.value.trim();
            if (value) {
                const li = document.createElement("li");
                li.innerHTML = `<input type="checkbox" class="mr-2">${value} <button class="ml-2 text-red-600 text-sm remove-item">×</button>`;
                if (checklistItems) checklistItems.appendChild(li);
                checklistInput.value = '';
            }
        }

        function handleChecklistItemClick(e) {
            if (e.target.classList.contains("remove-item")) {
                e.target.closest("li").remove();
            }
        }
    </script>
    <script>
    // This script block was merged into the main module script above.
    // Keeping it here as a placeholder to indicate it was handled.
    // The functions are now part of the main <script type="module"> block.
    </script>

    <script>
    // This script block was merged into the main module script above.
    // Keeping it here as a placeholder to indicate it was handled.
    // The functions are now part of the main <script type="module"> block.
    </script>
</body>
</html>
